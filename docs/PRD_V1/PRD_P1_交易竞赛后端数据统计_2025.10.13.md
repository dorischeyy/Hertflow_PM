# PRD_P1_交易竞赛后端数据统计_2025.10.13

<div class="Section1">

<style type="text/css">/**/
div.rbtoc1772008013382 {padding: 0px;}
div.rbtoc1772008013382 ul {list-style: none;margin-left: 0px;}
div.rbtoc1772008013382 li {margin-left: 0px;padding-left: 0px;}

/**/</style>

<div class="toc-macro rbtoc1772008013382">

- [1. 竞品调研](#PRD_P1_交易竞赛后端数据统计_2025.10.13-1.竞品调研)
- [2. 竞赛指标与统计口径](#PRD_P1_交易竞赛后端数据统计_2025.10.13-2.竞赛指标与统计口径)
- [3. 数据来源与事件上报](#PRD_P1_交易竞赛后端数据统计_2025.10.13-3.数据来源与事件上报)
- [3. 周期性统计与聚合逻辑](#PRD_P1_交易竞赛后端数据统计_2025.10.13-3.周期性统计与聚合逻辑)
- [4. API接口需求](#PRD_P1_交易竞赛后端数据统计_2025.10.13-4.API接口需求)
- [5. 核心数据表结构](#PRD_P1_交易竞赛后端数据统计_2025.10.13-5.核心数据表结构)
  - [1. trades](#PRD_P1_交易竞赛后端数据统计_2025.10.13-1.trades)
  - [2. Positions](#PRD_P1_交易竞赛后端数据统计_2025.10.13-2.Positions)
  - [3. competition_metrics](#PRD_P1_交易竞赛后端数据统计_2025.10.13-3.competition_metrics)
  - [4. daily_snapshot](#PRD_P1_交易竞赛后端数据统计_2025.10.13-4.daily_snapshot)
  - [5. Leaderboard_cache](#PRD_P1_交易竞赛后端数据统计_2025.10.13-5.Leaderboard_cache)
- [In Scope](#PRD_P1_交易竞赛后端数据统计_2025.10.13-InScope)
- [Out Of Scope](#PRD_P1_交易竞赛后端数据统计_2025.10.13-OutOfScope)
- [附录](#PRD_P1_交易竞赛后端数据统计_2025.10.13-附录)
  - [1. API 响应样例](#PRD_P1_交易竞赛后端数据统计_2025.10.13-1.API响应样例)
  - [2. 排行榜聚合示例](#PRD_P1_交易竞赛后端数据统计_2025.10.13-2.排行榜聚合示例)
  - [3. 竞赛规则config示例](#PRD_P1_交易竞赛后端数据统计_2025.10.13-3.竞赛规则config示例)

</div>

> 1.  **背景：** 交易竞赛数据支持（交易竞赛 → 激励设计 + 排行榜 + 数据核算）
>
> 2.  **竞品参考：**Avantis / GMX / Jupiter / Aester
>
> 3.  **目标 & 范围：**
>
>     1.  所有参赛者的交易行为能**实时被记录、可回溯、可计算**。
>
>     2.  后端可支持**排行榜展示、奖励发放、异常剔除**等业务逻辑。
>
>     3.  后期可快速扩展不同类型的竞赛（ROI / Volume / PnL / Streak）。
>
> 4.  **执行逻辑：**用户在链上开仓 → 事件被监听 → `trades` 写入 → 计算未平仓 → `positions` 更新 → 每10分钟统计 → `competition_metrics` 写入 → 前端排行榜从缓存取最新前**100** → 每天结算存档 → `daily_snapshot` 更新 → 前端 Portfolio / Leaderboard / History 页面读取。
>
> <div class="code panel pdl" style="border-width: 1px;">
>
> <div class="codeContent panelContent pdl">
>
> ``` syntaxhighlighter-pre
> Onchain Events  ─▶  Trade Stream ─▶  trades 表
>                                      │
>                                      ▼
>                                  positions 表  ←─── oracle_snapshot（价格）
>                                      │
>                                      ▼
>                         Aggregation Job (10min)
>                                      │
>                                      ▼
>                               competition_metrics
>                                      │
>                                      ├──▶ leaderboard_cache （实时榜）
>                                      └──▶ daily_snapshot （历史曲线）
> -----------------------------------------------------------------------------
> trades 是最底层事件源（实时写入）。
> positions 实时计算用户当前未平仓仓位与 unrealized_pnl_usd。
> competition_metrics 定期汇总 ROI、PnL、交易量等竞赛指标。
> leaderboard_cache 为前端快速榜单读取层。
> daily_snapshot 用于展示历史曲线、长期统计与复核。
> ```
>
> </div>
>
> </div>
>
> 5.  **上线时间：**
>
> 6.  **需求方：**cen

<div class="confluence-information-macro confluence-information-macro-information">

<span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span>

<div class="confluence-information-macro-body">

TODO：

1.  **补完一套精确定义：**

    1.  **单笔 / Fill 级别**（避免拆单/部分成交导致vol/pnl计算错误）

    2.  **collateral口径**（用于统一ROI计算）

    3.  **时间窗口/时区**（暂定UTC）

    4.  **若干字段扩展**

        1.  Trades：`fee_breakdown`、`fill_id`、`oracle_meta`

        2.  Positions：`collateral_history`**、**

        3.  Competition Metrics：**ranking_score公式** 避免单一指标被刷\
            如，`ranking_score = w1 * normalized(volume) + w2 * normalized(roi) + w3 * normalized(net_pnl) - w4 * normalized(liquidations) + w5 * normalized(fee_contribution)`

2.  **异常/洗量判定细节**与**对账流程**补充。

    1.  对账与复核：脚本 cross-check`daily_snapshot` vs `trades` vs `leaderboard`；确保合计 volume / pnl 对齐；保留 `audit_log` 表：每次排行榜刷新、复算、人工调整均写入。

    2.  防作弊规则

3.  **竞赛规则附录：**让所有计算规则透明、可追溯、可复现 - `leaderboard_cache` 的更新、快照写入、以及“争议处理流程“做成可审计的运行步骤。

</div>

</div>

## 1. 竞品调研

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| 项目 | 核心机制 | 数据亮点 | 借鉴点 |
| **Avantis** | 周榜 + 交易量榜；实时聚合 | 异步结算、榜单分层 | Redis 缓存 + Postgres 异步写入 |
| **GMX** | Vault Mining (Volume × Multiplier) | 以积分制代替收益 | 可引入积分赛机制 |
| **Jupiter** | PnL 比赛 + Gasless Boost | Gasless + Social 排行 | 可拓展每日任务或分享奖励 |
| **Aester** | ROI 榜 + NFT 成就加权 | NFT 成就系统 | 后续阶段拓展 |

</div>

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| 项目 | 竞赛机制 | 数据亮点 | 借鉴建议 |
| **Avantis** | 周度 ROI 榜 + 交易量榜，榜单分层（Pro / Retail） | 后端实时聚合 + 每笔交易异步结算 | 建议采用 Redis 缓存 + Postgres 异步写入 |
| **GMX** | Vault 挖矿积分（Volume × Multiplier） | 直接用 Trading Volume × Multiplier 累计积分 | 可加入“积分赛”机制，便于激励可持续 |
| **Jupiter** | PnL 比赛 + Gasless Boost | 重点在 gasless + social leaderboard | 可扩展“分享奖励”或“每日任务” |
| **Aester** | ROI 榜结合 NFT 成就 | 用户持有 NFT 可加权积分 | 可作为未来阶段性拓展 |

</div>

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| 平台 | 页面 / 功能 | 可见展示 / 精度 | 带来的启发 |
| **Avantis** | Portfolio | 显示用户账户当前持仓、保证金、权益、未实现盈亏、已实现盈亏、手续费等 | 后端必须能实时计算持仓链上 + 用户净资产、未实现 PnL |
| **Avantis** | Leaderboard | 显示用户排名、交易量、收益、净盈亏等 | 排行榜需支持多维度排序（例如 ROI、Volume、PnL） |
| **Aster** | Portfolio / Overview | 显示用户在 Aster 的头寸 /资产总览 | 后端要支持多市场组合资产聚合展示 |
| **Aster** | Trading Leaderboard | 类似排行榜 | 同上 + 历史排名 /涨幅展示 |
| **Jupiter** | Portfolio | 资产组合、持仓展示 | 后端需按每个市场持仓 + 用户资产组合视图 |
| **Jupiter** | Watch / Positions | 实时仓位视图 | 后端要支持实时仓位查询接口 |

</div>

## 2. 竞赛指标与统计口径

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| 指标 | 定义 | 计算逻辑 | 备注 |
| **有效交易量 (Valid Volume)** | 用户在竞赛期间内的成交额总和 | Σ(abs(open_size_usd) + abs(close_size_usd))，过滤测试账号 | 基础指标 |
| **净盈亏 (Net PnL)** | 用户所有平仓的净盈亏 | Σ(realized_pnl_usd) - Σ(fees_usd) | 以USD计价 |
| **ROI (%)** | 投资回报率 | NetPnL / CollateralDeposited × 100 | 需考虑杠杆 |
| **交易笔数 (Trade Count)** | 用户的有效开仓次数 | count(distinct trade_id where open_time∈\[start,end\]) | 剔除部分平仓 |
| **持仓时长 (Avg Duration)** | 平均每笔持仓时长 | avg(close_time - open_time) | 用于行为分析 |
| **连胜次数 (Winning Streak)** | 连续盈利的次数 | max_consecutive(win==true) | 额外奖励指标 |
| **清算次数 (Liquidation Count)** | 被动清算次数 | count(event=="liquidation") | 风控指标 |
| **费用贡献 (Fee Contribution)** | 交易者产生的总手续费 | Σ(fee_open + fee_close + funding_paid + borrow_paid + price impact) | 可用于积分/返利 |

</div>

## 3. 数据来源与事件上报

<div class="table-wrap">

|          |                                    |                       |
|----------|------------------------------------|-----------------------|
| 模块     | 来源                               | 说明                  |
| 交易行为 | Trade 实时表（onchain + internal） | 开仓、平仓、清算事件  |
| 用户资产 | Account Snapshot / Collateral      | 计算 ROI 与保证金基数 |
| 资金变动 | Fee & Funding 表                   | 计算交易费用          |
| 价格数据 | Oracle Snapshot                    | 校验盈亏计算的基准价  |

</div>

## 3. 周期性统计与聚合逻辑

- Cron Job：每10分钟聚合用户级指标

- 维度：`user_address` + `start_time, end_time` + `weightage`

- 指标输出字段：`user_address`，`volume`, `pnl`, `roi`, `trade_count`, `liquidation_count`, `fee_contribution`，`timestamp`

- 展示结果写入表：`competition_metrics`

- 前端展示：**前100名**

- **异常过滤排除条件：**

  - **排除团队钱包与测试账号：**`user_address` ∈ Test/Team wallet 白名单；

  - **平仓价偏离 oracle ±5%；**

  - 未平仓订单或强平未结算；

  - **疑似刷单：**ROI \> 1000% 且交易笔数 \< 3

  - **疑似刷量：**单笔 size \> 100k 且持仓 \< 60s

  - 清算/未结算订单不计入统计。

## 4. API接口需求

<div class="table-wrap">

<table class="confluenceTable" data-table-width="760" data-layout="default" data-local-id="75183bd6-daf1-4c37-8855-fbcb915c8ef1">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p><strong>接口名</strong></p></th>
<th class="confluenceTh"><p><strong>用途</strong></p></th>
<th class="confluenceTh"><p><strong>请求参数</strong></p></th>
<th class="confluenceTh"><p><strong>返回字段</strong></p></th>
<th class="confluenceTh"><p><strong>说明</strong></p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p><code>/competition/rankings</code></p></td>
<td class="confluenceTd"><p>获取排行榜</p></td>
<td class="confluenceTd"><p>period_id, metric</p></td>
<td class="confluenceTd"><p>rank, user, value, change</p></td>
<td class="confluenceTd"><p>排行榜展示</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/competition/user/:address</code></p></td>
<td class="confluenceTd"><p>获取用户个人竞赛数据</p></td>
<td class="confluenceTd"><p>address</p></td>
<td class="confluenceTd"><p>全指标数据</p></td>
<td class="confluenceTd"><p>用户数据</p>
<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="bec46d2563f3dcc1eeb3b4e6adaac8e0bb2eb24f6aaf5cb752897549514906f2" class="confluence-embedded-image image-center" loading="lazy" data-image-src="https://hertzflow.atlassian.net/wiki/download/attachments/15663246/Screenshot%202025-10-10%20at%2018.46.41.png?version=1&amp;modificationDate=1760093240136&amp;cacheVersion=1&amp;api=v2" data-height="493" data-width="1636" data-unresolved-comment-count="0" data-linked-resource-id="15663277" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screenshot 2025-10-10 at 18.46.41.png" data-base-url="https://hertzflow.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="15663246" data-linked-resource-container-version="2" data-media-id="1cdc0b58-4b65-40f8-87c7-5cbb64d536e1" data-media-type="file" width="135" height="40" alt="Screenshot 2025-10-10 at 18.46.41.png" /></span></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/competition/summary</code></p></td>
<td class="confluenceTd"><p>获取竞赛总体数据</p></td>
<td class="confluenceTd"><p>period_id</p></td>
<td class="confluenceTd"><p>participants, total_volume, total_pnl</p></td>
<td class="confluenceTd"><p>活动概览统计</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/competition/export</code></p></td>
<td class="confluenceTd"><p>导出结果</p></td>
<td class="confluenceTd"><p>period_id, format</p></td>
<td class="confluenceTd"><p>CSV 文件流</p></td>
<td class="confluenceTd"><p>发奖复核</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/user/portfolio</code></p></td>
<td class="confluenceTd"><p>返回用户当下资产/持仓/未实现 PnL/已实现 PnL/费用贡献</p></td>
<td class="confluenceTd"><p>address</p></td>
<td class="confluenceTd"><p>资产总览</p></td>
<td class="confluenceTd"><p>Portfolio 页面</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/user/positions</code></p></td>
<td class="confluenceTd"><p>返回用户每个市场的开仓/平仓 / collateral / leverage /未实现 PnL；以及wallet balance中的白名单token及LP</p></td>
<td class="confluenceTd"><p>address</p></td>
<td class="confluenceTd"><p>持仓总览</p></td>
<td class="confluenceTd"><p>用户跨市场持仓聚合 + 总资产组合视图</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/leaderboard/composite</code></p></td>
<td class="confluenceTd"><p>支持综合排序规则参数（例如 <code>sort_by=roi&amp;secondary=volume</code>）</p></td>
<td class="confluenceTd"><p>sort_by, secondary</p></td>
<td class="confluenceTd"><p>排行榜排序数组</p></td>
<td class="confluenceTd"><p>支持后端排序规则参数化（可调整权重）</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/history/user/:address</code></p></td>
<td class="confluenceTd"><p>返回用户每日收益 /累计资产曲线</p></td>
<td class="confluenceTd"><p>address</p></td>
<td class="confluenceTd"><p>ROI/PnL 时序</p></td>
<td class="confluenceTd"><p>用作收益图、交易曲线展示</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>/snapshot/daily</code></p></td>
<td class="confluenceTd"><p>后端写表格，每日用户整体 / 分区 / 平台汇总指标</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"><p>平台级指标</p></td>
<td class="confluenceTd"><p>用作Dashboard</p></td>
</tr>
</tbody>
</table>

</div>

## 5. 核心数据表结构

### 1. trades

> 记录用户所有开平仓事件（实时流）

<div class="table-wrap">

|  |  |  |
|----|----|----|
| 字段 | 类型 | 说明 |
| trade_id | string | 唯一ID |
| user_address | string | 钱包地址 |
| market | string | 市场标识 |
| direction | enum(long/short) | 多/空方向 |
| leverage | float | 杠杆倍数 |
| open_time / close_time | timestamp | 开/平仓时间 |
| open_price / close_price | float | 开/平仓价格 |
| collateral_usd | float | 抵押额 |
| realized_pnl_usd | float | 已实现盈亏（扣费后净值） |
| fees_usd | float | 总费用 |
| status | enum(open/closed/liquidated) | 状态 |
| tx_hash | string | 链上哈希 |

</div>

### 2. Positions

> 记录当前用户持仓状态（可由 trades 聚合）

<div class="table-wrap">

|                    |        |                          |
|--------------------|--------|--------------------------|
| 字段               | 类型   | 说明                     |
| user_address       | string | 用户                     |
| market             | string | 市场                     |
| size_usd           | float  | 当前持仓量               |
| collateral_usd     | float  | 当前抵押                 |
| open_price         | float  | 开仓均价                 |
| current_price      | float  | 最新价格（来自 oracle）  |
| unrealized_pnl_usd | float  | 未实现盈亏（扣费后净值） |

</div>

### 3. competition_metrics

> 周期聚合表（核心排行榜数据源）

<div class="table-wrap">

|                   |           |                                              |
|-------------------|-----------|----------------------------------------------|
| 字段              | 类型      | 说明                                         |
| competition_id    | string    | 竞赛周期ID                                   |
| user_address      | string    | 用户                                         |
| valid_volume      | float     | 有效交易量                                   |
| net_pnl           | float     | 净盈亏                                       |
| roi               | float     | 投资回报率                                   |
| trade_count       | int       | 有效交易次数                                 |
| liquidation_count | int       | 清算次数                                     |
| fee_contribution  | float     | 手续费贡献                                   |
| ranking_score     | float     | 排行权重得分值（按 ROI / Volume 等复合计算） |
| updated_at        | timestamp | 更新时间                                     |

</div>

### 4. daily_snapshot

> 每日用户与平台级别统计快照

<div class="table-wrap">

|                      |        |                  |
|----------------------|--------|------------------|
| 字段                 | 类型   | 说明             |
| snapshot_date        | date   | 日期             |
| user_address         | string | 用户             |
| total_asset_usd      | float  | 用户总资产       |
| realized_pnl_usd_net | float  | 净盈亏（扣费后） |
| cumulative_fee_usd   | float  | 累计手续费       |
| roi                  | float  | 当日 ROI         |
| total_volume_usd     | float  | 当日交易量       |

</div>

### 5. Leaderboard_cache

> 内存层缓存，用于实时榜单

<div class="table-wrap">

|                               |                  |
|-------------------------------|------------------|
| 键                            | 值               |
| leaderboard:{period}:{metric} | 排名数组（JSON） |

</div>

## In Scope

> 本次需求优先级拆分

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| **阶段** | **功能模块** | **优先级** | **预计交付** |
| **Phase 1** | Portfolio / Positions / 基础排行榜 / 定时聚合J | 高 |  |
| **Phase 2** | 多维排序 / 快照表 / 异常过滤 | 中 |  |
| **Phase 3** | 缓存性能优化 / 排名历史 / 前端对接 | 低 |  |

</div>

## Out Of Scope

> 未来可扩展方向，当前产研**暂未**排期

- **分榜机制**（Top Trader / Top LP / 倒霉蛋）

- **动态权重系数**（根据波动率调整各项指标计入积分权重）

- **任务制激励**与**积分系统**（完成10笔交易得积分；连赢10次得积分；referee 交易量\> 5m得积分等）

- 接入 **链上验证 API**（奖励发放时核对 tx_hash）。

## 附录

### 1. API 响应样例

**GET /user/portfolio**

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
{
  "user": "0xAbc123...",
  "total_asset_usd": 12345.67,
  "positions": [
    {
      "market": "ETH/USD",
      "direction": "long",
      "leverage": 50,
      "collateral_usd": 200,
      "size_usd": 10000,
      "open_price": 1800,
      "current_price": 1820,
      "unrealized_pnl_usd": 111.11,
      "realized_pnl_usd_net": 90.00
    }
  ],
  "cumulative_fee_usd": 12.34
}
```

</div>

</div>

**GET /leaderboard/composite?sort_by=roi&secondary=volume**

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
[
  {
    "rank": 1,
    "user": "0xAbc123",
    "roi": 123.45,
    "net_pnl": 4567.89,
    "volume": 100000
  },
  ...
]
```

</div>

</div>

### 2. 排行榜聚合示例

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
SELECT
  user_address,
  SUM(valid_volume) AS total_volume,
  SUM(realized_pnl_usd - fees_usd) AS net_pnl,
  SUM(fees_usd) AS total_fee,
  (SUM(realized_pnl_usd - fees_usd) / MAX(collateral_usd)) * 100 AS roi
FROM competition_metrics
WHERE timestamp BETWEEN :start AND :end
GROUP BY user_address
ORDER BY roi DESC, total_volume DESC
LIMIT 100;
```

</div>

</div>

### 3. 竞赛规则config示例

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
{
  "version": "1.0.0",
  "timezone": "UTC",
  "volume_formula": "Σ(abs(fill_size_usd))",
  "pnl_formula": "Σ(realized_pnl_usd) - Σ(fees_usd)",
  "roi_formula": "net_pnl / collateral_deposited * 100",
  "ranking_formula": "0.3*volume_norm + 0.4*roi_norm + 0.2*pnl_norm + 0.1*fee_norm",
  "anti_abuse_rules": [
    {"name": "wash_trading", "roi_gt": 1000, "trade_lt": 3, "action": "exclude"},
    {"name": "pump_dump", "size_gt": 100000, "duration_lt": 60, "action": "exclude"}
  ]
}
```

</div>

</div>

</div>

# 全局公式&配置汇总

<div class="Section1">

# 交易模块

<div class="table-wrap">

<table class="confluenceTable" data-layout="default" data-local-id="93c90d28-c1df-43d8-a883-28fdd1c8b0ac">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr>
<td class="confluenceTd"><p>公式</p></td>
<td class="confluenceTd"><p>场景</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Collateral 不计入uPnL的初始保证金</strong><br />
=payCoinAmount*PayCoinPrice - open/closeFee - swap fee - borrow fee<br />
注：如果是market order，则按照mark price来计算。如果是limit order，则按照limit price来计算。</p>
<ol>
<li><p><strong>只加保证金（size delta = 0）：</strong>Collateral 新值 = Collateral 旧值 + deposit usd value - swap fee - borrow fee<br />
Size = Position Size + Size Delta 不变</p></li>
<li><p><strong>只移除保证金（size delta = 0）：</strong>Collateral 新值 = Collateral 旧值 - withdraw usd value - swap fee - borrow fee<br />
Size = Position Size - Size Delta 不变</p></li>
<li><p><strong>加保证金 + 增加仓位（size delta &gt; 0）：</strong>Collateral 新值 = Collateral 旧值 + pay coin usd value - open position fee - swap fee - borrow fee<br />
open position fee = size delta <strong>×</strong> open position rate<br />
Size 新值 = Size 旧值 + size delta</p></li>
<li><p><strong>移除保证金 + 减少仓位（Size delta &gt; 0）：</strong>Collateral 新值 = Collateral 旧值 - pay coin usd value - close position fee - swap fee - borrow fee<br />
Close Position Fee = Size delta * Close Position Rate<br />
Size 新值 = Size 旧值 - size delta</p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Position size</strong><br />
<strong></strong> =collateral * leverage</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Swap Fee</strong><br />
=swapFeeRate*(payCoinAmount*payCoinPrice)</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Open/Close Fee</strong><br />
=$positionSize*feeRate<br />
<em>//注意在添加/减少保证金中，OpenFee叫做DepositFee/WithdrawFee，但公式是一样的</em></p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><code>Funding Fee</code><strong>计算逻辑为：</strong><br />
</p>
<ol>
<li><p>从 custodys 取该市场的 <code>cumulative_funding_rate</code> &amp; <code>last_funding_time</code>，以及仓位metadata里取的<code>position_entry_funding_rate</code>；</p></li>
<li><p><strong>小时数差</strong>值<code>Δt</code> = <code>now</code> - <code>last_funding_time</code>；</p></li>
<li><p><strong>funding fee rate差值</strong><code>Δrate</code> =<code> Δt</code> <strong>×</strong> <code>funding fee rate</code></p></li>
<li><p>ProtocolStore取的<strong>常量费率</strong><code>funding_fee_rate</code>：买入（Open Long &amp; Close Short）<strong>则为</strong><code>funding_rate_bps</code> <strong>× 1e-4；卖出</strong>（Open Short；Close Long) <strong>则为</strong><code>stable_funding_rate_bps</code><strong>× 1e-4</strong>;</p></li>
<li><p>当前的累计资金费率<code>latest_cumulative_funding_rate</code> = <code>cumulative_funding_rate</code> + <code>Δrate</code></p></li>
<li><p>资金费 <code>funding_fee</code> = (<code>latest_cumulative_funding_rate</code> -<code>position_entry_funding_rate</code>) <strong>×</strong> <strong>Position Size</strong></p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>基于合约实际实现的清算价格计算公式：</p>
<p>变量定义<br />
</p>
<ul>
<li><p>entry_price：持仓平均价格（美元）</p></li>
<li><p>Collateral：<strong>仓位不计入uPnL的初始保证金</strong> = pay coin usd value - open/close position fee - swap fee</p></li>
<li><p>liquidate_fee：清算费用（美元）</p></li>
<li><p>exit_fee：平仓费用（包含decrease_position_fee + funding_fee）</p></li>
<li><p>size：仓位规模（美元）</p></li>
<li><p>max_leverage：最大杠杆倍数</p></li>
<li><p><strong>只加保证金（size delta = 0）：</strong>Collateral 新值 = Collateral 旧值 + deposit usd value - deposit fee - swap fee - borrow fee<br />
Deposit Fee = position size <strong>×</strong> open position rate<br />
Size = Position Size + Size Delta 不变</p></li>
<li><p><strong>只移除保证金（size delta = 0）：</strong>Collateral 新值 = Collateral 旧值 - withdraw usd value - deposit fee - swap fee - borrow fee<br />
Withdraw Fee = position size <strong>×</strong> close position rate<br />
Size = Position Size - Size Delta 不变</p></li>
<li><p><strong>加保证金 + 增加仓位（size delta &gt; 0）：</strong>Collateral 新值 = Collateral 旧值 + pay coin usd value - open position fee - swap fee - borrow fee<br />
open position fee = size delta <strong>×</strong> open position rate<br />
Size 新值 = Size 旧值 + size delta</p></li>
<li><p><strong>移除保证金 + 减少仓位（Size delta &gt; 0）：</strong>Collateral 新值 = Collateral 旧值 - pay coin usd value - close position fee - swap fee - borrow fee<br />
Close Position Fee = Size delta * Close Position Rate<br />
Size 新值 = Size 旧值 - size delta</p></li>
</ul>
<p>计算步骤</p>
<ol>
<li><p>计算总费用：</p></li>
</ol>
<p><br />
<code>loss = liquidate_fee + exit_fee + size/max_maintenance_leverage</code></p>
<ol start="2">
<li><p>计算差值绝对值：</p></li>
</ol>
<p><br />
</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"><code>diff = |collateral - loss|</code></pre>
</div>
</div>
<ol start="3">
<li><p>计算调整量：</p></li>
</ol>
<p><br />
</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"><code>f = diff * entry_price / size</code></pre>
</div>
</div>
<ol start="4">
<li><p>根据多空方向计算清算价格：</p></li>
</ol>
<p><br />
</p>
<h3 id="id-全局公式&amp;配置汇总-对于多头仓位：">对于多头仓位：</h3>
<ul>
<li><p><code>loss &gt;= collateral</code> <em></em> ：清算价格 = <code>entry_price + f</code></p></li>
<li><p><code>loss &lt; collateral</code> 且 <code>entry_price &gt; f</code>：清算价格 = <code>entry_price - f</code></p></li>
<li><p>否则：清算价格 = 0（边界保护）</p></li>
</ul>
<h3 id="id-全局公式&amp;配置汇总-对于空头仓位：">对于空头仓位：</h3>
<ul>
<li><p>如果 <code>loss &gt;= collateral</code> 且 <code>entry_price &gt; f</code>：清算价格 = <code>entry_price - f</code></p></li>
<li><p>如果 <code>loss &gt;= collateral</code> 且 <code>entry_price &lt;= f</code>：清算价格 = 0（边界保护）</p></li>
<li><p>如果 <code>loss &lt; collateral</code>：清算价格 = <code>entry_price + f</code></p></li>
</ul>
<p>费用组成说明<br />
</p>
<ul>
<li><p><strong>liquidate_fee</strong>: 清算专用费用，按仓位大小 * liquidation_fee_rate 计算</p></li>
<li><p><strong>exit_fee</strong>: 平仓费用组合</p></li>
<li><p>decrease_position_fee: 平仓基础费用，按仓位大小 * decrease_position_fee_rate 计算</p></li>
<li><p>funding_fee: 资金费用，基于持仓时间和资金费率累计计算</p></li>
<li><p>维持保证金率: 1/max_leverage，确保仓位不超过最大杠杆限制</p></li>
</ul></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Net PnL</strong><br />
= Unrealized PnL - Borrow fee - Close fee</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>PnL（平仓部分）</strong><br />
</p>
<ul>
<li><p>收益幅度=平仓部分PnL/平仓部分对应的collateral</p></li>
<li><p>仓位PnL<br />
开多：[(markPrice-entryPrice)/entryPrice]*PositionSize<br />
开空：[(entryPrice-markPrice) /entryPrice]*PositionSize</p></li>
<li><p>平仓部分PnL = （仓位PnL/Size）*平仓的Collateral</p></li>
</ul></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Est.Receive amount</strong><br />
Receive token数量 = （当前仓位collateral - 平仓后仓位collateral + 平仓部分PnL - Close fee - Borrow fee）*Receive token price<br />
（考虑用户滑点，采取滑点最大的价格进行计算）</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>已有仓位，开更多仓位变化后leverage</strong><br />
</p>
<ul>
<li><p>变化后的仓位杠杆 = size/变化后collateral；变化后collateral = 增加的保证金数量*current price + 当前collateral</p></li>
<li><p>例如：Long BTC，当前 collateral = $10， size = $100， 则leverage = 100/10 = 10x</p></li>
<li><p>此时增加1BTC的保证金，Current price = $50。则变化后的collateral = 当前 collateral + （1*$50）= $10 + $50 = $60；则变化后的杠杆 = $100/$60 = 1.6x</p></li>
</ul>
<p>当前仓位杠杆 = size/当前collateral（collateral单位为usd）</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>平仓- collateral变动</strong><br />
平仓后仓位collateral = 平仓后size / 当前leverage</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>增加保证金- collateral变动</strong><br />
</p>
<ul>
<li><p>当前仓位的collateral = 当前仓位目前投入的collateral</p></li>
<li><p>变化后的collateral = （输入框输入的数量*current price - deposit fee） + 当前collateral</p></li>
<li><p>例如：Long BTC，当前 collateral = $10， size = $100</p></li>
<li><p>此时增加1BTC的保证金，Current price = $50。则变化后的collateral = 1*$50 + $10 = $60</p></li>
<li><p>平仓后仓位collateral = 平仓后size / 当前leverage</p></li>
<li><p>deposit fee = position size * open fee rate</p></li>
</ul></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>减少保证金- collateral变动</strong><br />
</p>
<ul>
<li><p>变化后的collateral = 当前仓位的collateral - 提取的collateral - withdraw fee</p></li>
</ul></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>已有仓位，且开仓后的entry price</strong><br />
</p>
<ul>
<li><p>计算公式 ：</p></li>
</ul></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
</tbody>
</table>

</div>

# 流动性模块

<div class="table-wrap">

<table class="confluenceTable" data-layout="default" data-local-id="e2218876-3450-44a7-8fd2-b555900c26a2">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr>
<td class="confluenceTd"><p>公式</p></td>
<td class="confluenceTd"><p>场景</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>HzLP Price<br />
=HzLP pool size/ HzLP circulating amount<br />
=池子总质押/LP总供应量</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>redeemTokens=$LPAmount*current exchangeRate<br />
赎回资产的数量=$LP的数量*当前汇率（其中赎回的金额必须小于池子中的可用余额）</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>Current Weightage<br />
=(coinAmount*coinPrice)/HzLP pool value</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>Utilization<br />
=该token被借出占用的数量/该token在HLP中的总数量</p></td>
<td class="confluenceTd"></td>
</tr>
</tbody>
</table>

</div>

**配置项**\

<div class="table-wrap">

<table class="confluenceTable" data-layout="default" data-local-id="a9443e4f-0158-4410-9e7b-25607e1f7151">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<tbody>
<tr>
<td class="confluenceTd"><p><strong>配置项名称</strong></p></td>
<td class="confluenceTd"><p><strong>说明</strong></p></td>
<td class="confluenceTd"><p><strong>测试配置</strong></p></td>
<td class="confluenceTd"><p><strong>备注</strong><br />
<a href="https://dev.jup.ag/docs/perp-api/pool-account" class="external-link" data-card-appearance="inline" rel="nofollow">https://dev.jup.ag/docs/perp-api/pool-account</a><br />
</p></td>
<td class="confluenceTd"><p><strong>线上配置</strong></p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>流动性池总上限 (Max AUM)</strong></p></td>
<td class="confluenceTd"><p>HzLP 池子可以接受的最大资产总额</p></td>
<td class="confluenceTd"><p>500,000 USD</p></td>
<td class="confluenceTd"><p>可加预警</p></td>
<td class="confluenceTd"><p>50,000,000 USD（JLP 现状 ）</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>目标权重 (Target Weight)</strong></p></td>
<td class="confluenceTd"><p>每种资产在池子中的理想占比</p></td>
<td class="confluenceTd"><p>XBTC-10%<br />
ETH-15%<br />
SUI-35%<br />
USDC-40%</p></td>
<td class="confluenceTd"><p>用于保持资产平衡，决定手续费和池子调节<br />
<em>Jupiter:</em><br />
<em>XBTC-13%</em><br />
<em>ETH-8%</em><br />
<em>SOL-47%</em><br />
<em>USDC-32%</em></p></td>
<td class="confluenceTd"><p>XBTC-20%<br />
ETH-10%<br />
SUI-35%<br />
USDC-35%</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>偏差值 (δ% Token)</strong><br />
<code>仅前端限制</code></p></td>
<td class="confluenceTd"><p>风控参数，计算移除/提取/借贷上限</p></td>
<td class="confluenceTd"><p>20%</p></td>
<td class="confluenceTd"><p><strong>δ%</strong>代表|c% - t%| / t% 可接受偏差上限<br />
<code>待讨论：</code></p>
<p>LP手续费结构</p></td>
<td class="confluenceTd"><p>20%</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Swap Fee</strong></p></td>
<td class="confluenceTd"><p>非稳定币/稳定币交易费用</p></td>
<td class="confluenceTd"><p>Base Rate<br />
Non-stables 0.30%<br />
Stables 0.04%<br />
Tax Rate<br />
Non-stables 0.50%<br />
Stables 0.20%</p></td>
<td class="confluenceTd"><p><code>待讨论：</code></p>
<p><strong>Effective swap fee</strong> is the maximum between input token fee and output token fee.</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>HzLP 添加/移除手续费 (add_remove_fee_bps)</strong></p></td>
<td class="confluenceTd"><p>LP 添加或移除资产手续费</p></td>
<td class="confluenceTd"><p>30 bps (0.30%)</p></td>
<td class="confluenceTd"><p>待讨论：<br />
与目标权重结合动态调整</p></td>
<td class="confluenceTd"><p>30 bps</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>减仓手续费 (decrease_position_bps)</strong></p></td>
<td class="confluenceTd"><p>减仓时手续费</p></td>
<td class="confluenceTd"><p>6 bps</p></td>
<td class="confluenceTd"><p>同 Jupiter 规则</p></td>
<td class="confluenceTd"><p>6 bps</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>加仓手续费 (increase_position_bps)</strong></p></td>
<td class="confluenceTd"><p>加仓时手续费</p></td>
<td class="confluenceTd"><p>6 bps</p></td>
<td class="confluenceTd"><p>同 Jupiter 规则</p></td>
<td class="confluenceTd"><p>6 bps</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>清算手续费 (liquidation_fee_bps)</strong></p></td>
<td class="confluenceTd"><p>强平手续费</p></td>
<td class="confluenceTd"><p>5 bps (0.05%)</p></td>
<td class="confluenceTd"><p>GMX: 20 bps，Hertzflow 默认 5 bps</p></td>
<td class="confluenceTd"><p>20 bps</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>协议手续费 (protocol_fee_bps)</strong></p></td>
<td class="confluenceTd"><p>协议收入分成</p></td>
<td class="confluenceTd"><p>2500 bps (25%)</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"><p>2500 bps</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>单边单市场OI上限</strong><br />
<strong>(MaxGlobalSize)</strong></p></td>
<td class="confluenceTd"><p>风控参数，单市场单边允许最大 OI</p></td>
<td class="confluenceTd"><p>0（不限制）</p></td>
<td class="confluenceTd"><p>最大总OI与可用流动性取最小值，用于开仓校验；可用流动性 <code>(PoolAmount - ReservedAmount) * MarkPrice</code></p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>单边单市场仓位上限</strong><br />
<strong>(Max Position Size)</strong></p></td>
<td class="confluenceTd"><p>风控参数，单人单市场单边最大持仓</p></td>
<td class="confluenceTd"><p>$10,000</p></td>
<td class="confluenceTd"><p>用于开仓校验</p></td>
<td class="confluenceTd"><p>5$2,500,000 (Jup)</p></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Max Maintenance Leverage</strong></p></td>
<td class="confluenceTd"><p>风控参数，维持杠杆</p></td>
<td class="confluenceTd"><p>500</p></td>
<td class="confluenceTd"><p>维持保证金率 <code>MMR = 1 / Max_Maintainance_Leverage</code>；用于计算清算价格及加减仓上限计算清算条件</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>MaxOpenLeverage</strong></p></td>
<td class="confluenceTd"><p>合约容许最大浮动杠杆</p></td>
<td class="confluenceTd"><p>200</p></td>
<td class="confluenceTd"><p>仓位浮动杠杆，不作为强平参数，也不用于IMR；仅为合约限制<br />
开仓前端限制 1.1–100</p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>币种价格精度</p></td>
<td class="confluenceTd"><p>每个币种价格小数点后的精度位数</p></td>
<td class="confluenceTd"><p><a href="https://hertzflow.slack.com/docs/T08G35AED17/F09816QEE2K" class="external-link" rel="nofollow">前端数字展示规范</a></p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>币种数量精度</p></td>
<td class="confluenceTd"><p>每个币种数量小数点后的精度位数</p></td>
<td class="confluenceTd"><p><a href="https://hertzflow.slack.com/docs/T08G35AED17/F09816QEE2K" class="external-link" rel="nofollow">前端数字展示规范</a></p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>币种白名单</p></td>
<td class="confluenceTd"><p>允许交易的币种列表</p></td>
<td class="confluenceTd"><p>BTC<br />
ETH<br />
SUI<br />
USDC</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>市场白名单</p></td>
<td class="confluenceTd"><p>允许挂单/建仓的交易对市场</p></td>
<td class="confluenceTd"><p>BTCUSD<br />
ETHUSD<br />
SUIUSD</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
</tbody>
</table>

</div>

</div>

# 风控参数限制_P1

<div class="Section1">

# 参数配置说明

<div class="table-wrap">

<table class="confluenceTable" data-table-width="760" data-layout="default" data-local-id="c4d31d06-bca4-41cd-83df-2c530f5006f6">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr>
<td class="confluenceTd"><p>参数</p></td>
<td class="confluenceTd"><p>取值（测试网阶段）</p></td>
<td class="confluenceTd"><p>备注</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>δ%_{Market}：该资产可接受权重偏差百分比<br />
<code>合约配置</code></p></td>
<td class="confluenceTd"><p>δ%_{BTC} =<br />
δ%_{ETH} =<br />
δ%_{SUI} =<br />
δ%_{C} =<br />
<strong>20%</strong></p></td>
<td class="confluenceTd"><p>在用户 Buy/Sell HzLP，Market/Limit Open时校验</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>MaxGlobalSize<br />
<code>合约配置 </code>风控参数，单市场单边容许的Max OI</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"><p>最大总OI与可用流动性相比取最小值，用于用户开仓时的校验</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>Available Liquidity<br />
</p></td>
<td class="confluenceTd"><p>开多，平空<br />
Available Liquidity USD Value_{BTC} =<br />
(PoolAmount_{BTC} - Reserved Amount_{BTC}) * Mark Price_{BTC}</p>
<p>开空，平多<br />
Available Liquidity USD Value_{USDC} =<br />
(PoolAmount_{USDC} - ReservedAmount_{USDC}) * Mark Price_{USDC}</p>
<p>ETH，SUI同上</p></td>
<td class="confluenceTd"><p>在用户Market/Limit Open/Close 时校验<br />
⚠️【市场行情栏】前端展示Liquidity Short时取Liquidity Long 与Liquidity Short两者更小值</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>Max Position Size_{Market}_{Side}<br />
「合约不配置 前端写死」</p>
<p><code>合约先不配置 默许limit order导致的实际position size超出$10k情况</code><br />
</p></td>
<td class="confluenceTd"><p>Max Position Size_{BTC}_{Open Long} =<br />
Max Position Size_{BTC}_{Open Short} =<br />
Max Position Size_{ETH}_{Open Long} =<br />
Max Position Size_{ETH}_{Open Short} =<br />
Max Position Size_{SUI}_{Open Long} =<br />
Max Position Size_{SUI}_{Open Short} =<br />
<strong>$10,000</strong></p></td>
<td class="confluenceTd"><p>在用户Market/Limit Open时校验<br />
</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>MMR<br />
合约配置字段：max_maintaince_leverage，在config.move里面有配置<br />
MMR = 1 / Max_Maintainance_Leverage</p></td>
<td class="confluenceTd"><p>0.2%</p></td>
<td class="confluenceTd"><p>维持保证金率，用于计算Liq Price以及加减仓上限</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>MaxOpenLeverage</p></td>
<td class="confluenceTd"><p>200</p></td>
<td class="confluenceTd"><p>这里是指<strong>仓位</strong>的浮动杠杆<br />
不作为强平相关参数<br />
开仓时 前端1.1 - 100限制不变</p></td>
</tr>
<tr>
<td colspan="3" class="confluenceTd"><p>补充合约改动<br />
//<em>取值参考：</em><br />
</p>
<ol>
<li><p><em>Max Position Size：2.5M （</em><a href="https://dev.jup.ag/docs/perp-api/pool-account#limit" class="external-link" rel="nofollow"><em>Jupiter</em></a><em>），15% Max OI （</em><a href="https://docs.avantisfi.com/trading/limitations" class="external-link" rel="nofollow"><em>Avantis</em></a><em>），Avantis另有一个max，开仓时限制size per block = 2.5m</em></p></li>
<li><p><em>Max OI：90% LP Pool TVL （Avantis）Pool Amount Long * OI Reserve Factor （</em><a href="https://gov.gmx.io/t/new-assets-listing-framework/3660" class="external-link" rel="nofollow"><em>GMX</em></a><em>）</em><br />
<em>* Avantis LP池single asset 稳定币，不完全参考</em></p></li>
<li><p><em>来源：</em><br />
<a href="https://discuss.jup.ag/t/jlp-loan-initial-parameter-recommendations-and-yield-projections/38428" class="external-link" data-card-appearance="inline" rel="nofollow">https://discuss.jup.ag/t/jlp-loan-initial-parameter-recommendations-and-yield-projections/38428</a> <em></em> <a href="https://dev.jup.ag/docs/perp-api/pool-account#limit" class="external-link" data-card-appearance="inline" rel="nofollow">https://dev.jup.ag/docs/perp-api/pool-account#limit</a> <em></em><br />
<a href="https://discuss.jup.ag/t/jlp-loan-initial-parameter-recommendations-and-yield-projections/38428" class="external-link" data-card-appearance="inline" rel="nofollow">https://discuss.jup.ag/t/jlp-loan-initial-parameter-recommendations-and-yield-projections/38428</a> <em></em><br />
<a href="https://gov.gmx.io/t/gmx-v2-x-zero-slippage-max-liquidity-unlimited-open-interest-virtual-order-book/3763?utm_source=chatgpt.com" class="external-link" data-card-appearance="inline" rel="nofollow">https://gov.gmx.io/t/gmx-v2-x-zero-slippage-max-liquidity-unlimited-open-interest-virtual-order-book/3763?utm_source=chatgpt.com</a><br />
<a href="https://gov.gmx.io/t/new-assets-listing-framework/3660" class="external-link" data-card-appearance="inline" rel="nofollow">https://gov.gmx.io/t/new-assets-listing-framework/3660</a></p></li>
</ol></td>
</tr>
</tbody>
</table>

</div>

# 需求

<div class="table-wrap">

<table class="confluenceTable" data-table-width="760" data-layout="default" data-local-id="068f4040-eadc-4243-b0d6-11d7d7041357">
<tbody>
<tr>
<td class="confluenceTd"><p><strong>Action</strong></p></td>
<td class="confluenceTd"><p><strong>Side</strong></p></td>
<td class="confluenceTd"><p><strong>市价&amp;限价单通用校验参数计算及定义</strong></p></td>
<td class="confluenceTd"><p><strong>备注</strong></p></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td rowspan="2" class="confluenceTd"><p><strong>Open / Increase</strong><br />
Size Delta ≠ 0<br />
</p>
<blockquote>
<p><strong>交易行为：</strong>由OI、流动性、仓位、浮动杠杆上限限制<br />
<strong>开仓涉及的划转借贷：</strong>受借贷上限，以及HzLP池可接受权重偏差 <strong>δ%</strong> 限制</p>
</blockquote></td>
<td class="confluenceTd"><p>Long</p></td>
<td class="confluenceTd"><ol>
<li><p><code>Max Position Size_{Market}_{Long}</code> = $10,000</p></li>
</ol>
<blockquote>
<p>单用户单市场单边总持仓上限，前端测试网阶段写死</p>
</blockquote>
<ol>
<li><p><code>Current Position Size_{Market}_{Side}</code></p></li>
</ol>
<blockquote>
<p>单用户单市场单边当前总持仓</p>
</blockquote>
<ol>
<li><p><code>Max OI_{Market}_{Long}</code> = Pool Amount_{Market} × Borrow Limit Ratio_{Market}</p></li>
</ol>
<blockquote>
<p>所有用户单市场单边总持仓上限，⚠️ <strong>合约校验时不考虑Borrow Limit Ratio这部分的buffer</strong><br />
</p>
</blockquote>
<ol>
<li><p><code>Reserved Amount_{Market}</code></p></li>
</ol>
<blockquote>
<p>所有用户单市场单边当前总持仓（相当于市场详情栏里的Current OI）</p>
</blockquote>
<ol>
<li><p><code>Available Liquidity_{Market}_{Long} </code>= Max OI_{Market}_{Long} - Current OI_{Market}_{Long}</p></li>
</ol>
<blockquote>
<p>单市场单方向剩余可用流动性<br />
⚠️：前端展示上, Available Liquidity Short 展示的是Min{OI Long, Available Liquidity_{USDC}} 28 August</p>
</blockquote>
<ol>
<li><p><code>Borrow Limit Ratio_{Market}</code></p></li>
</ol>
<blockquote>
<p>某一资产在池子里，最多允许有多少比例可以被交易者借出</p>
</blockquote>
<ol>
<li><p><code>Borrow Size_{PayCoin} </code>= Size delta × (1-1/Leverage)</p></li>
</ol>
<blockquote>
<p>选择的借贷资产的size，注意与market区分概念。比如ETH/USD市场用SUI开多，则Paycoin是SUI</p>
</blockquote>
<ol>
<li><p><code>TVL</code> = PoolSize_{BTC} + PoolSize_{ETH} + PoolSize_{USDC} + PoolSize{SUI}</p></li>
</ol>
<blockquote>
<p>HzLP池总的锁仓量</p>
</blockquote>
<ol>
<li><p><code>c%_{Market}</code> = Current Pool Size_{Market} / TVL× 100%</p></li>
</ol>
<blockquote>
<p>该资产在当前HzLP池子内所占权重</p>
</blockquote>
<ol>
<li><p><code>t%_{Market} </code>合约配置参数，目标权重</p></li>
<li><p><code>δ%_{Market}</code> <strong>常量</strong>，可容许权重偏差比值，相当于变量｜c%_{Market} - t%_{Market}｜/ t%_{Market}的一个上限</p></li>
</ol>
<blockquote>
<p>合约配置参数，永远为正数，可容许权重偏差值</p>
</blockquote>
<p><strong>【前端限制】</strong><br />
</p>
<ul>
<li><p><strong>交易行为相关上限1：开仓后流动性充足且未到达单用户单边单市场最大持仓量</strong><br />
<strong>ΔSize &lt; Max Open Size [OI Limit]</strong> = Max「0, Min{<code>Available Liquidity</code>, <code>Max Position Size </code>- <code>Current Position Size</code>}」</p></li>
</ul>
<blockquote>
<p>参数说明：<br />
<code>Available Liquidity_{Market}</code> = Min {GlobalLongSize_{Market}, Price_{Market} * (PoolAmount_{Market} - Reserved Amount_{Market})}<br />
<code>Max Position Size</code> = $ 10,000<br />
<code>Currrent Position Size</code>: 当前市场当前方向的持仓size</p>
</blockquote>
<ul>
<li><p><strong>交易时的借贷行为相关上限：借贷后不能时HzLP池当前权重偏离目标权重超过</strong><code>δ%</code><strong>比值</strong><br />
<strong>Borrow Size &lt; Max Borrow Size 最大借贷Paycoin美元价值</strong> = <code>TVL</code> × (<code>c%</code> + (<code>δ%</code> - 1 ) * <code>t%</code>) / (1 + (<code>δ%</code> - 1)* <code>t%</code>)</p></li>
</ul>
<blockquote>
<p>参数定义：<br />
Borrow Size_{PayCoin} = ΔSize * (Leverage - 1)<br />
<code>c%</code> ；<code>t%</code>； <code>δ%</code> 取借贷时使用的<strong>PayCoin</strong>的token在HzLP池子中对应权重相关参数<br />
<code>TVL</code> HzLP池总锁仓 = <code>PoolAmount_{BTC}</code> + <code>PoolAmount_{ETH}</code> + <code>PoolAmount_{USDC}</code> +<code> PoolAmount{SUI}</code></p>
</blockquote>
<p><strong>【前端校验】</strong><br />
</p>
<ol>
<li><p><strong>若 ΔSize &gt;</strong> Max「0, Min{<code>GlobalLongSize_{Market}</code>, <code>Price_{Market}</code> * (<code>PoolAmount_{Market}</code> - <code>Reserved Amount_{Market}</code>)}, <code>Max Position Size </code>- <code>Current Position Size</code>,}」<br />
则按钮disable，提示文案：<strong>Max Collateral:</strong><code> Max Collateral Input</code></p></li>
</ol>
<blockquote>
<p>计算：<br />
<code>Max Collateral Input</code> = <code>ΔSize</code> * (1/Leverage + open position fee rate + borrow fee rate) （先算下面<strong>ΔSize</strong> 后代入得出）<br />
<code>ΔSize</code> <strong>=</strong>Max「0, Min{Available Liquidity, Max Position Size - Current Position Size}」</p>
</blockquote>
<ol>
<li><p>若 ΔSize &gt; Max Borrow Size / (Leverage - 1)<br />
则按钮disable，提示文案：<strong>Max Borrow Size:</strong> <code>Max Borrow Size_{PayCoin}</code></p></li>
</ol>
<blockquote>
<p>计算：<br />
<code>Max Borrow Size_{PayCoin} </code>= TVL × (c%_{Paycoin} + (δ%_{Paycoin} - 1 ) * t%_{Paycoin}) / (1 + (δ%_{Paycoin} - 1) * t%_{Paycoin})</p>
</blockquote>
<p><strong>【合约校验】以下部分高亮为合约新增配置项</strong><br />
</p>
<ol>
<li><p>Size Delta &gt; Mark Price_{USDC} * (PoolAmount_{Market} - ReservedAmount_{Market}) → <strong>Revert</strong></p></li>
<li><p>Size Delta × (1-1/L) &gt; TVL × (c% + (<code>δ%</code> - 1) * t%) / (1 + (<code>δ%</code> - 1) * t%) → <strong>Revert</strong></p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>Max Position Size_{Market}_{Side}<br />
【合约不配置】<br />
【仅前端限制】</p></li>
<li><p>Available Liquidity_{Market}_{Side} = Pool Size_{Market}_{Side} * Borrow Limit Ratio - Current OI_{Market}_{Side}<br />
【合约校验】<strong>⚠️</strong> 合约校验时不考虑Borrow Limit Ratio的buffer<br />
【前端限制】</p></li>
<li><p>δ%_{Market}<br />
【合约配置 &amp; 校验】<br />
【前端限制】⚠️ 前端先写死20%，等合约修改完后再同步修改</p></li>
<li><p>Borrow Limit Ratio_{Market}<br />
【合约配置 &amp; 校验】<br />
【前端校验】⚠️ 前端先写死USDC = 50%, 非稳定币 = 90%，等合约修改完后再同步修改</p></li>
<li><p>⚠️Liquidity Short 前端页面展示修改 - 增加borrow limit rate计算：Liquidity Short_{Market} = Min [Liquidity Long_{Market}; PoolAmount_{USDC} × Borrow Limit Ratio - ReservedAmount{USDC}]</p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>Short</p></td>
<td class="confluenceTd"><p><strong>开空时，</strong><br />
</p>
<ul>
<li><p><strong>【前端校验】交易校验1中的</strong><code>Available Liquidity USD Value</code>= Min {GlobalLongSize_{USDC}, Price_{USDC} * (PoolAmount_{USDC} - Reserved Amount_{USDC})}</p></li>
<li><p>【合约校验】同理，第一条是 Size Delta &gt; Mark Price_{USDC} * (PoolAmount_{USDC} <strong>-</strong> ReservedAmount_{USDC}) → <strong>Revert</strong><br />
</p></li>
</ul>
<p><strong>其他与开多同</strong></p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td rowspan="2" class="confluenceTd"><p><strong>Close / Decrease</strong><br />
Size Delta ≠ 0<br />
</p>
<blockquote>
<p><strong>交易行为：</strong>由流动性上限、浮动杠杆、MMR限制</p>
<p><strong>结算时涉及的划转：无限制</strong><br />
虽影响池子权重，但不依据 <strong>δ%</strong>限制强制约束用户行为</p>
</blockquote></td>
<td class="confluenceTd"><p>Long</p></td>
<td class="confluenceTd"><p><strong>【前端限制】</strong><br />
</p>
<ul>
<li><p><strong>交易行为上限1：用户选择的ReceiveCoin，在HzLP中剩余流动性够结算时划转</strong><br />
<strong>ΔSize &lt;= Mark Price_{ReceiveCoin} * (PoolAmount_{ReceiveCoin} - ReservedAmount_{ReceiveCoin})/ (1/Leverage +uPnL%/Leverage - Close Fee Rate - Borrow Fee Rate)</strong><br />
</p></li>
</ul>
<blockquote>
<p>推导：</p>
<ol start="2">
<li><p>ReceiveCoin结算 ReceiveCoinAmount = ΔSize * (1/Leverage + uPnL%/Leverage - Close Fee Rate) - Borrow Fee - Swap Fee &lt; Max Available Liquidity_{ReceiveCoin} = PoolAmount_{ReceiveCoin} * BorrowLimitRatio_{ReceiveCoin} - ReservedAmount_{ReceiveCoin}</p></li>
</ol>
<p><br />
ΔSize &lt; (PoolAmount_{ReceiveCoin} * BorrowLimitRatio_{ReceiveCoin} - ReservedAmount_{ReceiveCoin} + Borrow Fee + Swap Fee)/ (1/Leverage +uPnL%/Leverafe - Close Fee Rate)</p>
</blockquote>
<p><strong>【前端校验】</strong><br />
</p>
<ol>
<li><p><strong>若 ΔSize &gt;</strong> Max「0,<br />
<code>Mark Price_{ReceiveCoin}</code> * (<code>PoolAmount_{ReceiveCoin}</code> <strong>-</strong> <code>ReservedAmount_{ReceiveCoin}</code><strong>)/ (</strong><code>1/Leverage</code> <strong>+</strong><code>uPnL%/Leverage</code> <strong>-</strong> <code>Close Fee Rate</code> - <code>Borrow Fee Rate</code><strong>)</strong><br />
则按钮disable，提示文案：<strong>Max Close Size:</strong><code> Max Close Size，</code></p></li>
</ol>
<blockquote>
<p>Max Close Size就是上面一串。即最小值&gt;0 则取上面一串三者最小值，最小值&lt;0 则取 0</p>
</blockquote>
<p><strong>【合约校验】以下部分高亮为合约新增配置项</strong><br />
</p>
<ol>
<li><p>Size Delta &gt; <strong>(</strong><code>PoolAmount_{ReceiveCoin} </code><strong>-</strong> <code>ReservedAmount_{ReceiveCoin}</code> <strong>) *</strong> <code>Mark Price_{ReceiveCoin}</code> <strong>+</strong> <code>Borrow Fee</code> + <code>Swap Fee</code><strong>)/ (</strong><code>1/Leverage</code> <strong>+</strong><code>uPnL%/Leverage</code> <strong>-</strong> <code>Close Fee Rate</code><strong>)</strong> → <strong>Revert</strong></p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>Available Liquidity_{Market}_{Side} = Pool Size_{Market}_{Side} * 90% - Current OI_{Market}_{Side}<br />
【合约校验】<strong>⚠️</strong> 合约校验时不考虑10%的buffer<br />
【前端限制】</p></li>
<li><p>参数上，Close Long = Open Short</p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>Short</p></td>
<td class="confluenceTd"><p><strong>平空时，</strong><br />
</p>
<ul>
<li><p><strong>【前端校验】交易行为上限1中的</strong><br />
<code>uPnL% </code>= (<code>Entry Price</code> - <code>Mark Price</code>) / Entry Price * 100% * Leverage</p></li>
</ul>
<p><strong>其他与平多同</strong></p></td>
<td class="confluenceTd"><ol>
<li><p>Available Liquidity_{Market}_{Side} = Pool Size_{Market}_{Side} * 90% - Current OI_{Market}_{Side}<br />
【合约校验】<strong>⚠️</strong> 合约校验时不考虑10%的buffer<br />
【前端限制】</p></li>
<li><p>参数上，Close Short = Open Long</p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Collateral Deposit/Withdraw</strong><br />
<strong>Size Delta = 0</strong></p></td>
<td class="confluenceTd"><p>N/A</p></td>
<td class="confluenceTd"><p><strong>【前端仅在移除时新增校验】</strong><br />
需要 ΔCollateral &gt; Max Collateral Withdrawal，则按钮disable并提示'Max Collatral [<code>Max Collateral Withdraw</code>l]'<br />
其中，<code>Max Collateral Withdrawal</code> = max {0, <code>Collateral</code> * (1 - <code>Leverage</code>/(<code>Max Maintenance Leverage</code> * (1 + <code>uPnL%</code>/<code>Leverage</code> - <code>fee%_{liq}</code>)))}</p>
<blockquote>
<p><strong>参数定义：</strong><br />
<strong>fee%_{liq} =</strong> close fee rate + borrow fee rate + liquidation fee rate<br />
<strong>uPnL%{Long/Short} =</strong> ± (mark price - entry price) / entry price * 100% * Leverage ; uPnL%{Long} 取正，uPnL%{Short} 取负<br />
<strong>Max Maintenance Leverage</strong> ：取合约 move.config配置</p>
<p><strong>推导：MR 仓位保证金率 = 有效保证金/Size &gt;= MMR = 1/Max Maintenance Leverage 维持保证金率</strong></p>
<ol>
<li><p>Effective Collateral = (Collateral - ΔCollateral) * (1 + uPnL% - fee%_{liq})</p></li>
<li><p>Size = Size - ΔSize = Size (添加/移除保证金时，size delta = 0）</p></li>
<li><p>MR = Effective Collateral / Size = (Collateral - ΔCollateral) * (1 + uPnL% - fee%_{liq}) / size &gt;= 1/Max Maintenance Leverage</p></li>
</ol>
<p>→ ΔCollateral &lt;= Collateral * (1 - Leverage/(<code>Max Maintenance Leverage</code> * (1 + <code>uPnL%</code> - <code>fee%_{liq}</code>)))</p>
<p>:warning:多仓减少保证金 与 空仓减少保证金<strong>uPnL%符号相反</strong></p>
</blockquote></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>Liquidation</strong></p></td>
<td class="confluenceTd"><p>N/A</p></td>
<td class="confluenceTd"><p>计算步骤</p>
<ol>
<li><p>计算总费用：</p></li>
</ol>
<p><br />
<code>loss = liquidate_fee + exit_fee + size/max_maintenance_leverage</code></p>
<ol start="2">
<li><p>计算差值绝对值：</p></li>
</ol>
<p><br />
</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"><code>diff = |collateral - loss|</code></pre>
</div>
</div>
<ol start="3">
<li><p>计算调整量：</p></li>
</ol>
<p><br />
</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"><code>f = diff * entry_price / size</code></pre>
</div>
</div>
<ol start="4">
<li><p>根据多空方向计算清算价格：</p></li>
</ol>
<p><br />
</p>
<h3 id="id-风控参数限制_P1-对于多头仓位：">对于多头仓位：</h3>
<ul>
<li><p><code>loss &gt;= collateral</code> <em></em> ：清算价格 = <code>entry_price + f</code></p></li>
<li><p><code>loss &lt; collateral</code> 且 <code>entry_price &gt; f</code>：清算价格 = <code>entry_price - f</code></p></li>
<li><p>否则：清算价格 = 0（边界保护）</p></li>
</ul>
<h3 id="id-风控参数限制_P1-对于空头仓位：">对于空头仓位：</h3>
<ul>
<li><p>如果 <code>loss &gt;= collateral</code> 且 <code>entry_price &gt; f</code>：清算价格 = <code>entry_price - f</code></p></li>
<li><p>如果 <code>loss &gt;= collateral</code> 且 <code>entry_price &lt;= f</code>：清算价格 = 0（边界保护）</p></li>
<li><p>如果 <code>loss &lt; collateral</code>：清算价格 = <code>entry_price + f</code></p></li>
</ul>
<p>费用组成说明<br />
</p>
<ul>
<li><p><strong>liquidate_fee</strong>: 清算专用费用，按仓位大小 * liquidation_fee_rate 计算</p></li>
<li><p><strong>exit_fee</strong>: 平仓费用组合</p></li>
<li><p>decrease_position_fee: 平仓基础费用，按仓位大小 * decrease_position_fee_rate 计算</p></li>
<li><p>funding_fee: 资金费用，基于持仓时间和资金费率累计计算</p></li>
<li><p>维持保证金率: 1/max_maintenance_leverage，确保仓位不超过最大杠杆限制</p></li>
</ul>
<blockquote>
<p><strong>清算价格逻辑：</strong><br />
Liq. Price_{Long} = Entry Price * (1 - 1/Leverage + 1/Max Maintenance Leverage)<br />
Liq. Price_{Short} = Entry Price * (1 + 1/Leverage - 1/Max Maintenance Leverage)</p>
<p><strong>推导：</strong><br />
根据维持保证金率定义，MMR = Effective Collateral/Size = (Collateral + uPnL - Borrow Fee - Close Fee) / Size<br />
= 1/Max_Maintenance_Leverage 时触发清算，其中：<br />
uPnL_{Long} = (Mark Price - Entry Price) * Size / Entry Price<br />
uPnL_{Short} = (Entry Price - Mark Price) * Size / Entry Price</p>
<p>在触发清算时，Mark Price 即为 Liq Price<br />
→<br />
Liq. Price_{Long} = Entry Price * (1 + r_fee - 1/Leverage + 1/Max Maintenance Leverage)<br />
Liq. Price_{Short} = Entry Price * (1 - r_fee + 1/Leverage - 1/Max Maintenance Leverage)<br />
其中，r_fee = close fee rate + accumulated borrow fee rate</p>
</blockquote></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p><strong>LP Add / Remove</strong><br />
</p>
<blockquote>
<p>受 <strong>δ% 权重偏差约束</strong></p>
</blockquote></td>
<td class="confluenceTd"><p>N/A</p></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"><ol>
<li><p>TVL：HzLP池子总流动性 = ΣPoolAmount_{Token}</p></li>
<li><p>c%_{token}：添加/移除流动性时，为Pay/ReceiveCoin在LP池的当前权重</p></li>
<li><p>t%_{token}：添加/移除流动性时，为Pay/ReceiveCoin在LP池的目标权重</p></li>
<li><p>δ%_{token}：常量，是合约配置项，代表 | (c% - t%) / t% | 这个变量的最大阈值，即可接受权重偏差百分比</p></li>
<li><p>P_{token}：<br />
添加流动性时，为PayCoin的价格<br />
移除流动性时，为<code>HzLP</code>价格</p></li>
<li><p>⚠️Max Deposit/Withdraw_{token} 指token数量（即输入框的input，而非size）</p></li>
</ol></td>
<td class="confluenceTd"></td>
</tr>
<tr>
<td class="confluenceTd"><p>Swap</p>
<blockquote>
<p>受 pay&amp;receive coin 的<strong>δ% 权重偏差，可用流动性，以及price impact约束</strong></p>
</blockquote></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"><p><strong>【前端限制】</strong><br />
</p>
<ul>
<li><p><strong>swap上限1：receive coin流动性充足</strong><br />
<strong>Swap Size &lt; Available Liquidity</strong> = Max「0, Min{<code>Maxin</code>； <code>MaxOut</code>}」</p></li>
</ul>
<p><strong>【前端校验】</strong><br />
</p>
<ol>
<li><p><strong>若 Swap Size &gt; Max「0, Min{</strong><code>Maxin</code><strong>,</strong> <code>MaxOut</code><strong>}」</strong><br />
则按钮disable，提示文案：<code>Insufficient Available Liquidity</code></p></li>
</ol>
<p><strong>【合约校验】</strong><br />
</p>
<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img src="af9bbda357420db2b52001e2f53af32a0fc81e878dc9aa2ede3b52f286e674a6" class="confluence-embedded-image image-center" loading="lazy" data-image-src="https://hertzflow.atlassian.net/wiki/download/attachments/2457947/Screenshot%202025-09-27%20at%2015.45.43.png?version=1&amp;modificationDate=1758959162762&amp;cacheVersion=1&amp;api=v2" data-height="78" data-width="718" data-unresolved-comment-count="0" data-linked-resource-id="8683596" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screenshot 2025-09-27 at 15.45.43.png" data-base-url="https://hertzflow.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="2457947" data-linked-resource-container-version="2" data-media-id="701c6b67-8d72-4ffd-a195-b30c9ca6e0d9" data-media-type="file" width="468" height="50" alt="Screenshot 2025-09-27 at 15.45.43.png" /></span>
<ol>
<li><p>Swap Size &gt; <strong>Max「0, Min{</strong><code>Maxin</code><strong>,</strong> <code>MaxOut</code><strong>}」</strong> → <strong>Revert</strong></p></li>
<li><p>合约收到用户支付的Paycoin Size记作X，支付给用户的ReceiveCoin Size 记作Y，注意引入price impact后X与Y非线性关系，相互影响。此时验证：<br />
若 X &gt; Min { <strong></strong><br />
<strong>t%_{PayCoin} × (1+δ%_{PayCoin}) × (TVL - Y) - c%_{PayCoin} ×TVL;</strong><br />
<strong>[TVL × ((1 + δ%_{PayCoin}) × t%_{ReceiveCoin}) - c%_{PayCoin}) - (1 + δ%_{PayCoin}) × t%_{PayCoin}) × Y] / (1 + (1 - (1 + δ%_{PayCoin}) × t%_{PayCoin}) ;</strong><br />
<strong>[TVL × (c%_{ReceiveCoin} - (1 - δ%_{ReceiveCoin}) × t%_{ReceiveCoin}) + ((1 - δ%_{ReceiveCoin}) × t%_{ReceiveCoin} - 1) × Y] / (1 - δ%_{ReceiveCoin}) × t%_{ReceiveCoin}</strong><br />
<strong>}</strong><br />
<strong>则Revert</strong></p></li>
<li><p>是否根据与oracle price相比的price difference做限制？</p></li>
</ol></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
</tbody>
</table>

</div>

</div>

# ç”¨æˆ·äº¤æ˜“å’ŒæŒä»“è¿½è¸ªç³»ç»Ÿè®¾è®¡æ–‡æ¡£

<div class="Section1">

# ä¸€ã€æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä½

å»ºç«‹**é€šç”¨çš„ç”¨æˆ·äº¤æ˜“å’ŒæŒä»“è¿½è¸ªç³»ç»Ÿ**ï¼Œä½œä¸ºæ•´ä¸ªæ•°æ®ç»Ÿè®¡å¹³å°çš„åŸºç¡€æ•°æ®å±‚ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š

- è®°å½•æ‰€æœ‰ç”¨æˆ·çš„äº¤æ˜“è¡Œä¸ºï¼ˆå¼€ä»“ã€åŠ ä»“ã€å‡ä»“ã€å¹³ä»“ã€æ¸…ç®—ï¼‰

- è¿½è¸ªæ‰€æœ‰ç”¨æˆ·çš„å®æ—¶æŒä»“çŠ¶æ€

- æä¾›é€šç”¨çš„äº¤æ˜“å’ŒæŒä»“æŸ¥è¯¢æ¥å£

**è®¾è®¡åŸåˆ™**ï¼š

- âœ… æ•°æ®é€šç”¨æ€§ï¼šä¸ä¸ç‰¹å®šä¸šåŠ¡ç»‘å®š

- âœ… å®Œæ•´æ€§ï¼šè®°å½•æ‰€æœ‰äº¤æ˜“è¡Œä¸ºå’ŒæŒä»“å˜åŒ–

- âœ… å¯è¿½æº¯æ€§ï¼šå®Œæ•´çš„äº¤æ˜“é“¾è·¯è¿½è¸ª

- âœ… å¯æ‰©å±•æ€§ï¼šæ”¯æŒå¤šç§ä¸šåŠ¡åœºæ™¯å¤ç”¨

### 1.2 åº”ç”¨åœºæ™¯

åŸºç¡€æ•°æ®å¯ç”¨äºï¼š

- ğŸ“Š **ç«èµ›åŠŸèƒ½**ï¼šè®¡ç®—ç”¨æˆ·ç«èµ›æŒ‡æ ‡ï¼ˆäº¤æ˜“é‡ã€PnLã€ROIç­‰ï¼‰

- ğŸ“ˆ **æ•°æ®åˆ†æ**ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€äº¤æ˜“æ¨¡å¼è¯†åˆ«

- ğŸ›¡ï¸ **é£æ§ç³»ç»Ÿ**ï¼šå¼‚å¸¸äº¤æ˜“æ£€æµ‹ã€é£é™©é¢„è­¦

- ğŸ“‘ **æŠ¥è¡¨ç”Ÿæˆ**ï¼šäº¤æ˜“ç»Ÿè®¡ã€ç”¨æˆ·ç”»åƒ

- ğŸ **å¥–åŠ±ç³»ç»Ÿ**ï¼šäº¤æ˜“æŒ–çŸ¿ã€è¿”ä½£è®¡ç®—

### 1.3 ç³»ç»Ÿæ¶æ„

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·äº¤æ˜“å’ŒæŒä»“è¿½è¸ªç³»ç»Ÿ                                â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ user_trades_0~127      â”‚  â”‚ user_positions_0~127  â”‚                  â”‚
â”‚  â”‚ (æŒ‰ç”¨æˆ·åœ°å€åˆ†128åˆ†åŒº)   â”‚  â”‚ (æŒ‰ç”¨æˆ·åœ°å€åˆ†128åˆ†åŒº) â”‚                  â”‚
â”‚  â”‚                        â”‚  â”‚                       â”‚                  â”‚
â”‚  â”‚ - å¼€ä»“ (open)          â”‚  â”‚ - position_id         â”‚                  â”‚
â”‚  â”‚ - åŠ ä»“ (increase)      â”‚â—„â”€â”¤ - avg_entry_price     â”‚                  â”‚
â”‚  â”‚ - å‡ä»“ (decrease)      â”‚  â”‚ - position_size       â”‚                  â”‚
â”‚  â”‚ - å¹³ä»“ (close)         â”‚  â”‚ - realized_pnl        â”‚                  â”‚
â”‚  â”‚ - æ¸…ç®— (liquidation)   â”‚  â”‚ - collateral_amount   â”‚                  â”‚
â”‚  â”‚                        â”‚  â”‚                       â”‚                  â”‚
â”‚  â”‚ æŸ¥è¯¢æ–¹å¼ï¼š             â”‚  â”‚ æŸ¥è¯¢æ–¹å¼ï¼š            â”‚                  â”‚
â”‚  â”‚ âœ“ å•ç”¨æˆ·ï¼šæ¸¸æ ‡åˆ†é¡µ     â”‚  â”‚ âœ“ å•ç”¨æˆ·ï¼šç›´æ¥æŸ¥è¯¢    â”‚                  â”‚
â”‚  â”‚ âœ“ å…¨é‡ï¼šç´¢å¼•è¡¨ä¼˜åŒ– â­  â”‚  â”‚ âœ“ æ´»è·ƒæŒä»“ï¼šçŠ¶æ€è¿‡æ»¤  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚            â–²                           â–²                                 â”‚
â”‚            â”‚                           â”‚                                 â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚            â”‚  â”‚ user_trades_timezone (æ—¶é—´ç´¢å¼•è¡¨) â­     â”‚                â”‚
â”‚            â”œâ”€â–ºâ”‚ - è®°å½•æ¯å¤©å„åˆ†åŒºæ˜¯å¦æœ‰æ•°æ®               â”‚                â”‚
â”‚               â”‚ - ç”¨äºä¼˜åŒ–è·¨åˆ†åŒºæ—¶é—´èŒƒå›´æŸ¥è¯¢             â”‚                â”‚
â”‚               â”‚ - å…¨é‡æŸ¥è¯¢æ€§èƒ½æå‡ 4-12 å€               â”‚                â”‚
â”‚               â”‚                                         â”‚                â”‚
â”‚               â”‚ æ ¸å¿ƒå­—æ®µï¼š                               â”‚                â”‚
â”‚               â”‚ - date_key (YYYYMMDD)                   â”‚                â”‚
â”‚               â”‚ - shard_id (0-127)                      â”‚                â”‚
â”‚               â”‚ - table_name (user_trades_X)            â”‚                â”‚
â”‚               â”‚ - record_count (ç»Ÿè®¡)                   â”‚                â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                              â–²                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚  UserTradeService
                               â”‚  (å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç´¢å¼•è¡¨)
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PositionService â”‚                                           â”‚
â”‚                              â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  ParseService (å¤„ç† Sui åŒºå—é“¾äº‹ä»¶)                â”‚                  â”‚
â”‚  â”‚    - VaultIncreasePositionEvent                   â”‚                  â”‚
â”‚  â”‚    - VaultDecreasePositionEvent                   â”‚                  â”‚
â”‚  â”‚    - VaultLiquidatePositionEvent                  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</div>

</div>

------------------------------------------------------------------------

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ç”¨æˆ·äº¤æ˜“è¡Œä¸ºè¡¨ (user_trades)

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ç”¨æˆ·çš„äº¤æ˜“è¡Œä¸ºäº‹ä»¶

**åˆ†è¡¨ç­–ç•¥**ï¼šåŸºäºç”¨æˆ·åœ°å€å“ˆå¸Œåˆ†è¡¨ï¼Œå…±128ä¸ªåˆ†åŒº (user_trades_0 ~ user_trades_127)

- ä½¿ç”¨ç”¨æˆ·åœ°å€çš„åå…­è¿›åˆ¶å€¼å¯¹128å–æ¨¡ç¡®å®šåˆ†åŒº

- æŸ¥è¯¢å•ä¸ªç”¨æˆ·æ—¶ç›´æ¥å®šä½åˆ°å¯¹åº”åˆ†åŒºï¼Œæ€§èƒ½æœ€ä¼˜

- è·¨ç”¨æˆ·æŸ¥è¯¢é€šè¿‡æ—¶é—´ç´¢å¼•è¡¨ä¼˜åŒ–ï¼Œé¿å…å…¨é‡æ‰«æ

**æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡ `user_trades_timezone` ç´¢å¼•è¡¨è®°å½•æ¯å¤©å„åˆ†åŒºæ˜¯å¦æœ‰æ•°æ®ï¼Œå¤§å¹…å‡å°‘è·¨è¡¨æŸ¥è¯¢å¼€é”€

#### è¡¨ç»“æ„

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE user_trades_tmpl
(
    id               BIGSERIAL PRIMARY KEY,
    -- äº¤æ˜“è¡Œä¸ºæ ‡è¯†
    action_id        VARCHAR NOT NULL,    -- è¡Œä¸ºID (tx_digest + event_index)
    tx_digest        VARCHAR NOT NULL,    -- äº¤æ˜“å“ˆå¸Œ
    event_index      INT     NOT NULL,    -- äº‹ä»¶ç´¢å¼•
    -- ç”¨æˆ·å’Œä»“ä½ä¿¡æ¯
    user_address     VARCHAR NOT NULL,    -- ç”¨æˆ·åœ°å€
    position_id      VARCHAR NOT NULL,    -- ä»“ä½ID
    package_id       VARCHAR NOT NULL,    -- åˆçº¦ package ID
    -- äº¤æ˜“è¡Œä¸ºç±»å‹
    action_type      VARCHAR NOT NULL,    -- open/increase/decrease/close/liquidation
    -- å¸ç§ä¿¡æ¯
    index_coin       VARCHAR NOT NULL,    -- æ ‡çš„å¸ç§
    collateral_coin  VARCHAR NOT NULL,    -- ä¿è¯é‡‘å¸ç§
    is_long          BOOLEAN NOT NULL,    -- å¤šç©ºæ–¹å‘
    -- æ•°é‡å’Œä»·æ ¼
    size_delta       VARCHAR NOT NULL,    -- ä»“ä½å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼‰
    collateral_delta VARCHAR NOT NULL,    -- ä¿è¯é‡‘å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼‰
    price            VARCHAR NOT NULL,    -- æ‰§è¡Œä»·æ ¼
    -- ç›ˆäºå’Œè´¹ç”¨
    realized_pnl     VARCHAR DEFAULT '0', -- æœ¬æ¬¡æ“ä½œçš„å·²å®ç°ç›ˆäº (USD)
    has_profit       BOOLEAN,             -- æ˜¯å¦ç›ˆåˆ©ï¼ˆä»…å‡ä»“/å¹³ä»“/æ¸…ç®—æœ‰å€¼ï¼‰
    fee_usd          VARCHAR NOT NULL,    -- æ‰‹ç»­è´¹ (USD)
    -- æ—¶é—´æˆ³
    action_time_ms   BIGINT  NOT NULL,    -- è¡Œä¸ºå‘ç”Ÿæ—¶é—´
    -- å…ƒæ•°æ®
    create_at        BIGINT  NOT NULL,
    update_at        BIGINT  NOT NULL
);

-- ç´¢å¼•
CREATE INDEX idx_user_trades_user_time ON user_trades_tmpl (user_address, action_time_ms DESC, id DESC);
CREATE INDEX idx_user_trades_user_action ON user_trades_tmpl (user_address, action_type);
CREATE INDEX idx_user_trades_position ON user_trades_tmpl (position_id);
CREATE INDEX idx_user_trades_time ON user_trades_tmpl (action_time_ms);
CREATE UNIQUE INDEX udx_user_trades_action_id ON user_trades_tmpl (action_id);
```

</div>

</div>

#### Go æ•°æ®æ¨¡å‹

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// data-statistics-infra/model/user_trade.go

package model

import (
    "fmt"
    "github.com/HertzFlow/data-statistics/data-statistics-infra/consts"
    "github.com/HertzFlow/data-statistics/data-statistics-utils/utils"
)

// UserTradeActionDBModel ç”¨æˆ·äº¤æ˜“è¡Œä¸ºè¡¨ï¼ˆæŒ‰ç”¨æˆ·åœ°å€åˆ†128ä¸ªåˆ†åŒºï¼‰
type UserTradeActionDBModel struct {
    BaseDBModel

    // äº¤æ˜“è¡Œä¸ºæ ‡è¯†
    ActionID   string `gorm:"column:action_id; type:varchar; uniqueIndex"`
    TxDigest   string `gorm:"column:tx_digest; type:varchar; index:idx_user_trade_tx"`
    EventIndex int    `gorm:"column:event_index; type:int"`

    // ç”¨æˆ·å’Œä»“ä½ä¿¡æ¯
    UserAddress string `gorm:"column:user_address; type:varchar; index:idx_user_trade_user"`
    PositionID  string `gorm:"column:position_id; type:varchar; index:idx_user_trade_pos"`
    PackageID   string `gorm:"column:package_id; type:varchar"`

    // äº¤æ˜“è¡Œä¸ºç±»å‹
    ActionType consts.TradeActionType `gorm:"column:action_type; type:varchar; index:idx_user_trade_action"`

    // å¸ç§ä¿¡æ¯
    IndexCoin      consts.CoinType `gorm:"column:index_coin; type:varchar"`
    CollateralCoin consts.CoinType `gorm:"column:collateral_coin; type:varchar"`
    IsLong         bool            `gorm:"column:is_long; type:bool"`

    // æ•°é‡å’Œä»·æ ¼ï¼ˆæ³¨æ„ï¼šsizeå’Œcollateralæ˜¯ä»£å¸æ•°é‡ï¼Œä¸æ˜¯USDä»·å€¼ï¼‰
    SizeDelta       string `gorm:"column:size_delta; type:varchar"`        // ä»“ä½å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼Œå¸¦ç¬¦å·ï¼‰
    CollateralDelta string `gorm:"column:collateral_delta; type:varchar"`  // ä¿è¯é‡‘å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼Œå¸¦ç¬¦å·ï¼‰
    Price           string `gorm:"column:price; type:varchar"`             // æ‰§è¡Œä»·æ ¼
    RealizedPnl     string `gorm:"column:realized_pnl; type:varchar"`      // å·²å®ç°ç›ˆäºï¼ˆUSDï¼‰
    HasProfit       *bool  `gorm:"column:has_profit; type:bool"`           // æ˜¯å¦ç›ˆåˆ©ï¼ˆä»…å‡ä»“/å¹³ä»“æœ‰å€¼ï¼‰
    FeeUsd          string `gorm:"column:fee_usd; type:varchar"`           // æ‰‹ç»­è´¹ï¼ˆUSDï¼‰
    ActionTimeMs    int64  `gorm:"column:action_time_ms; type:bigint; index:idx_user_trade_time"` // æ“ä½œæ—¶é—´æˆ³
}

func (m UserTradeActionDBModel) TableName() string {
    // æŒ‰ç”¨æˆ·åœ°å€åˆ†åŒºï¼ˆ128åˆ†åŒºï¼‰
    res, err := utils.HexAddrMod(m.UserAddress, 128)
    if err != nil {
        return "user_trades_0"
    }
    return m.GenTableName(res)
}

func (m UserTradeActionDBModel) GenTableName(i int) string {
    return fmt.Sprintf("user_trades_%d", i)
}

// UserTradeActionTmplDBModel æ¨¡æ¿è¡¨ç”¨äºåˆ›å»ºåˆ†åŒº
type UserTradeActionTmplDBModel struct {
    UserTradeActionDBModel
}

func (UserTradeActionTmplDBModel) TableName() string {
    return "user_trades_tmpl"
}
```

</div>

</div>

#### å¸¸é‡å®šä¹‰

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// data-statistics-infra/consts/trade_action.go

package consts

type TradeActionType string

const (
    TradeActionOpen        TradeActionType = "open"        // å¼€ä»“
    TradeActionIncrease    TradeActionType = "increase"    // åŠ ä»“
    TradeActionDecrease    TradeActionType = "decrease"    // å‡ä»“
    TradeActionClose       TradeActionType = "close"       // å¹³ä»“
    TradeActionLiquidation TradeActionType = "liquidation" // æ¸…ç®—
)
```

</div>

</div>

#### å­—æ®µè¯´æ˜

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| id | BIGSERIAL | è‡ªå¢ä¸»é”® | `1`, `2`, `3` |
| action_id | VARCHAR | è¡Œä¸ºå”¯ä¸€æ ‡è¯†ï¼ˆå…¨å±€å”¯ä¸€ï¼‰ | `0x123abc_0` (tx_digest + event_index) |
| tx_digest | VARCHAR | äº¤æ˜“å“ˆå¸Œ | `0x123abc...` |
| event_index | INT | äº‹ä»¶ç´¢å¼• | `0`, `1`, `2` |
| user_address | VARCHAR | ç”¨æˆ·åœ°å€ï¼ˆåˆ†è¡¨é”®ï¼Œé…åˆaction_typeå»ºç«‹è”åˆç´¢å¼•ï¼‰ | `0x1a2b3c...` |
| position_id | VARCHAR | ä»“ä½ID | `0xabc123...` |
| package_id | VARCHAR | åˆçº¦åŒ…ID | `0x456def...` |
| action_type | VARCHAR | è¡Œä¸ºç±»å‹ï¼ˆé…åˆuser_addresså»ºç«‹è”åˆç´¢å¼•ï¼‰ | `open`, `increase`, `decrease`, `close`, `liquidation` |
| index_coin | VARCHAR | æ ‡çš„å¸ç§ | `BTC`, `ETH` |
| collateral_coin | VARCHAR | ä¿è¯é‡‘å¸ç§ | `USDT`, `USDC` |
| is_long | BOOLEAN | å¤šç©ºæ–¹å‘ | `true` (åšå¤š), `false` (åšç©º) |
| size_delta | VARCHAR | ä»“ä½å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼Œå¸¦ç¬¦å·ï¼‰ | `1.5` (å¢åŠ ), `-0.5` (å‡å°‘) |
| collateral_delta | VARCHAR | ä¿è¯é‡‘å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼Œå¸¦ç¬¦å·ï¼‰ | `100.0` (å¢åŠ ), `-50.0` (å‡å°‘) |
| price | VARCHAR | æ‰§è¡Œä»·æ ¼ | `50000.0` |
| realized_pnl | VARCHAR | æœ¬æ¬¡å·²å®ç°ç›ˆäº (USD) | `100.5` (ç›ˆåˆ©), `-50.0` (äºæŸ) |
| has_profit | BOOLEAN | æ˜¯å¦ç›ˆåˆ©ï¼ˆä»…å‡ä»“/å¹³ä»“æœ‰å€¼ï¼‰ | `true` (ç›ˆåˆ©), `false` (äºæŸ), `null` (å¢ä»“) |
| fee_usd | VARCHAR | æ‰‹ç»­è´¹ (USD) | `5.0` |
| action_time_ms | BIGINT | è¡Œä¸ºå‘ç”Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `1704067200000` |
| create_at | BIGINT | åˆ›å»ºæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | `1704067200000` |
| update_at | BIGINT | æ›´æ–°æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | `1704067200000` |

</div>

#### ç´¢å¼•è¯´æ˜

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| ç´¢å¼•åç§° | ç±»å‹ | å­—æ®µ | ç”¨é€” |
| PRIMARY KEY | ä¸»é”® | `id` | å”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½• |
| udx_user_trades_action_id | å”¯ä¸€ç´¢å¼• | `action_id` | ä¿è¯äº¤æ˜“è¡Œä¸ºçš„å…¨å±€å”¯ä¸€æ€§ |
| idx_user_trades_user_time | å¤åˆç´¢å¼• | `user_address, action_time_ms DESC, id DESC` | å•ç”¨æˆ·æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰ |
| idx_user_trades_user_action | å¤åˆç´¢å¼• | `user_address, action_type` | æŒ‰ç”¨æˆ·å’Œäº¤æ˜“ç±»å‹è¿‡æ»¤æŸ¥è¯¢ |
| idx_user_trades_position | å•åˆ—ç´¢å¼• | `position_id` | æŒ‰ä»“ä½æŸ¥è¯¢æ‰€æœ‰äº¤æ˜“ |
| idx_user_trades_time | å•åˆ—ç´¢å¼• | `action_time_ms` | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |

</div>

### 2.2 ç”¨æˆ·äº¤æ˜“æ—¶é—´ç´¢å¼•è¡¨ (user_trades_timezone)

**ç”¨é€”**ï¼šè®°å½•æ¯å¤©å„åˆ†åŒºè¡¨æ˜¯å¦æœ‰äº¤æ˜“æ•°æ®ï¼Œç”¨äºä¼˜åŒ–æ—¶é—´èŒƒå›´æŸ¥è¯¢

**æ ¸å¿ƒä»·å€¼**ï¼š

- é¿å…å…¨é‡æ‰«æ128ä¸ªåˆ†åŒºè¡¨

- é€šè¿‡æ—¶é—´èŒƒå›´å¿«é€Ÿå®šä½æœ‰æ•°æ®çš„åˆ†åŒº

- å‡å°‘æ— æ•ˆæŸ¥è¯¢ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½10å€ä»¥ä¸Š

#### è¡¨ç»“æ„

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE user_trades_timezone
(
    id            BIGSERIAL PRIMARY KEY,
    -- æ—¶é—´ç»´åº¦ï¼ˆå¤©çº§åˆ«ï¼‰
    date_key      VARCHAR NOT NULL,    -- æ—¥æœŸé”®ï¼Œæ ¼å¼ï¼šYYYYMMDDï¼ˆå¦‚ï¼š20250122ï¼‰
    date_start_ms BIGINT  NOT NULL,    -- è¯¥å¤©çš„èµ·å§‹æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼ŒUTC 00:00:00ï¼‰
    date_end_ms   BIGINT  NOT NULL,    -- è¯¥å¤©çš„ç»“æŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼ŒUTC 23:59:59.999ï¼‰
    -- åˆ†åŒºä¿¡æ¯
    shard_id      INT     NOT NULL,    -- åˆ†åŒºè¡¨ç¼–å·ï¼ˆ0-127ï¼‰
    table_name    VARCHAR NOT NULL,    -- åˆ†åŒºè¡¨åç§°ï¼ˆuser_trades_0 ~ user_trades_127ï¼‰
    -- ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºç›‘æ§ï¼‰
    record_count  BIGINT  DEFAULT 0,   -- è¯¥åˆ†åŒºè¯¥å¤©çš„è®°å½•æ•°
    -- å…ƒæ•°æ®
    create_at     BIGINT  NOT NULL,
    update_at     BIGINT  NOT NULL
);

-- ç´¢å¼•
CREATE UNIQUE INDEX udx_user_trades_tz_date_shard ON user_trades_timezone (date_key, shard_id);
CREATE INDEX idx_user_trades_tz_date_range ON user_trades_timezone (date_start_ms, date_end_ms);
CREATE INDEX idx_user_trades_tz_shard ON user_trades_timezone (shard_id);
```

</div>

</div>

#### Go æ•°æ®æ¨¡å‹

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// data-statistics-infra/model/user_trade.go

// UserTradeTimezoneDBModel ç”¨æˆ·äº¤æ˜“æ—¶é—´ç´¢å¼•è¡¨
type UserTradeTimezoneDBModel struct {
    BaseDBModel

    // æ—¶é—´ç»´åº¦
    DateKey     string `gorm:"column:date_key; type:varchar; uniqueIndex:udx_user_trades_tz_date_shard"`     // YYYYMMDD
    DateStartMs int64  `gorm:"column:date_start_ms; type:bigint; index:idx_user_trades_tz_date_range"`
    DateEndMs   int64  `gorm:"column:date_end_ms; type:bigint; index:idx_user_trades_tz_date_range"`

    // åˆ†åŒºä¿¡æ¯
    ShardID     int    `gorm:"column:shard_id; type:int; uniqueIndex:udx_user_trades_tz_date_shard; index:idx_user_trades_tz_shard"`
    TableName   string `gorm:"column:table_name; type:varchar"`

    // ç»Ÿè®¡ä¿¡æ¯
    RecordCount int64 `gorm:"column:record_count; type:bigint; default:0"`
}

func (UserTradeTimezoneDBModel) TableName() string {
    return "user_trades_timezone"
}

// GenerateDateKey ç”Ÿæˆæ—¥æœŸé”®ï¼ˆYYYYMMDDï¼‰
func GenerateDateKey(timestampMs int64) string {
    return time.UnixMilli(timestampMs).UTC().Format("20060102")
}

// GetDayRange è·å–æŸå¤©çš„èµ·æ­¢æ—¶é—´æˆ³ï¼ˆUTCï¼‰
func GetDayRange(timestampMs int64) (startMs, endMs int64) {
    t := time.UnixMilli(timestampMs).UTC()
    year, month, day := t.Date()

    start := time.Date(year, month, day, 0, 0, 0, 0, time.UTC)
    end := time.Date(year, month, day, 23, 59, 59, 999999999, time.UTC)

    return start.UnixMilli(), end.UnixMilli()
}
```

</div>

</div>

#### å­—æ®µè¯´æ˜

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| id | BIGSERIAL | è‡ªå¢ä¸»é”® | `1`, `2`, `3` |
| date_key | VARCHAR | æ—¥æœŸé”®ï¼ˆYYYYMMDDï¼‰ | `20250122` |
| date_start_ms | BIGINT | è¯¥å¤©èµ·å§‹æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | `1737504000000` (2025-01-22 00:00:00 UTC) |
| date_end_ms | BIGINT | è¯¥å¤©ç»“æŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | `1737590399999` (2025-01-22 23:59:59.999 UTC) |
| shard_id | INT | åˆ†åŒºè¡¨ç¼–å· | `0` ~ `127` |
| table_name | VARCHAR | åˆ†åŒºè¡¨åç§° | `user_trades_0`, `user_trades_127` |
| record_count | BIGINT | è¯¥åˆ†åŒºè¯¥å¤©çš„è®°å½•æ•°ï¼ˆå¯é€‰ï¼‰ | `1234` |

</div>

#### ä½¿ç”¨ç¤ºä¾‹

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// å†™å…¥äº¤æ˜“æ—¶ï¼ŒåŒæ­¥æ›´æ–°ç´¢å¼•è¡¨
func (d *UserTradeDALImpl) StoreTradeAction(ctx context.Context, action *model.UserTradeActionDBModel) error {
    // 1. å†™å…¥äº¤æ˜“æ•°æ®
    tableName := action.TableName()
    if err := d.db.WithContext(ctx).Table(tableName).Create(action).Error; err != nil {
        return err
    }

    // 2. æ›´æ–°æ—¶é—´ç´¢å¼•ï¼ˆUPSERTï¼‰
    shardID, _ := utils.HexAddrMod(action.UserAddress, 128)
    dateKey := model.GenerateDateKey(action.ActionTimeMs)
    startMs, endMs := model.GetDayRange(action.ActionTimeMs)

    timezone := &model.UserTradeTimezoneDBModel{
        DateKey:     dateKey,
        DateStartMs: startMs,
        DateEndMs:   endMs,
        ShardID:     shardID,
        TableName:   tableName,
        RecordCount: 1,
    }

    return d.db.WithContext(ctx).Table("user_trades_timezone").
        Clauses(clause.OnConflict{
            Columns: []clause.Column{{Name: "date_key"}, {Name: "shard_id"}},
            DoUpdates: clause.Assignments(map[string]interface{}{
                "record_count": gorm.Expr("record_count + 1"),
                "update_at":    time.Now().UnixMilli(),
            }),
        }).Create(timezone).Error
}

// æŸ¥è¯¢æ—¶ï¼Œå…ˆé€šè¿‡ç´¢å¼•è¡¨è·å–éœ€è¦æŸ¥è¯¢çš„åˆ†åŒº
func (d *UserTradeDALImpl) GetActiveShardsByDateRange(ctx context.Context, startMs, endMs int64) ([]int, error) {
    var timezones []*model.UserTradeTimezoneDBModel

    err := d.db.WithContext(ctx).Table("user_trades_timezone").
        Where("date_end_ms >= ? AND date_start_ms <= ?", startMs, endMs).
        Group("shard_id").
        Find(&timezones).Error

    if err != nil {
        return nil, err
    }

    // æå–å”¯ä¸€çš„åˆ†åŒºID
    shardMap := make(map[int]bool)
    for _, tz := range timezones {
        shardMap[tz.ShardID] = true
    }

    shards := make([]int, 0, len(shardMap))
    for shardID := range shardMap {
        shards = append(shards, shardID)
    }

    return shards, nil
}
```

</div>

</div>

### 2.3 ç”¨æˆ·æŒä»“è®°å½•è¡¨ (user_positions)

**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·çš„å®æ—¶æŒä»“çŠ¶æ€

#### è¡¨ç»“æ„

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE user_positions
(
    id                      BIGSERIAL PRIMARY KEY,
    -- ä»“ä½æ ‡è¯†
    package_id              VARCHAR NOT NULL,    -- ä»“ä½å¯¹åº”çš„ package ID
    position_id             VARCHAR NOT NULL,    -- ä»“ä½ID
    user_address            VARCHAR NOT NULL,    -- æŒä»“åœ°å€
    -- å¸ç§ä¿¡æ¯
    index_coin              VARCHAR NOT NULL,    -- æŒä»“å¸ç§ï¼ˆæ ‡çš„ï¼‰
    collateral_coin         VARCHAR NOT NULL,    -- ä¿è¯é‡‘å¸ç§
    is_long                 BOOLEAN NOT NULL,    -- å¤šç©ºæ–¹å‘
    -- ä»“ä½æ•°é‡å’Œä»·æ ¼
    position_size           VARCHAR NOT NULL,    -- å½“å‰æŒä»“æ•°é‡ (USD)
    collateral_amount       VARCHAR NOT NULL,    -- å½“å‰ä¿è¯é‡‘æ•°é‡ (USD)
    open_price              VARCHAR NOT NULL,    -- å¼€ä»“ä»·æ ¼
    avg_entry_price         VARCHAR NOT NULL,    -- å¹³å‡æŒä»“ä»·æ ¼ï¼ˆåŠ æƒå¹³å‡ï¼‰
    -- ç›ˆäºä¿¡æ¯
    realized_pnl            VARCHAR DEFAULT '0', -- å·²å®ç°ç›ˆäºï¼ˆç´¯è®¡ï¼‰
    last_pnl_update_time_ms BIGINT,              -- ä¸Šæ¬¡æ›´æ–°å·²å®ç°ç›ˆäºæ—¶é—´
    -- ç»Ÿè®¡å­—æ®µ
    total_increase_volume   VARCHAR DEFAULT '0', -- ç´¯è®¡åŠ ä»“é‡
    total_decrease_volume   VARCHAR DEFAULT '0', -- ç´¯è®¡å‡ä»“é‡
    total_fees_paid         VARCHAR DEFAULT '0', -- ç´¯è®¡æ”¯ä»˜æ‰‹ç»­è´¹
    -- çŠ¶æ€å’Œæ—¶é—´
    status                  VARCHAR NOT NULL,    -- active/closed/liquidated
    open_time_ms            BIGINT  NOT NULL,    -- å¼€ä»“æ—¶é—´
    close_time_ms           BIGINT,              -- å¹³ä»“æ—¶é—´
    last_update_time_ms     BIGINT  NOT NULL,    -- æœ€åæ›´æ–°æ—¶é—´
    last_update_tx_digest   VARCHAR,             -- æœ€åæ›´æ–°çš„äº¤æ˜“å“ˆå¸Œ
    created_at              BIGINT  NOT NULL,
    updated_at              BIGINT  NOT NULL
);
-- ç´¢å¼•
CREATE INDEX idx_user_positions_user ON user_positions (user_address);
CREATE INDEX idx_user_positions_status ON user_positions (status);
CREATE INDEX idx_user_positions_time ON user_positions (open_time_ms);
CREATE UNIQUE INDEX udx_user_positions_package_position ON user_positions (package_id, position_id);
```

</div>

</div>

#### Go æ•°æ®æ¨¡å‹

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// data-statistics-infra/model/user_position.go

package model

import (
    "github.com/HertzFlow/data-statistics/data-statistics-infra/consts"
)

// UserPositionDBModel ç”¨æˆ·æŒä»“è®°å½•è¡¨
type UserPositionDBModel struct {
    BaseDBModel

    // ä»“ä½æ ‡è¯†
    PositionID  string `gorm:"column:position_id; type:varchar; uniqueIndex"`
    UserAddress string `gorm:"column:user_address; type:varchar; index:idx_user_positions_user"`
    PackageID   string `gorm:"column:package_id; type:varchar; index:idx_user_positions_package"`

    // å¸ç§ä¿¡æ¯
    IndexCoin      consts.CoinType `gorm:"column:index_coin; type:varchar"`
    CollateralCoin consts.CoinType `gorm:"column:collateral_coin; type:varchar"`
    IsLong         bool            `gorm:"column:is_long; type:bool"`

    // ä»“ä½æ•°é‡å’Œä»·æ ¼
    PositionSize     string `gorm:"column:position_size; type:varchar"`
    CollateralAmount string `gorm:"column:collateral_amount; type:varchar"`
    OpenPrice        string `gorm:"column:open_price; type:varchar"`
    AvgEntryPrice    string `gorm:"column:avg_entry_price; type:varchar"`

    // ç›ˆäºä¿¡æ¯
    RealizedPnl           string `gorm:"column:realized_pnl; type:varchar; default:'0'"`
    LastPnlUpdateTimeMs   *int64 `gorm:"column:last_pnl_update_time_ms; type:bigint"`

    // ç»Ÿè®¡å­—æ®µ
    TotalIncreaseVolume string `gorm:"column:total_increase_volume; type:varchar; default:'0'"`
    TotalDecreaseVolume string `gorm:"column:total_decrease_volume; type:varchar; default:'0'"`
    TotalFeesPaid       string `gorm:"column:total_fees_paid; type:varchar; default:'0'"`

    // çŠ¶æ€å’Œæ—¶é—´
    Status              string  `gorm:"column:status; type:varchar; index:idx_user_positions_status"`
    OpenTimeMs          int64   `gorm:"column:open_time_ms; type:bigint; index:idx_user_positions_time"`
    CloseTimeMs         *int64  `gorm:"column:close_time_ms; type:bigint"`
    LastUpdateTimeMs    int64   `gorm:"column:last_update_time_ms; type:bigint"`
    LastUpdateTxDigest  *string `gorm:"column:last_update_tx_digest; type:varchar"`
}

func (UserPositionDBModel) TableName() string {
    return "user_positions"
}

// NewUserPosition åˆ›å»ºæ–°çš„æŒä»“è®°å½•
func NewUserPosition(
    positionID, userAddress, packageID string,
    indexCoin, collateralCoin consts.CoinType,
    isLong bool,
    openPrice string,
    timestampMs int64,
) *UserPositionDBModel {
    return &UserPositionDBModel{
        PositionID:       positionID,
        UserAddress:      userAddress,
        PackageID:        packageID,
        IndexCoin:        indexCoin,
        CollateralCoin:   collateralCoin,
        IsLong:           isLong,
        PositionSize:     "0",
        CollateralAmount: "0",
        OpenPrice:        openPrice,
        AvgEntryPrice:    openPrice,
        Status:           consts.PositionStatusActive,
        OpenTimeMs:       timestampMs,
        LastUpdateTimeMs: timestampMs,
    }
}
```

</div>

</div>

#### å­—æ®µè¯´æ˜

<div class="table-wrap">

|  |  |  |  |
|----|----|----|----|
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| position_id | VARCHAR | ä»“ä½å”¯ä¸€æ ‡è¯† | `0xabc123...` |
| user_address | VARCHAR | æŒä»“åœ°å€ | `0x1a2b3c...` |
| package_id | VARCHAR | ä»“ä½å¯¹åº”çš„ package ID | `0x456def...` |
| index_coin | VARCHAR | æŒä»“å¸ç§ï¼ˆæ ‡çš„ï¼‰ | `BTC`, `ETH` |
| collateral_coin | VARCHAR | ä¿è¯é‡‘å¸ç§ | `USDT`, `USDC` |
| is_long | BOOLEAN | å¤šç©ºæ–¹å‘ | `true` (åšå¤š), `false` (åšç©º) |
| position_size | VARCHAR | å½“å‰æŒä»“æ•°é‡ (USD) | `10000.0` |
| collateral_amount | VARCHAR | å½“å‰ä¿è¯é‡‘æ•°é‡ (USD) | `2000.0` |
| open_price | VARCHAR | å¼€ä»“ä»·æ ¼ | `50000.0` |
| avg_entry_price | VARCHAR | å¹³å‡æŒä»“ä»·æ ¼ï¼ˆåŠ æƒå¹³å‡ï¼‰ | `50500.0` |
| realized_pnl | VARCHAR | å·²å®ç°ç›ˆäºï¼ˆç´¯è®¡ï¼‰ | `150.5` |
| last_pnl_update_time_ms | BIGINT | ä¸Šæ¬¡æ›´æ–°å·²å®ç°ç›ˆäºæ—¶é—´ | `1704067200000` |
| total_increase_volume | VARCHAR | ç´¯è®¡åŠ ä»“é‡ (USD) | `15000.0` |
| total_decrease_volume | VARCHAR | ç´¯è®¡å‡ä»“é‡ (USD) | `5000.0` |
| total_fees_paid | VARCHAR | ç´¯è®¡æ”¯ä»˜æ‰‹ç»­è´¹ (USD) | `50.0` |
| status | VARCHAR | æŒä»“çŠ¶æ€ | `active`, `closed`, `liquidated` |
| open_time_ms | BIGINT | å¼€ä»“æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `1704067200000` |
| close_time_ms | BIGINT | å¹³ä»“æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `1704153600000` |

</div>

------------------------------------------------------------------------

## ä¸‰ã€DALå±‚è®¾è®¡

### 3.1 UserTradeDAL æ¥å£å®šä¹‰

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// block-scanner/internal/dal/user_trade.go

package dal

import (
    "context"
    "github.com/HertzFlow/data-statistics/data-statistics-infra/model"
)

type UserTradeDAL interface {
    // å•ä¸ªä¿å­˜
    StoreTradeAction(ctx context.Context, action *model.UserTradeActionDBModel) error
    StoreUserPosition(ctx context.Context, position *model.UserPositionDBModel) error

    // æ‰¹é‡ä¿å­˜
    BatchStoreTradeActions(ctx context.Context, actions []*model.UserTradeActionDBModel) error
    BatchStoreUserPositions(ctx context.Context, positions []*model.UserPositionDBModel) error

    // å•ç”¨æˆ·äº¤æ˜“æŸ¥è¯¢ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰
    GetTradeActionsByUser(ctx context.Context, req *UserTradeQueryRequest) (*UserTradeQueryResponse, error)

    // å…¨é‡äº¤æ˜“æŸ¥è¯¢ï¼ˆè·¨æ‰€æœ‰ç”¨æˆ·åˆ†è¡¨ï¼‰
    GetAllTradeActions(ctx context.Context, req *AllTradeQueryRequest) (*AllTradeQueryResponse, error)

    // æŒä»“æŸ¥è¯¢
    GetUserPosition(ctx context.Context, userAddress, positionID string) (*model.UserPositionDBModel, error)
    GetActiveUserPositions(ctx context.Context, userAddress string) ([]*model.UserPositionDBModel, error)
    UpdatePositionStatus(ctx context.Context, userAddress, positionID string, status string, closeTimeMs *int64) error
}

// UserTradeQueryRequest å•ç”¨æˆ·äº¤æ˜“æŸ¥è¯¢è¯·æ±‚ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰
type UserTradeQueryRequest struct {
    UserAddress    string                  // å¿…éœ€ï¼šç”¨æˆ·åœ°å€
    ActionType     *consts.TradeActionType // å¯é€‰ï¼šäº¤æ˜“ç±»å‹è¿‡æ»¤
    StartTimeMs    *int64                  // å¯é€‰ï¼šèµ·å§‹æ—¶é—´
    EndTimeMs      *int64                  // å¯é€‰ï¼šç»“æŸæ—¶é—´
    Limit          int                     // æ¯é¡µå¤§å°ï¼ˆé»˜è®¤20ï¼Œæœ€å¤§100ï¼‰
    NextActionTime *int64                  // æ¸¸æ ‡ï¼šä¸‹ä¸€é¡µèµ·å§‹æ—¶é—´
    NextID         *int64                  // æ¸¸æ ‡ï¼šä¸‹ä¸€é¡µèµ·å§‹ID
}

// UserTradeQueryResponse å•ç”¨æˆ·äº¤æ˜“æŸ¥è¯¢å“åº”
type UserTradeQueryResponse struct {
    Actions        []*model.UserTradeActionDBModel
    HasMore        bool   // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    NextActionTime *int64 // ä¸‹ä¸€é¡µæ¸¸æ ‡ï¼šæ—¶é—´
    NextID         *int64 // ä¸‹ä¸€é¡µæ¸¸æ ‡ï¼šID
}

// AllTradeQueryRequest å…¨é‡äº¤æ˜“æŸ¥è¯¢è¯·æ±‚
type AllTradeQueryRequest struct {
    StartTimeMs int64                   // å¿…éœ€ï¼šèµ·å§‹æ—¶é—´
    EndTimeMs   int64                   // å¿…éœ€ï¼šç»“æŸæ—¶é—´
    ActionType  *consts.TradeActionType // å¯é€‰ï¼šäº¤æ˜“ç±»å‹è¿‡æ»¤
    Limit       int                     // æ¯æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤1000ï¼‰
}

// AllTradeQueryResponse å…¨é‡äº¤æ˜“æŸ¥è¯¢å“åº”
type AllTradeQueryResponse struct {
    Actions    []*model.UserTradeActionDBModel
    TotalCount int
}
```

</div>

</div>

### 3.2 åˆ†è¡¨æŸ¥è¯¢æ–¹æ¡ˆ

#### 3.2.1 å•ç”¨æˆ·æŸ¥è¯¢ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæŸ¥è¯¢å•ä¸ªç”¨æˆ·çš„äº¤æ˜“å†å²

**ä¼˜åŠ¿**ï¼š

- ç›´æ¥å®šä½åˆ°ç”¨æˆ·å¯¹åº”çš„åˆ†åŒºè¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½æœ€ä¼˜

- æ¸¸æ ‡åˆ†é¡µé¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜

- æ”¯æŒæ— é™æ»šåŠ¨åŠ è½½

**å®ç°é€»è¾‘**ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
func (d *UserTradeDALImpl) GetTradeActionsByUser(
    ctx context.Context,
    req *UserTradeQueryRequest,
) (*UserTradeQueryResponse, error) {
    // 1. æ ¹æ®ç”¨æˆ·åœ°å€è®¡ç®—åˆ†åŒºè¡¨
    var model model.UserTradeActionDBModel
    model.UserAddress = req.UserAddress
    tableName := model.TableName() // user_trades_0 ~ user_trades_127

    // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
    query := d.db.WithContext(ctx).Table(tableName).
        Where("user_address = ?", req.UserAddress)

    // æ¸¸æ ‡åˆ†é¡µï¼šåŸºäº (action_time_ms DESC, id DESC)
    if req.NextActionTime != nil && req.NextID != nil {
        query = query.Where(
            "(action_time_ms < ?) OR (action_time_ms = ? AND id < ?)",
            *req.NextActionTime, *req.NextActionTime, *req.NextID,
        )
    }

    // æ—¶é—´èŒƒå›´è¿‡æ»¤
    if req.StartTimeMs != nil {
        query = query.Where("action_time_ms >= ?", *req.StartTimeMs)
    }
    if req.EndTimeMs != nil {
        query = query.Where("action_time_ms <= ?", *req.EndTimeMs)
    }

    // äº¤æ˜“ç±»å‹è¿‡æ»¤
    if req.ActionType != nil {
        query = query.Where("action_type = ?", *req.ActionType)
    }

    // 3. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå¤šæŸ¥1æ¡åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼‰
    limit := req.Limit
    if limit <= 0 || limit > 100 {
        limit = 20
    }

    var actions []*model.UserTradeActionDBModel
    err := query.Order("action_time_ms DESC, id DESC").
        Limit(limit + 1).
        Find(&actions).Error

    if err != nil {
        return nil, err
    }

    // 4. å¤„ç†åˆ†é¡µæ¸¸æ ‡
    hasMore := len(actions) > limit
    if hasMore {
        actions = actions[:limit]
    }

    var nextActionTime, nextID *int64
    if hasMore && len(actions) > 0 {
        last := actions[len(actions)-1]
        nextActionTime = &last.ActionTimeMs
        nextID = &last.ID
    }

    return &UserTradeQueryResponse{
        Actions:        actions,
        HasMore:        hasMore,
        NextActionTime: nextActionTime,
        NextID:         nextID,
    }, nil
}
```

</div>

</div>

#### 3.2.2 å…¨é‡æŸ¥è¯¢ï¼ˆåŸºäºæ—¶é—´ç´¢å¼•è¡¨ä¼˜åŒ–ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š

- å¹³å°çº§ç»Ÿè®¡åˆ†æï¼ˆå¦‚æ¯æ—¥äº¤æ˜“æ€»é‡ã€æ‰‹ç»­è´¹ç»Ÿè®¡ï¼‰

- æ•°æ®å¯¼å‡ºå’Œå¤‡ä»½

- ç«èµ›æ’è¡Œæ¦œè®¡ç®—

**ä¼˜åŒ–ç­–ç•¥**ï¼š

- âœ… é€šè¿‡ `user_trades_timezone` ç´¢å¼•è¡¨å®šä½æœ‰æ•°æ®çš„åˆ†åŒº

- âœ… åªæŸ¥è¯¢æœ‰æ•°æ®çš„åˆ†åŒºï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢

- âœ… æ€§èƒ½æå‡ï¼šä»æŸ¥è¯¢128ä¸ªåˆ†åŒºé™ä½åˆ°å¹³å‡10-20ä¸ªåˆ†åŒº

**å®ç°é€»è¾‘**ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
func (d *UserTradeDALImpl) GetAllTradeActions(
    ctx context.Context,
    req *AllTradeQueryRequest,
) (*AllTradeQueryResponse, error) {
    // 1. é€šè¿‡æ—¶é—´ç´¢å¼•è¡¨è·å–éœ€è¦æŸ¥è¯¢çš„åˆ†åŒºï¼ˆå…³é”®ä¼˜åŒ–ï¼‰
    activeShards, err := d.GetActiveShardsByDateRange(ctx, req.StartTimeMs, req.EndTimeMs)
    if err != nil {
        return nil, fmt.Errorf("failed to get active shards: %w", err)
    }

    // å¦‚æœæ²¡æœ‰ä»»ä½•åˆ†åŒºæœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
    if len(activeShards) == 0 {
        return &AllTradeQueryResponse{
            Actions:    []*model.UserTradeActionDBModel{},
            TotalCount: 0,
        }, nil
    }

    // 2. å¹¶å‘æŸ¥è¯¢æœ‰æ•°æ®çš„åˆ†åŒºè¡¨ï¼ˆå¤§å¹…å‡å°‘æŸ¥è¯¢æ•°é‡ï¼‰
    resultCh := make(chan []*model.UserTradeActionDBModel, len(activeShards))
    errCh := make(chan error, len(activeShards))

    var wg sync.WaitGroup

    for _, shardID := range activeShards {
        wg.Add(1)
        go func(shardID int) {
            defer wg.Done()

            tableName := fmt.Sprintf("user_trades_%d", shardID)
            var actions []*model.UserTradeActionDBModel

            query := d.db.WithContext(ctx).Table(tableName).
                Where("action_time_ms >= ? AND action_time_ms <= ?",
                    req.StartTimeMs, req.EndTimeMs)

            if req.ActionType != nil {
                query = query.Where("action_type = ?", *req.ActionType)
            }

            if err := query.Find(&actions).Error; err != nil {
                errCh <- err
                return
            }

            resultCh <- actions
        }(shardID)
    }

    // 3. ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡æŸ¥è¯¢å®Œæˆ
    wg.Wait()
    close(resultCh)
    close(errCh)

    // 4. æ£€æŸ¥é”™è¯¯
    if len(errCh) > 0 {
        return nil, <-errCh
    }

    // 5. èšåˆç»“æœ
    var allActions []*model.UserTradeActionDBModel
    for actions := range resultCh {
        allActions = append(allActions, actions...)
    }

    // 6. æŒ‰æ—¶é—´æ’åº
    sort.Slice(allActions, func(i, j int) bool {
        if allActions[i].ActionTimeMs == allActions[j].ActionTimeMs {
            return allActions[i].ID > allActions[j].ID
        }
        return allActions[i].ActionTimeMs > allActions[j].ActionTimeMs
    })

    // 7. é™åˆ¶è¿”å›æ•°é‡
    if req.Limit > 0 && len(allActions) > req.Limit {
        allActions = allActions[:req.Limit]
    }

    return &AllTradeQueryResponse{
        Actions:    allActions,
        TotalCount: len(allActions),
    }, nil
}

// GetActiveShardsByDateRange é€šè¿‡æ—¶é—´ç´¢å¼•è¡¨è·å–æœ‰æ•°æ®çš„åˆ†åŒº
func (d *UserTradeDALImpl) GetActiveShardsByDateRange(ctx context.Context, startMs, endMs int64) ([]int, error) {
    var timezones []*model.UserTradeTimezoneDBModel

    err := d.db.WithContext(ctx).Table("user_trades_timezone").
        Where("date_end_ms >= ? AND date_start_ms <= ?", startMs, endMs).
        Select("DISTINCT shard_id").
        Find(&timezones).Error

    if err != nil {
        return nil, err
    }

    // æå–å”¯ä¸€çš„åˆ†åŒºID
    shardMap := make(map[int]bool)
    for _, tz := range timezones {
        shardMap[tz.ShardID] = true
    }

    shards := make([]int, 0, len(shardMap))
    for shardID := range shardMap {
        shards = append(shards, shardID)
    }

    return shards, nil
}
```

</div>

</div>

**æ€§èƒ½å¯¹æ¯”**ï¼š

<div class="table-wrap">

|              |               |               |            |
|--------------|---------------|---------------|------------|
| åœºæ™¯         | æ— ç´¢å¼•è¡¨      | æœ‰ç´¢å¼•è¡¨      | æ€§èƒ½æå‡   |
| æŸ¥è¯¢1å¤©æ•°æ®  | æŸ¥è¯¢128ä¸ªåˆ†åŒº | æŸ¥è¯¢~10ä¸ªåˆ†åŒº | **12.8å€** |
| æŸ¥è¯¢7å¤©æ•°æ®  | æŸ¥è¯¢128ä¸ªåˆ†åŒº | æŸ¥è¯¢~30ä¸ªåˆ†åŒº | **4.3å€**  |
| æŸ¥è¯¢30å¤©æ•°æ® | æŸ¥è¯¢128ä¸ªåˆ†åŒº | æŸ¥è¯¢~80ä¸ªåˆ†åŒº | **1.6å€**  |

</div>

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

1.  **æ—¶é—´èŒƒå›´é™åˆ¶**ï¼šå¼ºåˆ¶è¦æ±‚æ—¶é—´èŒƒå›´ï¼ˆå¦‚æœ€å¤šæŸ¥è¯¢30å¤©æ•°æ®ï¼‰

2.  **å¼‚æ­¥å¤„ç†**ï¼šå¤§æ•°æ®é‡æŸ¥è¯¢é€šè¿‡åå°ä»»åŠ¡å¼‚æ­¥å¤„ç†

3.  **ç»“æœç¼“å­˜**ï¼šç›¸åŒæŸ¥è¯¢æ¡ä»¶çš„ç»“æœç¼“å­˜åˆ°Redisï¼ˆTTL: 5åˆ†é’Ÿï¼‰

4.  **åˆ†æ‰¹è¿”å›**ï¼šä½¿ç”¨æµå¼APIæˆ–åˆ†æ‰¹è¿”å›ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®

------------------------------------------------------------------------

## å››ã€æœåŠ¡å±‚è®¾è®¡

### 4.1 UserTradeService (é€šç”¨äº¤æ˜“è¿½è¸ªæœåŠ¡)

#### æ ¸å¿ƒèŒè´£

- è®°å½•æ‰€æœ‰ç”¨æˆ·çš„äº¤æ˜“è¡Œä¸º

- æ›´æ–°ç”¨æˆ·æŒä»“çŠ¶æ€

- è®¡ç®—å¹³å‡å…¥åœºä»·æ ¼ã€ç´¯è®¡ç›ˆäºç­‰

#### æœåŠ¡æ¥å£

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// block-scanner/internal/service/user_trade_srv.go

package service

import (
    "context"
    "github.com/HertzFlow/data-statistics/block-scanner/internal/dal"
    "github.com/HertzFlow/data-statistics/data-statistics-infra/consts"
    "github.com/HertzFlow/data-statistics/data-statistics-infra/contract_event"
    "go.uber.org/zap"
)

type UserTradeService struct {
    logger       *zap.Logger
    userTradeDAL dal.UserTradeDAL
}

func NewUserTradeService(
    logger *zap.Logger,
    userTradeDAL dal.UserTradeDAL,
) *UserTradeService {
    return &UserTradeService{
        logger:       logger.With(zap.String("module", "UserTradeService")),
        userTradeDAL: userTradeDAL,
    }
}

// RecordIncreaseTradeAction è®°å½•å¢ä»“äº¤æ˜“è¡Œä¸ºï¼ˆå¼€ä»“æˆ–åŠ ä»“ï¼‰
func (s *UserTradeService) RecordIncreaseTradeAction(
    ctx context.Context,
    event *contract_event.VaultIncreasePositionEvent,
    actionType consts.TradeActionType,
    txDigest string,
    eventIndex int,
    timestampMs int64,
    packageID string,
    checkpoint int64,
) error

// RecordDecreaseTradeAction è®°å½•å‡ä»“äº¤æ˜“è¡Œä¸ºï¼ˆå‡ä»“ã€å¹³ä»“æˆ–æ¸…ç®—ï¼‰
func (s *UserTradeService) RecordDecreaseTradeAction(
    ctx context.Context,
    event *contract_event.VaultDecreasePositionEvent,
    actionType consts.TradeActionType,
    txDigest string,
    eventIndex int,
    timestampMs int64,
    packageID string,
    checkpoint int64,
) error
```

</div>

</div>

## äº”ã€API æ¥å£è®¾è®¡ (data-statistics-query)

### 5.1 ç”¨æˆ·äº¤æ˜“å†å²æ¥å£ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// GET /api/v1/user/trades
// æŸ¥è¯¢ç”¨æˆ·çš„äº¤æ˜“è¡Œä¸ºå†å²ï¼ˆæ”¯æŒæ¸¸æ ‡åˆ†é¡µï¼‰

type UserTradesRequest struct {
    UserAddress    string `form:"user_address" binding:"required"` // ç”¨æˆ·åœ°å€
    ActionType     string `form:"action_type"`                     // å¯é€‰ï¼šäº¤æ˜“ç±»å‹è¿‡æ»¤
    StartTimeMs    *int64 `form:"start_time_ms"`                   // å¯é€‰ï¼šèµ·å§‹æ—¶é—´
    EndTimeMs      *int64 `form:"end_time_ms"`                     // å¯é€‰ï¼šç»“æŸæ—¶é—´
    Limit          int    `form:"limit" default:"20"`              // æ¯é¡µå¤§å°ï¼ˆé»˜è®¤20ï¼Œæœ€å¤§100ï¼‰
    NextActionTime *int64 `form:"next_action_time"`                // æ¸¸æ ‡ï¼šä¸‹ä¸€é¡µèµ·å§‹æ—¶é—´
    NextID         *int64 `form:"next_id"`                         // æ¸¸æ ‡ï¼šä¸‹ä¸€é¡µèµ·å§‹ID
}

type UserTradesResponse struct {
    Actions        []TradeActionInfo `json:"actions"`         // äº¤æ˜“è¡Œä¸ºåˆ—è¡¨
    HasMore        bool              `json:"has_more"`        // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    NextActionTime *int64            `json:"next_action_time"` // ä¸‹ä¸€é¡µæ¸¸æ ‡ï¼šæ—¶é—´
    NextID         *int64            `json:"next_id"`         // ä¸‹ä¸€é¡µæ¸¸æ ‡ï¼šID
}

type TradeActionInfo struct {
    ID              int64  `json:"id"`              // è®°å½•ID
    ActionID        string `json:"action_id"`       // æ“ä½œID
    TxDigest        string `json:"tx_digest"`       // äº¤æ˜“å“ˆå¸Œ
    EventIndex      int    `json:"event_index"`     // äº‹ä»¶ç´¢å¼•
    PositionID      string `json:"position_id"`     // ä»“ä½ID
    ActionType      string `json:"action_type"`     // äº¤æ˜“ç±»å‹
    IndexCoin       string `json:"index_coin"`      // æ ‡çš„å¸ç§
    CollateralCoin  string `json:"collateral_coin"` // ä¿è¯é‡‘å¸ç§
    IsLong          bool   `json:"is_long"`         // å¤šç©ºæ–¹å‘
    SizeDelta       string `json:"size_delta"`      // ä»“ä½å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼‰
    CollateralDelta string `json:"collateral_delta"`// ä¿è¯é‡‘å˜åŒ–é‡ï¼ˆä»£å¸æ•°é‡ï¼‰
    Price           string `json:"price"`           // æ‰§è¡Œä»·æ ¼
    RealizedPnl     string `json:"realized_pnl"`    // å·²å®ç°ç›ˆäº
    HasProfit       *bool  `json:"has_profit"`      // æ˜¯å¦ç›ˆåˆ©
    FeeUsd          string `json:"fee_usd"`         // æ‰‹ç»­è´¹
    ActionTimeMs    int64  `json:"action_time_ms"`  // æ“ä½œæ—¶é—´æˆ³
}
```

</div>

</div>

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
# ç¬¬ä¸€é¡µè¯·æ±‚
curl 'http://localhost:9086/api/v1/user/trades?user_address=0x123...&limit=20'

# å“åº”
{
  "actions": [...],
  "has_more": true,
  "next_action_time": 1704067200000,
  "next_id": 42
}

# ç¬¬äºŒé¡µè¯·æ±‚ï¼ˆä½¿ç”¨ä¸Šä¸€é¡µè¿”å›çš„æ¸¸æ ‡ï¼‰
curl 'http://localhost:9086/api/v1/user/trades?user_address=0x123...&limit=20&next_action_time=1704067200000&next_id=42'
```

</div>

</div>

### 5.2 ç”¨æˆ·æŒä»“æŸ¥è¯¢æ¥å£

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// GET /api/v1/user/positions
// æŸ¥è¯¢ç”¨æˆ·çš„æŒä»“åˆ—è¡¨

type UserPositionsRequest struct {
    UserAddress string `form:"user_address" binding:"required"`
    Status      string `form:"status"`  // active/closed/liquidated
}

type UserPositionsResponse struct {
    Positions []PositionInfo `json:"positions"`
}

type PositionInfo struct {
    PositionID           string `json:"position_id"`
    PackageID            string `json:"package_id"`
    IndexCoin            string `json:"index_coin"`
    CollateralCoin       string `json:"collateral_coin"`
    IsLong               bool   `json:"is_long"`
    PositionSize         string `json:"position_size"`
    CollateralAmount     string `json:"collateral_amount"`
    OpenPrice            string `json:"open_price"`
    AvgEntryPrice        string `json:"avg_entry_price"`
    RealizedPnl          string `json:"realized_pnl"`
    LastPnlUpdateTimeMs  *int64 `json:"last_pnl_update_time_ms"`
    TotalIncreaseVolume  string `json:"total_increase_volume"`
    TotalDecreaseVolume  string `json:"total_decrease_volume"`
    TotalFeesPaid        string `json:"total_fees_paid"`
    Status               string `json:"status"`
    OpenTimeMs           int64  `json:"open_time_ms"`
    CloseTimeMs          *int64 `json:"close_time_ms"`
}
```

</div>

</div>

### 5.3 ä»“ä½è¯¦æƒ…æ¥å£

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
// GET /api/v1/user/position/:position_id
// æŸ¥è¯¢å•ä¸ªä»“ä½çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ‰€æœ‰äº¤æ˜“è¡Œä¸ºï¼‰

type PositionDetailResponse struct {
    Position PositionInfo        `json:"position"`
    Actions  []TradeActionInfo   `json:"actions"`
}
```

</div>

</div>

------------------------------------------------------------------------

## å…­ã€æ•°æ®åº“è¿ç§»

### 6.1 SQL è¿ç§»è„šæœ¬

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- 1. åˆ›å»ºç”¨æˆ·äº¤æ˜“è¡Œä¸ºæ¨¡æ¿è¡¨ï¼ˆæŒ‰ç”¨æˆ·åœ°å€åˆ†128ä¸ªåˆ†åŒºï¼‰
CREATE TABLE IF NOT EXISTS user_trades_tmpl (
    id                   BIGSERIAL PRIMARY KEY,
    action_id            VARCHAR NOT NULL,
    tx_digest            VARCHAR NOT NULL,
    event_index          INT NOT NULL,
    user_address         VARCHAR NOT NULL,
    position_id          VARCHAR NOT NULL,
    package_id           VARCHAR NOT NULL,
    action_type          VARCHAR NOT NULL,
    index_coin           VARCHAR NOT NULL,
    collateral_coin      VARCHAR NOT NULL,
    is_long              BOOLEAN NOT NULL,
    size_delta           VARCHAR NOT NULL,
    collateral_delta     VARCHAR NOT NULL,
    price                VARCHAR NOT NULL,
    realized_pnl         VARCHAR DEFAULT '0',
    has_profit           BOOLEAN,
    fee_usd              VARCHAR NOT NULL,
    action_time_ms       BIGINT NOT NULL,
    create_at            BIGINT NOT NULL,
    update_at            BIGINT NOT NULL
);

-- ç´¢å¼•
CREATE INDEX idx_user_trades_user_time ON user_trades_tmpl(user_address, action_time_ms DESC, id DESC);
CREATE INDEX idx_user_trades_user_action ON user_trades_tmpl(user_address, action_type);
CREATE INDEX idx_user_trades_position ON user_trades_tmpl(position_id);
CREATE INDEX idx_user_trades_time ON user_trades_tmpl(action_time_ms);
CREATE UNIQUE INDEX udx_user_trades_action_id ON user_trades_tmpl(action_id);

-- åˆ›å»º128ä¸ªåˆ†åŒºè¡¨ï¼ˆuser_trades_0 ~ user_trades_127ï¼‰
DO $$
DECLARE
    i INT;
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('
            CREATE TABLE IF NOT EXISTS user_trades_%s (LIKE user_trades_tmpl INCLUDING ALL)
        ', i);
    END LOOP;
END $$;

-- 2. åˆ›å»ºç”¨æˆ·äº¤æ˜“æ—¶é—´ç´¢å¼•è¡¨
CREATE TABLE IF NOT EXISTS user_trades_timezone (
    id            BIGSERIAL PRIMARY KEY,
    date_key      VARCHAR NOT NULL,
    date_start_ms BIGINT  NOT NULL,
    date_end_ms   BIGINT  NOT NULL,
    shard_id      INT     NOT NULL,
    table_name    VARCHAR NOT NULL,
    record_count  BIGINT  DEFAULT 0,
    create_at     BIGINT  NOT NULL,
    update_at     BIGINT  NOT NULL
);

-- ç´¢å¼•
CREATE UNIQUE INDEX udx_user_trades_tz_date_shard ON user_trades_timezone (date_key, shard_id);
CREATE INDEX idx_user_trades_tz_date_range ON user_trades_timezone (date_start_ms, date_end_ms);
CREATE INDEX idx_user_trades_tz_shard ON user_trades_timezone (shard_id);

-- 3. åˆ›å»ºç”¨æˆ·æŒä»“è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS user_positions (
    id                        BIGSERIAL PRIMARY KEY,
    position_id               VARCHAR NOT NULL UNIQUE,
    user_address              VARCHAR NOT NULL,
    package_id                VARCHAR NOT NULL,
    index_coin                VARCHAR NOT NULL,
    collateral_coin           VARCHAR NOT NULL,
    is_long                   BOOLEAN NOT NULL,
    position_size             VARCHAR NOT NULL,
    collateral_amount         VARCHAR NOT NULL,
    open_price                VARCHAR NOT NULL,
    avg_entry_price           VARCHAR NOT NULL,
    realized_pnl              VARCHAR DEFAULT '0',
    last_pnl_update_time_ms   BIGINT,
    total_increase_volume     VARCHAR DEFAULT '0',
    total_decrease_volume     VARCHAR DEFAULT '0',
    total_fees_paid           VARCHAR DEFAULT '0',
    status                    VARCHAR NOT NULL,
    open_time_ms              BIGINT NOT NULL,
    close_time_ms             BIGINT,
    last_update_time_ms       BIGINT NOT NULL,
    last_update_tx_digest     VARCHAR,
    created_at                TIMESTAMP DEFAULT NOW(),
    updated_at                TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_positions_user ON user_positions(user_address);
CREATE INDEX idx_user_positions_status ON user_positions(status);
CREATE INDEX idx_user_positions_time ON user_positions(open_time_ms);
CREATE INDEX idx_user_positions_package ON user_positions(package_id);
```

</div>

</div>

### 6.2 GORM è‡ªåŠ¨è¿ç§»

åœ¨ `block-scanner/internal/dal/migrate.go` ä¸­ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
func AutoMigrate(db *gorm.DB) error {
    // è‡ªåŠ¨è¿ç§»æ¨¡æ¿è¡¨
    if err := db.AutoMigrate(
        // ... ç°æœ‰è¡¨ ...

        // ã€æ–°å¢ã€‘ç”¨æˆ·äº¤æ˜“å’ŒæŒä»“è¿½è¸ªè¡¨
        &model.UserTradeActionTmplDBModel{},
        &model.UserTradeTimezoneDBModel{},  // æ—¶é—´ç´¢å¼•è¡¨
        &model.UserPositionTmplDBModel{},
    ); err != nil {
        return err
    }

    // åˆ›å»ºåˆ†åŒºè¡¨
    if err := createUserTradePartitions(db); err != nil {
        return err
    }

    if err := createUserPositionPartitions(db); err != nil {
        return err
    }

    return nil
}

// createUserTradePartitions åˆ›å»ºuser_tradesçš„128ä¸ªåˆ†åŒºè¡¨
func createUserTradePartitions(db *gorm.DB) error {
    for i := 0; i < 128; i++ {
        tableName := fmt.Sprintf("user_trades_%d", i)
        sql := fmt.Sprintf("CREATE TABLE IF NOT EXISTS %s (LIKE user_trades_tmpl INCLUDING ALL)", tableName)
        if err := db.Exec(sql).Error; err != nil {
            return fmt.Errorf("failed to create table %s: %w", tableName, err)
        }
    }
    return nil
}

// createUserPositionPartitions åˆ›å»ºuser_positionsçš„128ä¸ªåˆ†åŒºè¡¨
func createUserPositionPartitions(db *gorm.DB) error {
    for i := 0; i < 128; i++ {
        tableName := fmt.Sprintf("user_positions_%d", i)
        sql := fmt.Sprintf("CREATE TABLE IF NOT EXISTS %s (LIKE user_positions_tmpl INCLUDING ALL)", tableName)
        if err := db.Exec(sql).Error; err != nil {
            return fmt.Errorf("failed to create table %s: %w", tableName, err)
        }
    }
    return nil
}
```

</div>

</div>

------------------------------------------------------------------------

## ä¸ƒã€æ•°æ®æµå›¾

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
Sui åŒºå—é“¾äº‹ä»¶
  â†“
ChainScanService (æ‰«æåŒºå—é“¾)
  â†“
Kafka: contract_event
  â†“
ParseService (äº‹ä»¶è§£æ)
  â”œâ”€ VaultIncreasePositionEvent
  â”œâ”€ VaultDecreasePositionEvent
  â””â”€ VaultLiquidatePositionEvent
  â†“
PositionService (ç°æœ‰æœåŠ¡)
  â†“
ã€æ ¸å¿ƒã€‘UserTradeService
  â”œâ”€ RecordIncreaseTradeAction()  â†’ user_trades_X (å•ä¸ªä¿å­˜)
  â”‚                                â””â†’ user_trades_timezone (æ›´æ–°ç´¢å¼•) â­
  â”œâ”€ RecordDecreaseTradeAction()  â†’ user_trades_X (å•ä¸ªä¿å­˜)
  â”‚                                â””â†’ user_trades_timezone (æ›´æ–°ç´¢å¼•) â­
  â”œâ”€ BatchStoreTradeActions()     â†’ user_trades_X (æ‰¹é‡ä¿å­˜)
  â”‚                                â””â†’ user_trades_timezone (æ‰¹é‡æ›´æ–°ç´¢å¼•) â­
  â””â”€ UpdateUserPosition()         â†’ user_positions_X (æ›´æ–°æŒä»“)
  â†“
ã€æŸ¥è¯¢å±‚ã€‘UserTradeDAL
  â”œâ”€ GetTradeActionsByUser()      â†’ æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢ï¼ˆå•ç”¨æˆ·ï¼‰
  â”‚                                  ç›´æ¥å®šä½åˆ†åŒºè¡¨
  â”œâ”€ GetAllTradeActions()         â†’ è·¨è¡¨å¹¶å‘æŸ¥è¯¢ï¼ˆå…¨é‡ï¼‰
  â”‚   â”œâ”€ GetActiveShardsByDateRange() â­ æŸ¥è¯¢ç´¢å¼•è¡¨å®šä½åˆ†åŒº
  â”‚   â””â”€ å¹¶å‘æŸ¥è¯¢å®šä½åˆ°çš„åˆ†åŒºï¼ˆå¤§å¹…å‡å°‘æŸ¥è¯¢æ•°ï¼‰
  â””â”€ GetActiveUserPositions()     â†’ æŸ¥è¯¢æ´»è·ƒæŒä»“
  â†“
ã€ä¸šåŠ¡åŠŸèƒ½å±‚ã€‘
  â”œâ”€ ç«èµ›åŠŸèƒ½ (åŸºäºé€šç”¨æ•°æ®ç»Ÿè®¡)
  â”œâ”€ æ•°æ®åˆ†æ (ç”¨æˆ·è¡Œä¸ºåˆ†æ)
  â”œâ”€ é£æ§ç³»ç»Ÿ (å¼‚å¸¸æ£€æµ‹)
  â””â”€ æŠ¥è¡¨ç”Ÿæˆ (äº¤æ˜“ç»Ÿè®¡)

ã€åˆ†è¡¨ç­–ç•¥ã€‘
  user_trades_0 ~ user_trades_127     (æŒ‰ç”¨æˆ·åœ°å€å“ˆå¸Œåˆ†åŒº)
  user_positions_0 ~ user_positions_127 (æŒ‰ç”¨æˆ·åœ°å€å“ˆå¸Œåˆ†åŒº)
```

</div>

</div>

------------------------------------------------------------------------

## å…«ã€è®¾è®¡æ€»ç»“

### 8.1 æ ¸å¿ƒæ”¹è¿›ç‚¹

1.  **åˆ†è¡¨ç­–ç•¥ä¼˜åŒ–**

    - âœ… ä»æŒ‰æœˆåˆ†åŒºæ”¹ä¸ºæŒ‰ç”¨æˆ·åœ°å€åˆ†128ä¸ªåˆ†åŒº

    - âœ… å•ç”¨æˆ·æŸ¥è¯¢æ€§èƒ½æœ€ä¼˜ï¼ˆç›´æ¥å®šä½åˆ†åŒºï¼‰

    - âœ… é¿å…çƒ­ç‚¹åˆ†åŒºé—®é¢˜ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰

2.  **ä¸»é”®å’Œç´¢å¼•ä¼˜åŒ–** â­ æœ€æ–°ä¼˜åŒ–

    - âœ… ä¸»é”®ç®€åŒ–ï¼šä»å¤åˆä¸»é”® `(id, user_address)` æ”¹ä¸ºå•ä¸€ä¸»é”® `id`

    - âœ… æ–°å¢è”åˆç´¢å¼•ï¼š`idx_user_trades_user_action (user_address, action_type)`

    - âœ… æé«˜å†™å…¥æ€§èƒ½ï¼Œç®€åŒ–ä¸»é”®ç®¡ç†

    - âœ… æ”¯æŒæŒ‰ç”¨æˆ·å’Œäº¤æ˜“ç±»å‹å¿«é€Ÿè¿‡æ»¤æŸ¥è¯¢

3.  **æ¸¸æ ‡åˆ†é¡µå®ç°**

    - âœ… åŸºäº (action_time_ms DESC, id DESC) ç»„åˆæ¸¸æ ‡

    - âœ… é¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜

    - âœ… æ”¯æŒæ— é™æ»šåŠ¨åŠ è½½

4.  **æ—¶é—´ç´¢å¼•è¡¨ä¼˜åŒ–** â­ æ ¸å¿ƒåˆ›æ–°

    - âœ… æ–°å¢ `user_trades_timezone` ç´¢å¼•è¡¨

    - âœ… è®°å½•æ¯å¤©å„åˆ†åŒºæ˜¯å¦æœ‰æ•°æ®

    - âœ… å…¨é‡æŸ¥è¯¢æ€§èƒ½æå‡ 4-12 å€

5.  **å…¨é‡æŸ¥è¯¢æ–¹æ¡ˆ**

    - âœ… é€šè¿‡ç´¢å¼•è¡¨å®šä½æœ‰æ•°æ®çš„åˆ†åŒº

    - âœ… è·¨åˆ†åŒºå¹¶å‘æŸ¥è¯¢ï¼ˆåªæŸ¥æœ‰æ•°æ®çš„åˆ†åŒºï¼‰

    - âœ… æ”¯æŒæ—¶é—´èŒƒå›´å’Œç±»å‹è¿‡æ»¤

    - âœ… ç»“æœèšåˆå’Œæ’åº

6.  **æ‰¹é‡æ“ä½œæ”¯æŒ**

    - âœ… å•ä¸ªä¿å­˜ï¼šStoreTradeAction()

    - âœ… æ‰¹é‡ä¿å­˜ï¼šBatchStoreTradeActions()

    - âœ… è‡ªåŠ¨æŒ‰åˆ†åŒºè¡¨åˆ†ç»„æ‰¹é‡æ’å…¥

    - âœ… å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç´¢å¼•è¡¨

### 8.2 æ€§èƒ½è€ƒè™‘

<div class="table-wrap">

|                      |           |                           |              |
|----------------------|-----------|---------------------------|--------------|
| æ“ä½œç±»å‹             | æ€§èƒ½ç‰¹å¾  | ä¼˜åŒ–ç­–ç•¥                  | æ•ˆæœ         |
| å•ç”¨æˆ·æŸ¥è¯¢           | âš¡ æå¿«   | ç›´æ¥å®šä½åˆ†åŒº + æ¸¸æ ‡åˆ†é¡µ   | æ¯«ç§’çº§å“åº”   |
| å…¨é‡æŸ¥è¯¢ï¼ˆæœ‰ç´¢å¼•è¡¨ï¼‰ | âš¡ å¿«     | ç´¢å¼•è¡¨å®šä½åˆ†åŒº + å¹¶å‘æŸ¥è¯¢ | 4-12å€æå‡   |
| å…¨é‡æŸ¥è¯¢ï¼ˆæ— ç´¢å¼•è¡¨ï¼‰ | ğŸŒ è¾ƒæ…¢   | æŸ¥è¯¢æ‰€æœ‰128ä¸ªåˆ†åŒº         | åŸºå‡†æ€§èƒ½     |
| å•ä¸ªä¿å­˜             | âš¡ æå¿«   | ç›´æ¥å†™å…¥ + ç´¢å¼•è¡¨UPSERT   | é¢å¤–1æ¬¡å†™å…¥  |
| æ‰¹é‡ä¿å­˜             | âš¡âš¡ å¾ˆå¿« | æŒ‰åˆ†åŒºåˆ†ç»„ + æ‰¹é‡UPSERT   | è¿‘ä¹çº¿æ€§æ‰©å±• |

</div>

**ç´¢å¼•è¡¨ç»´æŠ¤æˆæœ¬**ï¼š

- æ¯æ¬¡å†™å…¥ï¼šé¢å¤–1æ¬¡ UPSERT æ“ä½œï¼ˆçº¦5-10msï¼‰

- å­˜å‚¨æˆæœ¬ï¼šæ¯å¤©æ¯æ´»è·ƒåˆ†åŒº1æ¡è®°å½•ï¼ˆçº¦128KB/å¤©ï¼‰

- æ€§èƒ½æ”¶ç›Šï¼šå…¨é‡æŸ¥è¯¢æ€§èƒ½æå‡ 4-12 å€

**æŠ•èµ„å›æŠ¥ç‡**ï¼šâœ… æé«˜ï¼ˆå†™å…¥æˆæœ¬å¾®å°ï¼ŒæŸ¥è¯¢æ”¶ç›Šå·¨å¤§ï¼‰

### 8.3 ä½¿ç”¨å»ºè®®

**æ¨èåœºæ™¯**ï¼š

- âœ… ç”¨æˆ·ä¸ªäººäº¤æ˜“å†å²æŸ¥è¯¢

- âœ… å®æ—¶äº¤æ˜“è®°å½•å†™å…¥

- âœ… å•ç”¨æˆ·æ•°æ®ç»Ÿè®¡å’Œåˆ†æ

**è°¨æ…ä½¿ç”¨**ï¼š

- âš ï¸ è·¨æ‰€æœ‰ç”¨æˆ·çš„å…¨é‡æŸ¥è¯¢ï¼ˆéœ€è¦é™åˆ¶æ—¶é—´èŒƒå›´ï¼‰

- âš ï¸ å¤æ‚çš„è·¨ç”¨æˆ·èšåˆç»Ÿè®¡ï¼ˆå»ºè®®ä½¿ç”¨æ•°æ®ä»“åº“æˆ–é¢„è®¡ç®—ï¼‰

**ç¦æ­¢æ“ä½œ**ï¼š

- âŒ æ— æ—¶é—´èŒƒå›´é™åˆ¶çš„å…¨é‡æŸ¥è¯¢

- âŒ é¢‘ç¹çš„è·¨è¡¨JOINæ“ä½œ

- âŒ å®æ—¶çš„å…¨å¹³å°ç”¨æˆ·æ’è¡Œæ¦œï¼ˆä½¿ç”¨Redisç¼“å­˜ä»£æ›¿ï¼‰

------------------------------------------------------------------------

## ä¹ã€æ—¶é—´ç´¢å¼•è¡¨è¯¦ç»†è¯´æ˜

### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´ç´¢å¼•è¡¨ï¼Ÿ

**é—®é¢˜èƒŒæ™¯**ï¼š

- user_trades è¡¨æŒ‰ç”¨æˆ·åœ°å€åˆ†128ä¸ªåˆ†åŒº

- æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·äº¤æ˜“æ—¶ï¼Œéœ€è¦æ‰«ææ‰€æœ‰128ä¸ªåˆ†åŒº

- å³ä½¿æŸäº›åˆ†åŒºåœ¨è¯¥æ—¶é—´æ®µæ²¡æœ‰æ•°æ®ï¼Œä¹Ÿä¼šæ‰§è¡ŒæŸ¥è¯¢ï¼Œé€ æˆèµ„æºæµªè´¹

**è§£å†³æ–¹æ¡ˆ**ï¼š

- å¼•å…¥ `user_trades_timezone` ç´¢å¼•è¡¨

- è®°å½•æ¯å¤©å„åˆ†åŒºæ˜¯å¦æœ‰äº¤æ˜“æ•°æ®

- æŸ¥è¯¢æ—¶å…ˆé€šè¿‡ç´¢å¼•è¡¨å®šä½æœ‰æ•°æ®çš„åˆ†åŒºï¼Œå†æŸ¥è¯¢

### 9.2 ç´¢å¼•è¡¨å·¥ä½œåŸç†

**å†™å…¥æµç¨‹**ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
1. å†™å…¥äº¤æ˜“æ•°æ®åˆ° user_trades_X
   â†“
2. è®¡ç®—åˆ†åŒºIDï¼šshardID = HexAddrMod(userAddress, 128)
   â†“
3. è®¡ç®—æ—¥æœŸé”®ï¼šdateKey = Format(timestamp, "20060102")
   â†“
4. UPSERT åˆ° user_trades_timezone:
   - å”¯ä¸€é”®ï¼š(date_key, shard_id)
   - å†²çªæ—¶ï¼šrecord_count++
```

</div>

</div>

**æŸ¥è¯¢æµç¨‹**ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
1. æŸ¥è¯¢æ—¶é—´èŒƒå›´ï¼š2025-01-20 ~ 2025-01-22
   â†“
2. æŸ¥è¯¢ç´¢å¼•è¡¨è·å–æ´»è·ƒåˆ†åŒºï¼š
   SELECT DISTINCT shard_id
   FROM user_trades_timezone
   WHERE date_end_ms >= startMs AND date_start_ms <= endMs

   ç»“æœï¼š[3, 15, 27, 42, 88, 101, 117]  (7ä¸ªåˆ†åŒº)
   â†“
3. å¹¶å‘æŸ¥è¯¢è¿™7ä¸ªåˆ†åŒºï¼ˆè€Œä¸æ˜¯128ä¸ªï¼‰
   â†“
4. èšåˆç»“æœå¹¶è¿”å›
```

</div>

</div>

### 9.3 æ€§èƒ½æ•°æ®åˆ†æ

**å‡è®¾åœºæ™¯**ï¼š

- æ€»ç”¨æˆ·æ•°ï¼š10,000

- æ´»è·ƒç”¨æˆ·æ•°ï¼š1,000ï¼ˆæ¯å¤©ï¼‰

- åˆ†åŒºæ•°ï¼š128

- å¹³å‡åˆ†å¸ƒï¼š1000 / 128 â‰ˆ 8 ä¸ªæ´»è·ƒåˆ†åŒº/å¤©

**æ€§èƒ½å¯¹æ¯”**ï¼š

<div class="table-wrap">

|          |           |            |          |
|----------|-----------|------------|----------|
| æŸ¥è¯¢å¤©æ•° | æ— ç´¢å¼•è¡¨  | æœ‰ç´¢å¼•è¡¨   | æå‡å€æ•° |
| 1å¤©      | 128ä¸ªåˆ†åŒº | ~8ä¸ªåˆ†åŒº   | 16å€     |
| 3å¤©      | 128ä¸ªåˆ†åŒº | ~24ä¸ªåˆ†åŒº  | 5.3å€    |
| 7å¤©      | 128ä¸ªåˆ†åŒº | ~56ä¸ªåˆ†åŒº  | 2.3å€    |
| 30å¤©     | 128ä¸ªåˆ†åŒº | ~128ä¸ªåˆ†åŒº | 1å€      |

</div>

**ç»“è®º**ï¼šæ—¶é—´èŒƒå›´è¶ŠçŸ­ï¼Œä¼˜åŒ–æ•ˆæœè¶Šæ˜æ˜¾

### 9.4 ç´¢å¼•è¡¨ç»´æŠ¤

**è‡ªåŠ¨ç»´æŠ¤**ï¼š

- æ¯æ¬¡å†™å…¥äº¤æ˜“æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•è¡¨

- ä½¿ç”¨ UPSERT é¿å…é‡å¤æ’å…¥

- è‡ªåŠ¨ç´¯åŠ  record_count

**å®šæœŸæ¸…ç†**ï¼ˆå¯é€‰ï¼‰ï¼š

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- åˆ é™¤90å¤©å‰çš„ç´¢å¼•è®°å½•
DELETE FROM user_trades_timezone
WHERE date_start_ms < EXTRACT(EPOCH FROM NOW() - INTERVAL '90 days') * 1000;
```

</div>

</div>

**ç›‘æ§æŒ‡æ ‡**ï¼š

- æ¯å¤©ç´¢å¼•è¡¨å¢é•¿ï¼šçº¦128æ¡è®°å½•ï¼ˆæœ€å¤šï¼Œå‡è®¾æ‰€æœ‰åˆ†åŒºéƒ½æœ‰æ•°æ®ï¼‰

- å®é™…å¢é•¿ï¼šå–å†³äºæ´»è·ƒç”¨æˆ·åˆ†å¸ƒ

- å»ºè®®å®šæœŸæ£€æŸ¥ record_countï¼Œè¯†åˆ«çƒ­ç‚¹åˆ†åŒº

### 9.5 æ½œåœ¨ä¼˜åŒ–æ–¹å‘

**è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š

1.  **å°æ—¶çº§ç´¢å¼•**ï¼šå¦‚æœæŸ¥è¯¢æ›´ç²¾ç»†ï¼Œå¯ä»¥æ”¹ä¸ºå°æ—¶çº§ï¼ˆYYYYMMDDHHï¼‰

2.  **é¢„èšåˆç»Ÿè®¡**ï¼šåœ¨ç´¢å¼•è¡¨ä¸­å­˜å‚¨æ›´å¤šç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»äº¤æ˜“é‡ã€æ€»æ‰‹ç»­è´¹ç­‰ï¼‰

3.  **å¸ƒéš†è¿‡æ»¤å™¨**ï¼šå¯¹äºæé«˜å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿›ä¸€æ­¥å‡å°‘æŸ¥è¯¢

4.  **åˆ†åŒºè¡¨å‹ç¼©**ï¼šå¯¹äºå†å²å†·æ•°æ®åˆ†åŒºï¼Œå¯ä»¥å®šæœŸå‹ç¼©æˆ–å½’æ¡£

</div>

# V3版本数据表设计

<div class="Section1">

## ⚠️ 重要说明

本文档基于实际 Sui Chain 表结构设计 BNB Chain 对应表。以下是关键注意事项：

1.  **表名格式**:

    - 用户表使用下划线：`bnb_user_trades_{shard}`

    - 订单和事件表使用连字符：`bnb_perp_order-{shard}`、`bnb_transaction_event-{YYYY-MM}`

2.  **需要跨链兼容的表**（共14个）:

    - 用户相关: `user_trades`, `user_positions`, `user_trades_timezone`

    - 订单相关: `perp_order`, `perp_position`, `swap_order`, `position_event`

    - 全局事件: `transaction_event`, `contract_stats_event`

    - Custody: `custodies`, `custodies_hourly`（BNB 用 custodies 替代 vault_stats）

    - 配置: `oracle_token_configs`, `protocol_store_whitelist`, `hzlp_coin_info`

3.  **全局共用表（不需要 BNB 版本）**:

    - `vault_stats` - Vault统计（Sui 专用，BNB 使用 `bnb_custodies` 代替）

    - `history_metric` - 历史指标（通过 `metric_type` key 区分不同链）

    - `config_setting` - 通用配置

    - `news_feeds` - 新闻订阅

    - `dashboard_stats` - 已废弃

4.  **表结构详情**: 下文中表4-14的详细字段定义需要根据实际 Sui 表结构进一步完善

5.  **重要说明**:

    - BNB 不创建 `bnb_vault_stats` 表，使用 `bnb_custodies` 存储池子统计数据

    - `history_metric` 为全局表，通过 `metric_type` 字段区分链（如 `bnb_vault_stats`）

    - **时间字段统一使用**: `create_at BIGINT`（autoCreateTime:milli）和 `update_at BIGINT`（autoUpdateTime:milli）

    - **币种字段设计**: 与 Sui 保持相同字段名（如 `index_coin`），但存储 token 合约地址而非符号

------------------------------------------------------------------------

## 概述

### BNB Chain vs Sui Chain 主要区别

<div class="table-wrap">

|  |  |  |
|----|----|----|
| 特性 | Sui Chain | BNB Chain (BSC) |
| 地址格式 | 66字符 (0x + 64 hex) | 42字符 (0x + 40 hex) |
| 交易哈希 | 44字符 (Base58) | 66字符 (0x + 64 hex) |
| 区块标识 | Checkpoint | Block Number |
| 事件索引 | Event Index | Log Index |
| 合约标识 | Package ID | Contract Address |
| Gas Token | SUI | BNB |
| 时间字段 | `created_at/updated_at TIMESTAMP` | `create_at/update_at BIGINT`（毫秒） |
| 时间管理 | PostgreSQL 默认值 | GORM autoCreateTime/autoUpdateTime |
| 币种字段 | 存储符号（如 "BTC", "ETH"） | 存储 token 地址（如 "0x..."） |
| 字段命名 | `index_coin`, `collateral_coin` 等 | 相同（字段名一致，内容不同） |

</div>

### 分区策略

- **用户相关表**: 按用户地址 hash 分128个分区（与Sui链保持一致）

- **全局事件表**: 按区块号范围或时间月份分区

- **分区命名**: `bnb_table_name_{shard}` 或 `bnb_table_name_{YYYY-MM}`

------------------------------------------------------------------------

## 数据表列表

### 用户交易相关表

1.  `bnb_user_trades_{0-127}` - 用户交易行为记录

2.  `bnb_user_positions_{0-127}` - 用户持仓记录

3.  `bnb_user_trades_timezone` - 用户交易时间索引

### 订单相关表（使用连字符分隔）

4.  `bnb_perp_order-{0-127}` - 永续合约订单

5.  `bnb_perp_position-{0-127}` - 永续合约仓位

6.  `bnb_swap_order-{0-127}` - Swap订单

7.  `bnb_position_event-{0-127}` - 仓位事件记录

### 全局事件表（使用连字符分隔）

8.  `bnb_transaction_event-{YYYY-MM}` - 全局交易事件

9.  `bnb_contract_stats_event-{YYYY-MM}` - 合约统计事件

### Custody表（BNB 用此替代 vault_stats）

10. `bnb_custodies` - 托管配置（包含池子统计数据）

11. `bnb_custodies_hourly` - 托管小时数据

### 配置和代币表

12. `bnb_oracle_token_configs` - Oracle代币配置

13. `bnb_protocol_store_whitelist` - 协议白名单

14. `bnb_hzlp_coin_info` - HZLP代币信息

------------------------------------------------------------------------

## 全局共用表说明

以下表不需要创建 BNB 版本，全局共用：

### 统计表

- `vault_stats` - Vault统计（Sui 专用，BNB 使用 `bnb_custodies` 代替）

- `history_metric` - 历史指标（通过 `metric_type` 字段的 key 区分不同链数据）

  - Sui 示例 key: `sui_contract_activity`, `sui_vault_stats`

  - BNB 示例 key: `bnb_contract_activity`, `bnb_vault_stats`

### 其他全局表

- `config_setting` - 通用配置设置（单链使用）

- `news_feeds` - 新闻订阅（全局共用，不区分链）

- `dashboard_stats` - 仪表板统计（已废弃，不使用）

------------------------------------------------------------------------

## 详细表结构

### 1. bnb_user_trades\_{0-127}

**用途**: 记录用户所有交易行为（开仓、平仓、增仓、减仓、清算）

**分区策略**: 按用户地址 hash 分128个分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_user_trades_{shard} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 核心标识字段
    action_id VARCHAR(100) NOT NULL UNIQUE,  -- tx_hash + log_index
    tx_hash VARCHAR(66) NOT NULL,            -- 交易哈希 (0x + 64 hex)
    log_index INTEGER NOT NULL,              -- 日志索引
    block_number BIGINT NOT NULL,            -- 区块号

    -- 用户和合约信息
    user_address VARCHAR(42) NOT NULL,       -- 用户地址 (0x + 40 hex)
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址
    position_id VARCHAR(66),                 -- 仓位ID（如果有）

    -- 交易行为
    action_type VARCHAR(20) NOT NULL,        -- increase/decrease/close/liquidate/swap

    -- 交易标的（与 Sui 字段名相同，但存储 token 地址）
    index_coin VARCHAR(42) NOT NULL,         -- 标的币种 token 地址
    collateral_coin VARCHAR(42) NOT NULL,    -- 保证金币种 token 地址
    is_long BOOLEAN NOT NULL,                -- 多空方向

    -- 交易数量和价格
    size_delta VARCHAR(78) NOT NULL,         -- 仓位变化量（带符号）
    collateral_delta VARCHAR(78) NOT NULL,   -- 保证金变化量（带符号）
    price VARCHAR(78) NOT NULL,              -- 执行价格
    realized_pnl VARCHAR(78),                -- 已实现盈亏（USD）
    has_profit BOOLEAN,                      -- 是否盈利（仅减仓/平仓有值）
    fee_usd VARCHAR(78) NOT NULL,            -- 手续费（USD）

    -- 时间戳
    action_time_ms BIGINT NOT NULL,          -- 操作时间（毫秒）
    block_timestamp BIGINT NOT NULL,         -- 区块时间戳（秒）

    -- 索引
    INDEX idx_bnb_user_trades_user_time (user_address, action_time_ms DESC, action_id DESC),
    INDEX idx_bnb_user_trades_user_action (user_address, action_type),
    INDEX idx_bnb_user_trades_position (position_id),
    INDEX idx_bnb_user_trades_block (block_number),
    INDEX idx_bnb_user_trades_tx (tx_hash)
);
```

</div>

</div>

------------------------------------------------------------------------

### 2. bnb_user_positions\_{0-127}

**用途**: 记录用户持仓状态（当前持仓和历史持仓）

**分区策略**: 按用户地址 hash 分128个分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_user_positions_{shard} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 核心标识字段
    position_id VARCHAR(66) NOT NULL UNIQUE, -- 仓位唯一标识
    user_address VARCHAR(42) NOT NULL,       -- 用户地址
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址

    -- 仓位标的（与 Sui 字段名相同，但存储 token 地址）
    index_coin VARCHAR(42) NOT NULL,         -- 标的币种 token 地址
    collateral_coin VARCHAR(42) NOT NULL,    -- 保证金币种 token 地址
    is_long BOOLEAN NOT NULL,                -- 多空方向

    -- 仓位数量和价格
    position_size VARCHAR(78) NOT NULL,      -- 当前仓位大小（代币数量）
    collateral_amount VARCHAR(78) NOT NULL,  -- 当前保证金数量（代币数量）
    open_price VARCHAR(78) NOT NULL,         -- 初始开仓价格
    avg_entry_price VARCHAR(78) NOT NULL,    -- 加权平均入场价格
    realized_pnl VARCHAR(78) NOT NULL,       -- 累计已实现盈亏（USD）
    last_pnl_update_time_ms BIGINT,          -- 上次盈亏更新时间

    -- 状态和时间
    status VARCHAR(20) NOT NULL,             -- active/closed/liquidated
    open_time_ms BIGINT NOT NULL,            -- 开仓时间（毫秒）
    close_time_ms BIGINT,                    -- 平仓时间（毫秒）
    last_update_time_ms BIGINT NOT NULL,     -- 最后更新时间（毫秒）
    last_update_tx_hash VARCHAR(66),         -- 最后更新交易哈希
    last_update_block_number BIGINT,         -- 最后更新区块号

    -- 索引
    INDEX idx_bnb_user_positions_user (user_address, status),
    INDEX idx_bnb_user_positions_cursor (user_address, open_time_ms DESC, position_id DESC),
    INDEX idx_bnb_user_positions_status (status)
);
```

</div>

</div>

------------------------------------------------------------------------

### 3. bnb_perp_order-{0-127}

**用途**: 记录永续合约订单（限价单和市价单）

**分区策略**: 按用户地址 hash 分128个分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_perp_order-{shard} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 核心标识字段
    order_id VARCHAR(66),                    -- 限价单ID（与request_id二选一）
    request_id VARCHAR(66),                  -- 市价单ID（与order_id二选一）
    user_address VARCHAR(42) NOT NULL,       -- 用户地址
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址

    -- 订单类型和状态
    order_type VARCHAR(20) NOT NULL,         -- limit/market
    order_status VARCHAR(20) NOT NULL,       -- pending/executed/cancelled/expired

    -- 交易标的（与 Sui 字段名相同，但存储 token 地址）
    index_coin VARCHAR(42) NOT NULL,         -- 标的币种 token 地址
    collateral_coin VARCHAR(42) NOT NULL,    -- 保证金币种 token 地址
    pay_coin VARCHAR(42),                    -- 支付币种 token 地址
    is_long BOOLEAN NOT NULL,                -- 多空方向

    -- 订单数量和价格
    size VARCHAR(78),                        -- 仓位大小（仅Execute时填充）
    collateral_amount VARCHAR(78),           -- 保证金数量（仅Execute时填充）
    trigger_price VARCHAR(78),               -- 触发价格（限价单）
    trigger_above BOOLEAN,                   -- 是否向上触发（限价单）
    acceptable_price VARCHAR(78) NOT NULL,   -- 可接受价格
    execution_fee VARCHAR(78) NOT NULL,      -- 执行费用

    -- Position相关
    position_id VARCHAR(66),                 -- Position ID（Execute时填充）

    -- 区块信息
    block_number BIGINT,                     -- 区块号
    tx_hash VARCHAR(66),                     -- 交易哈希

    -- 时间戳
    create_timestamp_ms BIGINT NOT NULL,     -- 创建时间（必填）
    update_timestamp_ms BIGINT,              -- 更新时间（可空）
    cancel_timestamp_ms BIGINT,              -- 取消时间（可空）
    execute_timestamp_ms BIGINT,             -- 执行时间（可空）

    -- 索引
    INDEX idx_bnb_perp_order_user (user_address, order_status, create_timestamp_ms DESC),
    INDEX idx_bnb_perp_order_cursor (user_address, create_timestamp_ms DESC, COALESCE(order_id, request_id) DESC),
    INDEX idx_bnb_perp_order_position (position_id),
    INDEX idx_bnb_perp_order_tx (tx_hash),
    UNIQUE INDEX udx_bnb_perp_order_id (COALESCE(order_id, request_id))
);
```

</div>

</div>

------------------------------------------------------------------------

### 4. bnb_swap_order\_{0-127}

**用途**: 记录Swap订单（HZLP买卖）

**分区策略**: 按用户地址 hash 分128个分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_swap_order_{shard} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 核心标识字段
    order_creator VARCHAR(42) NOT NULL,      -- 订单创建者
    sender VARCHAR(42) NOT NULL,             -- 交易发送者
    tx_hash VARCHAR(66) NOT NULL,            -- 交易哈希
    log_index INTEGER NOT NULL,              -- 日志索引
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址

    -- 订单详情
    execution_fee VARCHAR(78),               -- 执行费用

    -- 币种字段（与 Sui 字段名相同，但存储 token 地址）
    input_coin VARCHAR(42) NOT NULL,         -- 输入币种 token 地址
    input_amount VARCHAR(78) NOT NULL,       -- 输入数量

    output_coin VARCHAR(42) NOT NULL,        -- 输出币种 token 地址
    output_amount VARCHAR(78) NOT NULL,      -- 输出数量

    price VARCHAR(78),                       -- 交易价格
    is_buy_hzlp BOOLEAN NOT NULL,            -- 是否买入HZLP
    volume_usd_value VARCHAR(78),            -- 成交额（USD）

    -- 时间戳
    execute_timestamp_ms BIGINT NOT NULL,    -- 执行时间（毫秒）

    -- 索引
    INDEX idx_bnb_swap_order_creator (order_creator, execute_timestamp_ms DESC),
    INDEX idx_bnb_swap_order_cursor (order_creator, execute_timestamp_ms DESC, tx_hash DESC),
    INDEX idx_bnb_swap_order_tx (tx_hash),
    UNIQUE INDEX udx_bnb_swap_order (tx_hash, log_index)
);
```

</div>

</div>

------------------------------------------------------------------------

### 5. bnb_position_event\_{0-127}

**用途**: 记录仓位事件（用于历史查询和审计）

**分区策略**: 按用户地址 hash 分128个分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_position_event_{shard} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）

    -- 核心标识字段
    tx_hash VARCHAR(66) NOT NULL,            -- 交易哈希
    log_index INTEGER NOT NULL,              -- 日志索引

    position_key VARCHAR(66) NOT NULL,       -- 仓位Key
    position_owner VARCHAR(42) NOT NULL,     -- 仓位所有者
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址

    -- 事件类型
    event_type VARCHAR(20) NOT NULL,         -- IncreasePosition/DecreasePosition/Liquidate

    -- 仓位信息（与 Sui 字段名相同，但存储 token 地址）
    direction VARCHAR(10) NOT NULL,          -- long/short
    position_type VARCHAR(20) NOT NULL,      -- limit/market
    index_coin VARCHAR(42) NOT NULL,         -- 标的币种 token 地址
    collateral_coin VARCHAR(42) NOT NULL,    -- 保证金币种 token 地址

    -- 变化量
    size_delta VARCHAR(78) NOT NULL,         -- 仓位变化
    collateral_delta VARCHAR(78) NOT NULL,   -- 保证金变化
    fee VARCHAR(78) NOT NULL,                -- 手续费
    price VARCHAR(78) NOT NULL,              -- 价格
    pnl VARCHAR(78),                         -- 盈亏（仅减仓有值）

    -- 时间戳
    timestamp BIGINT NOT NULL,               -- 事件时间戳（毫秒）

    -- 索引
    INDEX idx_bnb_position_event_owner (position_owner, timestamp DESC),
    INDEX idx_bnb_position_event_key (position_key, timestamp DESC),
    INDEX idx_bnb_position_event_tx (tx_hash),
    UNIQUE INDEX udx_bnb_position_event (tx_hash, log_index)
);
```

</div>

</div>

------------------------------------------------------------------------

### 6. bnb_transaction_event\_{YYYY-MM}

**用途**: 记录全局交易事件（按月分区）

**分区策略**: 按区块时间月份分区

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_transaction_event_{YYYY-MM} (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）

    -- 核心标识字段
    tx_hash VARCHAR(66) NOT NULL,            -- 交易哈希
    log_index INTEGER NOT NULL,              -- 日志索引
    contract_address VARCHAR(42) NOT NULL,   -- 合约地址

    -- 事件详情
    event_type VARCHAR(50) NOT NULL,         -- 事件类型
    event_signature VARCHAR(66),             -- 事件签名（topic[0]）
    timestamp BIGINT NOT NULL,               -- 事件时间戳（秒）
    block_number BIGINT NOT NULL,            -- 区块号
    transaction_module VARCHAR(100),         -- 交易模块/方法
    sender VARCHAR(42),                      -- 交易发送者

    -- 事件数据（JSON格式）
    payload TEXT NOT NULL,                   -- 事件数据

    -- 索引
    INDEX idx_bnb_tx_event_contract (contract_address, event_type),
    INDEX idx_bnb_tx_event_block (block_number),
    INDEX idx_bnb_tx_event_timestamp (timestamp),
    INDEX idx_bnb_tx_event_sender (sender),
    UNIQUE INDEX udx_bnb_tx_event (tx_hash, log_index)
);
```

</div>

</div>

------------------------------------------------------------------------

### 7. bnb_vault_stats

**用途**: 记录Vault的统计数据

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_vault_stats (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- Vault标识
    vault_address VARCHAR(42) NOT NULL UNIQUE, -- Vault合约地址
    vault_name VARCHAR(50),                    -- Vault名称

    -- 统计数据
    aum_usd VARCHAR(78) NOT NULL,              -- 资产管理规模（USD）
    max_aum_usd VARCHAR(78) NOT NULL,          -- 最大资产管理规模（USD）
    pool_amount_usd VARCHAR(78),               -- 池子总金额（USD）
    reserved_amount_usd VARCHAR(78),           -- 预留金额（USD）
    available_amount_usd VARCHAR(78),          -- 可用金额（USD）
    guaranteed_usd VARCHAR(78),                -- 担保金额（USD）

    -- HZLP相关
    hzlp_supply VARCHAR(78),                   -- HZLP总供应量
    hzlp_price VARCHAR(78),                    -- HZLP价格

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_tx_hash VARCHAR(66),           -- 最后更新交易哈希
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_vault_stats_address (vault_address),
    INDEX idx_bnb_vault_stats_time (last_update_time_ms DESC)
);
```

</div>

</div>

------------------------------------------------------------------------

### 8. bnb_vault_balances

**用途**: 记录Vault中各代币的余额

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_vault_balances (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- Vault和代币标识
    vault_address VARCHAR(42) NOT NULL,        -- Vault合约地址
    coin_symbol VARCHAR(20) NOT NULL,          -- 币种符号
    token_address VARCHAR(42) NOT NULL,        -- 代币合约地址

    -- 余额数据
    pool_amount VARCHAR(78) NOT NULL,          -- 池子数量
    reserved_amount VARCHAR(78) NOT NULL,      -- 预留数量
    available_amount VARCHAR(78) NOT NULL,     -- 可用数量
    pool_amount_usd VARCHAR(78),               -- 池子金额（USD）
    reserved_amount_usd VARCHAR(78),           -- 预留金额（USD）

    -- 权重配置
    target_weight INTEGER,                     -- 目标权重（基点，10000=100%）
    actual_weight INTEGER,                     -- 实际权重（基点）

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_vault_balances_vault (vault_address, coin_symbol),
    UNIQUE INDEX udx_bnb_vault_balances (vault_address, token_address)
);
```

</div>

</div>

------------------------------------------------------------------------

### 9. bnb_vault_custodies

**用途**: 记录Vault托管配置

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_vault_custodies (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- Vault和代币标识
    vault_address VARCHAR(42) NOT NULL,        -- Vault合约地址
    coin_symbol VARCHAR(20) NOT NULL,          -- 币种符号
    token_address VARCHAR(42) NOT NULL,        -- 代币合约地址

    -- 托管配置
    is_stable BOOLEAN NOT NULL,                -- 是否稳定币
    is_shortable BOOLEAN NOT NULL,             -- 是否可做空
    decimals INTEGER NOT NULL,                 -- 精度

    -- 费率配置
    mint_fee_bps INTEGER,                      -- Mint费率（基点）
    burn_fee_bps INTEGER,                      -- Burn费率（基点）
    swap_fee_bps INTEGER,                      -- Swap费率（基点）
    position_fee_bps INTEGER,                  -- 持仓费率（基点）
    borrow_fee_per_hour_bps INTEGER,           -- 借款费率/小时（基点）

    -- 限额配置
    max_global_long_size VARCHAR(78),          -- 最大全局多头
    max_global_short_size VARCHAR(78),         -- 最大全局空头
    max_leverage INTEGER,                      -- 最大杠杆（倍数）

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_vault_custodies_vault (vault_address, coin_symbol),
    UNIQUE INDEX udx_bnb_vault_custodies (vault_address, token_address)
);
```

</div>

</div>

------------------------------------------------------------------------

### 10. bnb_oracle_token_config

**用途**: 记录Oracle代币配置

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_oracle_token_config (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 代币标识
    coin_symbol VARCHAR(20) NOT NULL UNIQUE,   -- 币种符号
    token_address VARCHAR(42),                 -- 代币合约地址（可空，原生币）

    -- Oracle配置
    oracle_type VARCHAR(20) NOT NULL,          -- chainlink/pyth/custom
    oracle_address VARCHAR(42),                -- Oracle合约地址
    price_feed_id VARCHAR(66),                 -- 价格Feed ID

    -- 代币信息
    decimals INTEGER NOT NULL,                 -- 代币精度
    max_price_age_seconds INTEGER,             -- 最大价格年龄（秒）

    -- 价格校验
    max_deviation_bps INTEGER,                 -- 最大偏差（基点）
    min_price VARCHAR(78),                     -- 最小价格
    max_price VARCHAR(78),                     -- 最大价格

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_oracle_config_symbol (coin_symbol),
    INDEX idx_bnb_oracle_config_token (token_address)
);
```

</div>

</div>

------------------------------------------------------------------------

### 11. bnb_trade_coin_configs

**用途**: 交易币种白名单配置

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_trade_coin_configs (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 代币标识
    coin_symbol VARCHAR(20) NOT NULL UNIQUE,   -- 币种符号
    token_address VARCHAR(42),                 -- 代币合约地址

    -- 交易配置
    is_enabled BOOLEAN NOT NULL DEFAULT true,  -- 是否启用
    is_stable BOOLEAN NOT NULL,                -- 是否稳定币
    is_shortable BOOLEAN NOT NULL,             -- 是否可做空

    -- 显示信息
    coin_name VARCHAR(50),                     -- 币种全称
    coin_icon_url VARCHAR(200),                -- 图标URL
    display_order INTEGER,                     -- 显示顺序

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_trade_coins_symbol (coin_symbol),
    INDEX idx_bnb_trade_coins_enabled (is_enabled, display_order)
);
```

</div>

</div>

------------------------------------------------------------------------

### 12. bnb_protocol_settings

**用途**: 协议全局设置

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_protocol_settings (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 设置键值
    setting_key VARCHAR(50) NOT NULL UNIQUE,   -- 设置键
    setting_value TEXT NOT NULL,               -- 设置值（JSON格式）
    setting_type VARCHAR(20) NOT NULL,         -- 值类型：string/number/boolean/json

    -- 描述信息
    description TEXT,                          -- 设置说明
    category VARCHAR(50),                      -- 设置分类

    -- 更新信息
    last_update_block_number BIGINT,           -- 最后更新区块号
    last_update_tx_hash VARCHAR(66),           -- 最后更新交易哈希
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_protocol_settings_key (setting_key),
    INDEX idx_bnb_protocol_settings_category (category)
);
```

</div>

</div>

------------------------------------------------------------------------

### 13. bnb_whale_trades_cache

**用途**: 巨鲸交易缓存（用于V3接口）

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_whale_trades_cache (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）

    -- 交易信息（从user_trades复制）
    action_id VARCHAR(100) NOT NULL UNIQUE,
    user_address VARCHAR(42) NOT NULL,
    action_type VARCHAR(20) NOT NULL,
    index_coin VARCHAR(42) NOT NULL,         -- 标的币种 token 地址
    is_long BOOLEAN NOT NULL,
    size_delta VARCHAR(78) NOT NULL,
    price VARCHAR(78) NOT NULL,
    volume_usd VARCHAR(78) NOT NULL,
    fee_usd VARCHAR(78) NOT NULL,
    action_time_ms BIGINT NOT NULL,

    -- 聚合统计
    user_total_volume_24h VARCHAR(78),         -- 用户24小时总交易量
    user_rank VARCHAR(20),                     -- 用户排名：top_10/top_50/top_100

    -- 缓存信息
    cache_time_ms BIGINT NOT NULL,             -- 缓存时间（毫秒）

    -- 索引
    INDEX idx_bnb_whale_trades_time (action_time_ms DESC, action_id DESC),
    INDEX idx_bnb_whale_trades_volume (volume_usd DESC),
    INDEX idx_bnb_whale_trades_user (user_address)
);
```

</div>

</div>

------------------------------------------------------------------------

### 14. bnb_smart_money_scores

**用途**: 聪明钱评分表（用于V3接口）

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_smart_money_scores (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 用户标识
    user_address VARCHAR(42) NOT NULL UNIQUE,  -- 用户地址

    -- 交易统计
    total_trades INTEGER NOT NULL,             -- 总交易次数
    win_trades INTEGER NOT NULL,               -- 盈利交易次数
    win_rate DECIMAL(5, 4) NOT NULL,           -- 胜率（0-1）

    -- 盈亏统计
    total_pnl VARCHAR(78) NOT NULL,            -- 总盈亏（USD）
    max_drawdown VARCHAR(78),                  -- 最大回撤（USD）

    -- 风险指标
    sharpe_ratio DECIMAL(10, 4),               -- 夏普比率
    avg_hold_time_hours INTEGER,               -- 平均持仓时间（小时）
    avg_trade_size_usd VARCHAR(78),            -- 平均交易额（USD）

    -- 偏好统计
    favorite_symbols TEXT,                     -- 最常交易的币种（JSON数组）
    long_short_ratio DECIMAL(5, 2),            -- 多空比率

    -- 更新信息
    last_trade_time_ms BIGINT,                 -- 最后交易时间（毫秒）
    last_update_time_ms BIGINT NOT NULL,       -- 最后更新时间（毫秒）

    -- 索引
    INDEX idx_bnb_smart_money_win_rate (win_rate DESC),
    INDEX idx_bnb_smart_money_pnl (total_pnl DESC),
    INDEX idx_bnb_smart_money_sharpe (sharpe_ratio DESC)
);
```

</div>

</div>

------------------------------------------------------------------------

### 15. bnb_market_ticker_snapshot

**用途**: 行情快照表（用于V3接口）

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_market_ticker_snapshot (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）
    update_at BIGINT NOT NULL,               -- 更新时间（毫秒时间戳，GORM autoUpdateTime:milli）

    -- 币种标识
    symbol VARCHAR(20) NOT NULL UNIQUE,        -- 交易对符号（BTC/USD）
    index_coin VARCHAR(42) NOT NULL,           -- 标的币种 token 地址

    -- 价格数据
    last_price VARCHAR(78) NOT NULL,           -- 最新价格
    mark_price VARCHAR(78),                    -- 标记价格
    index_price VARCHAR(78),                   -- 指数价格

    -- 24小时统计
    high_24h VARCHAR(78),                      -- 24小时最高价
    low_24h VARCHAR(78),                       -- 24小时最低价
    volume_24h_usd VARCHAR(78),                -- 24小时成交量（USD）
    trade_count_24h BIGINT,                    -- 24小时成交笔数

    -- 持仓数据
    total_long_usd VARCHAR(78),                -- 总多头持仓（USD）
    total_short_usd VARCHAR(78),               -- 总空头持仓（USD）
    total_oi_usd VARCHAR(78),                  -- 总持仓量（USD）
    long_short_ratio DECIMAL(10, 4),           -- 多空比率

    -- 费率数据
    funding_rate VARCHAR(78),                  -- Funding Rate（当前）
    funding_rate_1h VARCHAR(78),               -- Funding Rate（1小时平均）
    borrow_fee_long_1h VARCHAR(78),            -- 多头借款费率（1小时）
    borrow_fee_short_1h VARCHAR(78),           -- 空头借款费率（1小时）

    -- 快照时间
    snapshot_time_ms BIGINT NOT NULL,          -- 快照时间（毫秒）

    -- 索引
    INDEX idx_bnb_market_ticker_symbol (symbol),
    INDEX idx_bnb_market_ticker_time (snapshot_time_ms DESC)
);
```

</div>

</div>

------------------------------------------------------------------------

### 16. bnb_user_trades_timezone

**用途**: 用户交易时间索引表（优化时间范围查询）

**字段定义**:

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
CREATE TABLE bnb_user_trades_timezone (
    -- 主键和时间戳
    id BIGSERIAL PRIMARY KEY,
    create_at BIGINT NOT NULL,               -- 创建时间（毫秒时间戳，GORM autoCreateTime:milli）

    -- 时间维度
    date_key VARCHAR(8) NOT NULL,              -- YYYYMMDD
    date_start_ms BIGINT NOT NULL,             -- 当天开始时间戳（毫秒）
    date_end_ms BIGINT NOT NULL,               -- 当天结束时间戳（毫秒）

    -- 分区信息
    shard_id INTEGER NOT NULL,                 -- 分区ID（0-127）
    shard_table_name VARCHAR(50) NOT NULL,     -- 分区表名

    -- 索引
    INDEX idx_bnb_user_trades_tz_date_range (date_start_ms, date_end_ms),
    INDEX idx_bnb_user_trades_tz_shard (shard_id),
    UNIQUE INDEX udx_bnb_user_trades_tz (date_key, shard_id)
);
```

</div>

</div>

------------------------------------------------------------------------

## 模板表（Template Tables）

用于创建分区表的模板：

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- 用户交易模板表
CREATE TABLE bnb_user_trades_tmpl AS SELECT * FROM bnb_user_trades_0 WHERE 1=0;

-- 用户持仓模板表
CREATE TABLE bnb_user_positions_tmpl AS SELECT * FROM bnb_user_positions_0 WHERE 1=0;

-- 永续订单模板表
CREATE TABLE bnb_perp_order_tmpl AS SELECT * FROM bnb_perp_order_0 WHERE 1=0;

-- Swap订单模板表
CREATE TABLE bnb_swap_order_tmpl AS SELECT * FROM bnb_swap_order_0 WHERE 1=0;

-- 仓位事件模板表
CREATE TABLE bnb_position_event_tmpl AS SELECT * FROM bnb_position_event_0 WHERE 1=0;
```

</div>

</div>

------------------------------------------------------------------------

## 分区创建脚本

### 创建用户相关分区表（0-127）

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- 创建用户交易分区
DO $$
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS bnb_user_trades_%s (LIKE bnb_user_trades_tmpl INCLUDING ALL)', i);
    END LOOP;
END $$;

-- 创建用户持仓分区
DO $$
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS bnb_user_positions_%s (LIKE bnb_user_positions_tmpl INCLUDING ALL)', i);
    END LOOP;
END $$;

-- 创建永续订单分区
DO $$
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS bnb_perp_order_%s (LIKE bnb_perp_order_tmpl INCLUDING ALL)', i);
    END LOOP;
END $$;

-- 创建Swap订单分区
DO $$
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS bnb_swap_order_%s (LIKE bnb_swap_order_tmpl INCLUDING ALL)', i);
    END LOOP;
END $$;

-- 创建仓位事件分区
DO $$
BEGIN
    FOR i IN 0..127 LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS bnb_position_event_%s (LIKE bnb_position_event_tmpl INCLUDING ALL)', i);
    END LOOP;
END $$;
```

</div>

</div>

------------------------------------------------------------------------

## 与Sui链表的主要差异

<div class="table-wrap">

|              |                           |                                |
|--------------|---------------------------|--------------------------------|
| 项目         | Sui Chain                 | BNB Chain                      |
| 地址长度     | 66字符                    | 42字符                         |
| 地址字段     | `VARCHAR(255)`            | `VARCHAR(42)`                  |
| 交易哈希     | Base58, 44字符            | Hex, 66字符                    |
| 交易哈希字段 | `tx_digest VARCHAR(255)`  | `tx_hash VARCHAR(66)`          |
| 区块标识     | `checkpoint BIGINT`       | `block_number BIGINT`          |
| 事件索引     | `event_index INT`         | `log_index INT`                |
| 合约标识     | `package_id VARCHAR(255)` | `contract_address VARCHAR(42)` |
| 时间戳       | 毫秒                      | 秒（链上）+ 毫秒（应用）       |
| 代币标识     | CoinType字符串            | Token Address (ERC20)          |

</div>

------------------------------------------------------------------------

## 索引策略

### 游标分页索引

所有用户相关表需要复合索引支持游标分页：

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- 用户交易表
CREATE INDEX idx_bnb_user_trades_cursor
ON bnb_user_trades_{shard} (user_address, action_time_ms DESC, action_id DESC);

-- 用户持仓表
CREATE INDEX idx_bnb_user_positions_cursor
ON bnb_user_positions_{shard} (user_address, open_time_ms DESC, position_id DESC);

-- 永续订单表
CREATE INDEX idx_bnb_perp_order_cursor
ON bnb_perp_order_{shard} (user_address, create_timestamp_ms DESC, COALESCE(order_id, request_id) DESC);
```

</div>

</div>

### 查询优化索引

<div class="code panel pdl" style="border-width: 1px;">

<div class="codeContent panelContent pdl">

``` syntaxhighlighter-pre
-- 区块号范围查询
CREATE INDEX idx_bnb_tx_event_block_range
ON bnb_transaction_event_{YYYY-MM} (block_number, log_index);

-- 用户地址快速查找
CREATE INDEX idx_bnb_user_trades_user
ON bnb_user_trades_{shard} (user_address);

-- 仓位ID查询
CREATE INDEX idx_bnb_user_positions_id
ON bnb_user_positions_{shard} (position_id);
```

</div>

</div>

------------------------------------------------------------------------

## 数据迁移注意事项

1.  **地址格式转换**: Sui地址（66字符）→ BNB地址（42字符）

2.  **交易哈希格式**: Base58 → Hex

3.  **区块标识**: checkpoint → block_number

4.  **事件索引**: event_index → log_index

5.  **代币标识**: 需要维护 symbol ↔ token_address 映射关系

------------------------------------------------------------------------

</div>

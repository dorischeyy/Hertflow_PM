# 合约状态监控

<div class="Section1">

### 一、合约基础与完整性监控（技术层）

#### 1. 核心合约元数据验证

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="de9ab219-0f0d-48bc-906f-f52553f09323">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>核心合约地址有效性</p></td>
<td class="confluenceTd"><p>确保协议关键组件可交互</p></td>
<td class="confluenceTd"><p>验证以下核心合约是否为链上有效合约（非 EOA 地址，有代码存储）：</p>
<ul>
<li><p>核心逻辑：ExchangeRouter、MarketFactory、DataStore、RoleStore</p></li>
</ul>
<ul>
<li><p>处理层：DepositHandler、OrderHandler、WithdrawalHandler</p></li>
</ul>
<ul>
<li><p>依赖层：Oracle、GLV、MarketToken</p></li>
</ul></td>
<td class="confluenceTd"><p>任意核心合约调用 <code>eth_getCode</code> 返回空值（合约自毁或部署失败）</p></td>
<td class="confluenceTd"><ol>
<li><p>链上节点 RPC 调用 <code>eth_getCode(合约地址)</code></p></li>
</ol>
<ol start="2">
<li><p>第三方 API（Alchemy/Infura）批量校验</p></li>
</ol>
<ol start="3">
<li><p>每日定时执行（间隔 15 分钟）</p></li>
</ol></td>
<td class="confluenceTd"><p>需维护核心合约地址白名单，避免监控无效地址</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>合约代码哈希一致性</p></td>
<td class="confluenceTd"><p>防止未授权篡改或恶意升级</p></td>
<td class="confluenceTd"><p>定期计算核心合约的代码哈希（keccak256 (合约字节码)），与部署时的基准哈希对比：</p>
<ul>
<li><p>基准哈希需在部署后存档（如写入配置文件）</p></li>
</ul>
<ul>
<li><p>重点监控 Oracle、OrderHandler、DataStore（数据 / 逻辑核心）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>代码哈希与基准值不一致（非预期升级）</p></li>
</ol>
<ol start="2">
<li><p>合约字节码长度变化（排除编译器优化导致的微小差异）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>eth_getCode</code> 获取字节码，本地计算 keccak256 哈希</p></li>
</ol>
<ol start="2">
<li><p>对比基准哈希库（如 JSON 文件存储）</p></li>
</ol>
<ol start="3">
<li><p>触发条件：合约交易后主动校验 + 每小时定时校验</p></li>
</ol></td>
<td class="confluenceTd"><p>若为预期升级，需提前更新基准哈希库，避免误报</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>ABI 接口兼容性</p></td>
<td class="confluenceTd"><p>确保监控工具能正确解析合约函数</p></td>
<td class="confluenceTd"><p>验证本地使用的 ABI 与链上合约实际接口匹配：</p>
<ul>
<li><p>核心函数签名（如 <code>createOrder</code>、<code>executeDeposit</code>）</p></li>
</ul>
<ul>
<li><p>事件定义（如 <code>OrderExecuted</code>、<code>PriceUpdated</code>）</p></li>
</ul>
<ul>
<li><p>结构体字段（如 <code>Market.Props</code>、<code>Position.Props</code>）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>调用核心函数返回 <code>invalid function selector</code>（函数不存在）</p></li>
</ol>
<ol start="2">
<li><p>解析事件时缺失关键字段（如 <code>priceImpact</code>）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>本地 ABI 生成函数签名（<code>web3.eth.abi.encodeFunctionSignature</code>）</p></li>
</ol>
<ol start="2">
<li><p>链上模拟调用函数（<code>eth_call</code>）验证是否 revert</p></li>
</ol>
<ol start="3">
<li><p>监听事件时校验字段完整性</p></li>
</ol></td>
<td class="confluenceTd"><p>合约升级后需同步更新 ABI 文件，否则监控会失效</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>合约存储结构完整性</p></td>
<td class="confluenceTd"><p>防止关键存储数据损坏</p></td>
<td class="confluenceTd"><p>检查 DataStore 中核心存储键的存在性（基于 GMX 合约存储规范）：</p>
<ul>
<li><p>系统配置：<code>MAX_ORACLE_REF_PRICE_DEVIATION_FACTOR</code>、<code>MIN_COLLATERAL_FACTOR</code></p></li>
</ul>
<ul>
<li><p>市场数据：<code>MARKET_LIST</code>、<code>MARKET_TOKEN_LIST</code></p></li>
</ul>
<ul>
<li><p>权限配置：<code>ROLE_ADMIN</code>、<code>ROLE_CONTROLLER</code></p></li>
</ul></td>
<td class="confluenceTd"><p>任意核心存储键调用 <code>DataStore.getUint256/getBytes32</code> 返回异常（revert 或默认零值）</p></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>DataStore</code> 合约的查询方法（如 <code>getUint256(key)</code>）</p></li>
</ol>
<ol start="2">
<li><p>预定义核心存储键列表（基于 GMX 源码 <code>Keys</code> 常量）</p></li>
</ol>
<ol start="3">
<li><p>每小时校验一次</p></li>
</ol></td>
<td class="confluenceTd"><p>需熟悉 GMX 存储键的编码规则（如 <code>keccak256("MARKET_LIST")</code>）</p></td>
</tr>
</tbody>
</table>

</div>

#### 2. 依赖合约健康度

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="29215a18-8355-4143-a608-5f965b563f7d">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>MarketToken 功能有效性</p></td>
<td class="confluenceTd"><p>确保流动性代币可正常 mint/burn</p></td>
<td class="confluenceTd"><p>验证 MarketToken 的核心方法：</p>
<ul>
<li><p><code>totalSupply()</code>：返回非零值（有流动性）</p></li>
</ul>
<ul>
<li><p><code>balanceOf(address)</code>：查询指定地址余额正常</p></li>
</ul>
<ul>
<li><p><code>mint(address, uint256)</code>/<code>burn(address, uint256)</code>：模拟调用不 revert</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>连续 3 次调用 <code>totalSupply()</code> 返回零值（无流动性）</p></li>
</ol>
<ol start="2">
<li><p>模拟 mint/burn 调用 revert（功能异常）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>按市场遍历所有 MarketToken 合约</p></li>
</ol>
<ol start="2">
<li><p>调用核心方法并检查返回值</p></li>
</ol>
<ol start="3">
<li><p>每日定时校验（间隔 30 分钟）</p></li>
</ol></td>
<td class="confluenceTd"><p>新市场创建后自动添加到监控列表</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>GLV 重平衡功能可用性</p></td>
<td class="confluenceTd"><p>确保流动性自动分配正常</p></td>
<td class="confluenceTd"><p>监控 GLV（GMX Liquidity Vault）的核心逻辑：</p>
<ul>
<li><p><code>getMarketUtilization(marketId)</code>：返回合理利用率（0-100%）</p></li>
</ul>
<ul>
<li><p><code>calculateRebalanceAmounts()</code>：模拟重平衡无 revert</p></li>
</ul>
<ul>
<li><p><code>executeRebalance()</code>：历史执行记录存在（近 24 小时至少 1 次）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>利用率返回值 &gt; 100% 或 &lt; 0（计算异常）</p></li>
</ol>
<ol start="2">
<li><p>模拟重平衡调用 revert</p></li>
</ol>
<ol start="3">
<li><p>24 小时内无重平衡执行记录</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 GLV 合约查询 / 模拟方法</p></li>
</ol>
<ol start="2">
<li><p>监听 <code>GLVRebalanced</code> 事件统计执行次数</p></li>
</ol>
<ol start="3">
<li><p>每 2 小时校验一次</p></li>
</ol></td>
<td class="confluenceTd"><p>GLV 重平衡依赖 keeper 触发，需结合 keeper 活跃度监控</p></td>
</tr>
</tbody>
</table>

</div>

### 二、市场与流动性池监控（业务层）

#### 1. 流动性池核心指标

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="57011dd6-22f5-4746-82ac-8bfe5cb90f3a">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>单市场抵押资产余额</p></td>
<td class="confluenceTd"><p>监控市场内 long/short 资产安全</p></td>
<td class="confluenceTd"><p>按市场统计抵押代币余额（原生代币 + ERC20）：</p>
<ul>
<li><p>公式：<code>longTokenBalance = ERC20(longToken).balanceOf(marketAddress)</code></p></li>
</ul>
<ul>
<li><p>公式：<code>shortTokenBalance = ERC20(shortToken).balanceOf(marketAddress)</code></p></li>
</ul>
<ul>
<li><p>支持多市场（如 ETH/USD、BTC/USD）分别监控</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>1 小时内资产余额减少 &gt; 10%（非预期流出）</p></li>
</ol>
<ol start="2">
<li><p>1 小时内资产余额增加 &gt; 50%（异常流入，可能为操纵）</p></li>
</ol>
<ol start="3">
<li><p>余额突变为 0（合约被掏空）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用对应代币合约 <code>balanceOf(marketAddress)</code></p></li>
</ol>
<ol start="2">
<li><p>按市场分组存储历史余额（5 分钟粒度）</p></li>
</ol>
<ol start="3">
<li><p>实时监听 <code>Transfer</code> 事件（过滤市场地址为 <code>to</code>/<code>from</code>）</p></li>
</ol></td>
<td class="confluenceTd"><p>需排除已知的大额存提（如团队操作），可配置白名单地址</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>流动性池总价值（Pool USD）</p></td>
<td class="confluenceTd"><p>评估市场整体资金规模</p></td>
<td class="confluenceTd"><p>计算单市场池价值（USD 计价）：</p>
<ul>
<li><p>公式：<code>poolUsd = (longTokenBalance * longTokenPrice + shortTokenBalance * shortTokenPrice) / 1e30</code></p></li>
</ul>
<ul>
<li><p>注：价格取自 Oracle 合约（30 位精度）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>池价值 24 小时波动 &gt; 30%（市场剧烈变动）</p></li>
</ol>
<ol start="2">
<li><p>池价值 &lt; 10,000 USD（小额市场，流动性风险）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>MarketUtils.getPoolUsdWithoutPnl(marketId)</code></p></li>
</ol>
<ol start="2">
<li><p>本地结合 Oracle 价格复算验证</p></li>
</ol>
<ol start="3">
<li><p>15 分钟粒度更新</p></li>
</ol></td>
<td class="confluenceTd"><p>需处理 Oracle 价格异常场景（如价格为 0 时跳过计算）</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>市场代币（MarketToken）价格</p></td>
<td class="confluenceTd"><p>跟踪流动性提供者（LP）资产价值</p></td>
<td class="confluenceTd"><p>计算 MarketToken 实时价格：</p>
<ul>
<li><p>公式：<code>marketTokenPrice = (poolUsd + pendingPnl) / totalSupply</code></p></li>
</ul>
<ul>
<li><p>对比链上计算值与本地复算值</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>链上返回值与本地复算值偏差 &gt; 1%（计算逻辑异常）</p></li>
</ol>
<ol start="2">
<li><p>价格 1 小时内下跌 &gt; 20%（LP 大规模亏损）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>MarketUtils.getMarketTokenPrice(marketId)</code></p></li>
</ol>
<ol start="2">
<li><p>本地按公式复算（依赖 poolUsd、pendingPnl、totalSupply 数据）</p></li>
</ol>
<ol start="3">
<li><p>5 分钟粒度更新</p></li>
</ol></td>
<td class="confluenceTd"><p>pendingPnl 为未结盈亏，需区分多空方向</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>流动性利用率</p></td>
<td class="confluenceTd"><p>评估资金池使用效率与风险</p></td>
<td class="confluenceTd"><p>计算单市场流动性利用率：</p>
<ul>
<li><p>公式：<code>usageFactor = reservedUsd / poolUsd</code></p></li>
</ul>
<ul>
<li><p><code>reservedUsd</code>：为未平仓仓位预留的资金</p></li>
</ul>
<ul>
<li><p><code>poolUsd</code>：池总价值（不含未结 PnL）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>利用率 &gt; 90%（资金池接近满负荷，可能无法开仓）</p></li>
</ol>
<ol start="2">
<li><p>利用率 &lt; 10%（资金闲置，市场活跃度低）</p></li>
</ol>
<ol start="3">
<li><p>1 小时内利用率波动 &gt; 50%（异常开仓 / 平仓）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>MarketUtils.getUsageFactor(marketId)</code></p></li>
</ol>
<ol start="2">
<li><p>解析 DataStore 中 <code>RESERVED_USD</code> 存储键</p></li>
</ol>
<ol start="3">
<li><p>10 分钟粒度更新</p></li>
</ol></td>
<td class="confluenceTd"><p>利用率过高时，需结合开仓量监控，预警流动性枯竭风险</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>市场限额合规性</p></td>
<td class="confluenceTd"><p>确保不超配置的风险上限</p></td>
<td class="confluenceTd"><p>验证单市场关键限额参数是否合规：</p>
<ul>
<li><p><code>maxPoolAmount</code>：最大存款量</p></li>
</ul>
<ul>
<li><p><code>maxOpenInterest</code>：最大开仓量</p></li>
</ul>
<ul>
<li><p><code>reserveFactor</code>：最大预留比例（<code>reservedUsd / poolUsd ≤ reserveFactor</code>）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>实际存款量 &gt; <code>maxPoolAmount</code> 的 105%</p></li>
</ol>
<ol start="2">
<li><p>实际开仓量 &gt; <code>maxOpenInterest</code> 的 105%</p></li>
</ol>
<ol start="3">
<li><p>预留比例 &gt; <code>reserveFactor</code> 的 105%</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>调用 <code>MarketStore.getMarketProps(marketId)</code> 获取配置值</p></li>
</ol>
<ol start="2">
<li><p>计算实际值（存款量 / 开仓量 / 预留比例）</p></li>
</ol>
<ol start="3">
<li><p>实时校验（每笔存提 / 开仓后）+ 5 分钟定时校验</p></li>
</ol></td>
<td class="confluenceTd"><p>限额参数可通过治理修改，需同步监控参数变更</p></td>
</tr>
</tbody>
</table>

</div>

#### 2. 跨市场汇总指标

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="f3a55585-23f8-4fe7-acf3-7ce06358296d">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>全协议流动性总价值</p></td>
<td class="confluenceTd"><p>评估协议整体资金规模</p></td>
<td class="confluenceTd"><p>汇总所有市场的 <code>poolUsd</code> 之和</p></td>
<td class="confluenceTd"><ol>
<li><p>24 小时内总价值波动 &gt; 20%</p></li>
</ol>
<ol start="2">
<li><p>总价值 &lt; 100,000 USD（协议规模过小，风险高）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>遍历 <code>MARKET_LIST</code> 中所有市场</p></li>
</ol>
<ol start="2">
<li><p>调用 <code>MarketUtils.getPoolUsdWithoutPnl</code> 汇总</p></li>
</ol>
<ol start="3">
<li><p>15 分钟粒度更新</p></li>
</ol></td>
<td class="confluenceTd"><p>需排除已禁用市场，避免重复计算</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>市场分布集中度</p></td>
<td class="confluenceTd"><p>预警单一市场风险</p></td>
<td class="confluenceTd"><p>计算单个市场占全协议总流动性的比例：</p>
<ul>
<li><p>公式：<code>marketConcentration = 单市场 poolUsd / 全协议总 poolUsd</code></p></li>
</ul></td>
<td class="confluenceTd"><p>单个市场集中度 &gt; 50%（风险过度集中）</p></td>
<td class="confluenceTd"><ol>
<li><p>基于全协议流动性总价值和单市场价值计算</p></li>
</ol>
<ol start="2">
<li><p>每日定时统计（间隔 1 小时）</p></li>
</ol></td>
<td class="confluenceTd"><p>集中度过高时，需重点监控该市场的资产变动和价格波动</p></td>
</tr>
</tbody>
</table>

</div>

### 三、交易与订单执行监控（业务层）

#### 1. 订单全生命周期监控

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="14cc2115-1715-4ce9-88a6-93a15c217c16">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>订单创建成功率</p></td>
<td class="confluenceTd"><p>确保用户能正常发起订单</p></td>
<td class="confluenceTd"><p>统计 <code>ExchangeRouter.createOrder</code> 调用的成功 / 失败比例：</p>
<ul>
<li><p>成功：交易 status=1</p></li>
</ul>
<ul>
<li><p>失败：交易 status=0（revert）或超时未上链</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>5 分钟内创建成功率 &lt; 90%</p></li>
</ol>
<ol start="2">
<li><p>连续 10 笔创建交易失败</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>监听 <code>OrderCreated</code> 事件（成功创建）</p></li>
</ol>
<ol start="2">
<li><p>跟踪 <code>createOrder</code> 交易哈希的执行状态</p></li>
</ol>
<ol start="3">
<li><p>按订单类型（市价 / 限价 / 止盈止损）细分统计</p></li>
</ol></td>
<td class="confluenceTd"><p>失败原因需解析交易 revert 信息（如 <code>insufficient collateral</code>），辅助排查</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>订单执行成功率</p></td>
<td class="confluenceTd"><p>确保 keeper 能正常处理订单</p></td>
<td class="confluenceTd"><p>统计 <code>OrderHandler.executeOrder</code> 调用的成功 / 失败比例：</p>
<ul>
<li><p>成功：触发 <code>OrderExecuted</code> 事件</p></li>
</ul>
<ul>
<li><p>失败：触发 <code>OrderCancelled</code> 事件或 revert</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>5 分钟内执行成功率 &lt; 80%</p></li>
</ol>
<ol start="2">
<li><p>单类型订单（如限价单）连续失败 &gt; 10 次</p></li>
</ol>
<ol start="3">
<li><p>订单创建后 1 小时未执行且未取消</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>监听 <code>OrderExecuted</code>/<code>OrderCancelled</code> 事件</p></li>
</ol>
<ol start="2">
<li><p>按订单 ID 跟踪生命周期（创建→执行 / 取消）</p></li>
</ol>
<ol start="3">
<li><p>实时监控 + 10 分钟粒度汇总</p></li>
</ol></td>
<td class="confluenceTd"><p>执行失败可能原因：keeper 离线、价格不满足、Gas 不足</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>订单执行延迟</p></td>
<td class="confluenceTd"><p>评估 keeper 响应效率</p></td>
<td class="confluenceTd"><p>计算订单从创建到执行的时间差：</p>
<ul>
<li><p>公式：<code>executionDelay = 执行区块时间 - 创建区块时间</code></p></li>
</ul>
<ul>
<li><p>按订单类型（市价 / 限价 / 止盈止损）细分</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>市价单平均执行延迟 &gt; 5 分钟（keeper 响应缓慢）</p></li>
</ol>
<ol start="2">
<li><p>限价单平均执行延迟 &gt; 1 小时（价格未触发或 keeper 未处理）</p></li>
</ol>
<ol start="3">
<li><p>单个订单执行延迟 &gt; 24 小时（订单失效风险）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>解析 <code>OrderCreated</code> 事件的 <code>blockTimestamp</code>（创建时间）</p></li>
</ol>
<ol start="2">
<li><p>解析 <code>OrderExecuted</code> 事件的 <code>blockTimestamp</code>（执行时间）</p></li>
</ol>
<ol start="3">
<li><p>实时计算延迟并统计平均值</p></li>
</ol></td>
<td class="confluenceTd"><p>限价单延迟需结合价格触发条件，若价格未达阈值，延迟属正常情况</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>订单取消率</p></td>
<td class="confluenceTd"><p>预警异常取消行为</p></td>
<td class="confluenceTd"><p>统计订单创建后被取消的比例：</p>
<ul>
<li><p>主动取消：用户调用 <code>cancelOrder</code></p></li>
</ul>
<ul>
<li><p>被动取消：keeper 执行失败触发取消</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>5 分钟内取消率 &gt; 30%</p></li>
</ol>
<ol start="2">
<li><p>同一地址 1 小时内取消订单 &gt; 20 笔（恶意刷单）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>监听 <code>OrderCancelled</code> 事件，统计取消次数</p></li>
</ol>
<ol start="2">
<li><p>关联 <code>OrderCreated</code> 事件计算取消率</p></li>
</ol>
<ol start="3">
<li><p>按取消发起方（用户 /keeper）细分</p></li>
</ol></td>
<td class="confluenceTd"><p>被动取消率过高需排查 keeper 执行问题（如 Gas 不足、价格异常）</p></td>
</tr>
</tbody>
</table>

</div>

#### 2. 交易成本与执行质量

<div class="table-wrap">

<table class="confluenceTable" style="width:100%;" data-table-width="760" data-layout="default" data-local-id="0fb7141a-e3f5-4bac-a915-673ab50ca722">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr>
<th class="confluenceTh"><p>监控指标</p></th>
<th class="confluenceTh"><p>监控目标</p></th>
<th class="confluenceTh"><p>具体说明</p></th>
<th class="confluenceTh"><p>预警阈值 / 条件</p></th>
<th class="confluenceTh"><p>采集方式</p></th>
<th class="confluenceTh"><p>补充说明</p></th>
</tr>
&#10;<tr>
<td class="confluenceTd"><p>单笔交易 Gas 消耗</p></td>
<td class="confluenceTd"><p>评估用户交互成本</p></td>
<td class="confluenceTd"><p>统计不同操作的 Gas 消耗：</p>
<ul>
<li><p>存提：<code>createDeposit</code>/<code>executeDeposit</code></p></li>
</ul>
<ul>
<li><p>交易：<code>createOrder</code>/<code>executeOrder</code></p></li>
</ul>
<ul>
<li><p>权限：<code>grantRole</code>/<code>setData</code></p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>某操作平均 Gas 消耗较 24h 均值突增 &gt; 50%</p></li>
</ol>
<ol start="2">
<li><p>单笔交易 Gas 消耗 &gt; 链上区块 Gas 限制的 80%（可能无法上链）</p></li>
</ol></td>
<td class="confluenceTd"><ol>
<li><p>解析交易回执中的 <code>gasUsed</code> 字段</p></li>
</ol>
<ol start="2">
<li><p>按操作类型分组统计（5 分钟粒度）</p></li>
</ol>
<ol start="3">
<li><p>计算 24h 均值并设置波动阈值</p></li>
</ol></td>
<td class="confluenceTd"><p>Gas 突增可能因链上拥堵或合约逻辑变更，需结合链上 Gas 价格监控</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>执行费率准确性</p></td>
<td class="confluenceTd"><p>确保手续费按配置收取</p></td>
<td class="confluenceTd"><p>验证实际收取的手续费与配置值一致：</p>
<ul>
<li><p>现货交易费：<code>swapFeeFactor</code>（按交易金额比例）</p></li>
</ul>
<ul>
<li><p>仓位交易费：<code>positionFeeFactor</code>（按仓位变动金额比例）</p></li>
</ul>
<ul>
<li><p>公式：<code>actualFee = feeAmount / 交易金额</code></p></li>
</ul></td>
<td class="confluenceTd"><p>实际费率与配置值偏差 &gt; 5%（计算错误或配置变更未生效）</p></td>
<td class="confluenceTd"><ol>
<li><p>解析 <code>OrderExecuted</code> 事件的 <code>feeAmount</code> 字段</p></li>
</ol>
<ol start="2">
<li><p>调用 <code>DataStore.getUint256(SWAP_FEE_FACTOR)</code> 获取配置值</p></li>
</ol>
<ol start="3">
<li><p>按交易类型计算实际费率并对比</p></li>
</ol></td>
<td class="confluenceTd"><p>费率配置可能通过治理修改，需同步监控参数变更</p></td>
</tr>
<tr>
<td class="confluenceTd"><p>价格冲击异常</p></td>
<td class="confluenceTd"><p>预警潜在市场操纵</p></td>
<td class="confluenceTd"><p>监控单笔交易的价格冲击值（GMX 内置逻辑）：</p>
<ul>
<li><p>正向冲击：交易改善市场平衡（如补充流动性）</p></li>
</ul>
<ul>
<li><p>负向冲击：交易破坏市场平衡（如大额抛售）</p></li>
</ul></td>
<td class="confluenceTd"><ol>
<li><p>单笔交易负向价格冲击绝对值 &gt; 5%（远超正常范围）</p></li>
</ol>
<ol start="2">
<li><p>同一</p></li>
</ol></td>
<td class="confluenceTd"></td>
<td class="confluenceTd"></td>
</tr>
</tbody>
</table>

</div>

</div>
